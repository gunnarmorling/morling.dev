<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Smaller, Faster-starting Container Images With jlink and AppCDS - Gunnar Morling</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Smaller, Faster-starting Container Images With jlink and AppCDS" />
<meta property="og:description" content="
A few months ago I wrote about how you could speed up your Java application&#8217;s start-up times using application class data sharing (AppCDS),
based on the example of a simple Quarkus application.
Since then, quite some progress has been made in this area:
Quarkus 1.6 brought built-in support for AppCDS,
so that now you just need to provide the -Dquarkus.package.create-appcds=true option when building your project,
and you&#8217;ll find an AppCDS file in the target folder.


Things get more challenging though when combining AppCDS with custom Java runtime images,
as produced using the jlink tool added in Java 9.
Combining custom runtime images with AppCDS is very attractive,
in particular when looking at the deployment of Java applications via Linux containers.
Instead of putting the full Java runtime into the container image, you only add those JDK modules which your application actually requires.
(Parts of) what you save in image size by doing so,
can be used for adding an AppCDS archive to your container image.
The result will be a container image which still is smaller than before&#8201;&#8212;&#8201;and thus is faster to push to a container registry, distribute to worker nodes in a Kubernetes cluster, etc.&#8201;&#8212;&#8201;and which starts up significantly faster.
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.morling.dev/blog/smaller-faster-starting-container-images-with-jlink-and-appcds/" />
<meta property="article:published_time" content="2020-12-13T20:30:00+01:00" />
<meta property="article:modified_time" content="2020-12-13T20:30:00+01:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Smaller, Faster-starting Container Images With jlink and AppCDS"/>
<meta name="twitter:description" content="
A few months ago I wrote about how you could speed up your Java application&#8217;s start-up times using application class data sharing (AppCDS),
based on the example of a simple Quarkus application.
Since then, quite some progress has been made in this area:
Quarkus 1.6 brought built-in support for AppCDS,
so that now you just need to provide the -Dquarkus.package.create-appcds=true option when building your project,
and you&#8217;ll find an AppCDS file in the target folder.


Things get more challenging though when combining AppCDS with custom Java runtime images,
as produced using the jlink tool added in Java 9.
Combining custom runtime images with AppCDS is very attractive,
in particular when looking at the deployment of Java applications via Linux containers.
Instead of putting the full Java runtime into the container image, you only add those JDK modules which your application actually requires.
(Parts of) what you save in image size by doing so,
can be used for adding an AppCDS archive to your container image.
The result will be a container image which still is smaller than before&#8201;&#8212;&#8201;and thus is faster to push to a container registry, distribute to worker nodes in a Kubernetes cluster, etc.&#8201;&#8212;&#8201;and which starts up significantly faster.
"/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel="stylesheet" />
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" />
 
	<link rel="stylesheet" type="text/css" media="screen" href="https://www.morling.dev/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://www.morling.dev/css/main.css" />

	
	<link rel="stylesheet" type="text/css" href="https://www.morling.dev/css/base16.dark.css" />
	
	<link rel="stylesheet" type="text/css" href="https://www.morling.dev/css/morlingdev.css" />
	

	<script>
		const searchUrl = "https:\/\/search.gunnar-morling.workers.dev\/Prod\/";
		const apiKey = "ff90d45f4afad3bd914c";
	</script>

	<script src="https://www.morling.dev//js/main.js"></script>
	<script src="https://www.morling.dev//js/medium-zoom.min.js"></script>

	<noscript>
		<style type="text/css">
			.club { display:none; }
		</style>
	</noscript>
</head>

<body>
	<div class="container wrapper post">
		<div class="header desktop">

	<div class="row">
		<div class="header-image-container">
			<img class="header-image" src="/images/gunnar_morling.jpg" alt="Gunnar Morling">
		</div>
		<div class="fill">
			<h1 class="site-title"><a href="https://www.morling.dev/">Gunnar Morling</a></h1>
			<div class="site-description"><h2>Random Musings on All Things Software Engineering</h2></div>

			<nav class="row pre-nav">
				<div class="pull-right">
					<ul class="flat"><li>
							<a href="/blog/index.xml" title="RSS FEED">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#rss"/>
								</svg>
							</a>
						</li><li>
							<a href="https://github.com/gunnarmorling" title="GitHub">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#github"/>
								</svg>
							</a>
						</li><li>
							<a href="https://twitter.com/gunnarmorling" title="Twitter">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#twitter"/>
								</svg>
							</a>
						</li></ul>
				</div>
			</nav>
			<nav class="row nav">
				<div>
					<ul class="flat">
						
						<li>
							<a href="/">Blog</a>
						</li>
						
						<li>
							<a href="/projects/">Projects</a>
						</li>
						
						<li>
							<a href="/conferences/">Conferences</a>
						</li>
						
						<li>
							<a href="/podcasts/">Podcasts</a>
						</li>
						
						<li>
							<a href="/about/">About</a>
						</li>
						
					</ul>
				</div>
				<div class="pull-right">
					<div class="club">
						<form id="myForm">
							<input type="text" id="inputSearch" name="q" placeholder="Search..." onfocus="warmUp(this)">
							<button type="submit" id="buttonSubmitSearch" style="line-height: normal;"><i id="iconSearch" class="fa fa-search"></i></button>
						</form>
					</div>
				</div>
			</nav>
		</div>
	</div>
</div>

<div class="header mobile">

	<div class="row">
		<div class="header-image-container">
			<img class="header-image" src="/images/gunnar_morling.jpg" alt="Gunnar Morling">
		</div>
		<div class="fill">
			<h1 class="site-title"><a href="https://www.morling.dev/">Gunnar Morling</a></h1>
			<div class="site-description"><h2>Random Musings on All Things Software Engineering</h2></div>
		</div>
	</div>
	<div>
		<div>
			<nav class="row pre-nav">
				<div class="pull-right">
					<ul class="flat"><li>
							<a href="/blog/index.xml" title="RSS FEED">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#rss"/>
								</svg>
							</a>
						</li><li>
							<a href="https://github.com/gunnarmorling" title="GitHub">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#github"/>
								</svg>
							</a>
						</li><li>
							<a href="https://twitter.com/gunnarmorling" title="Twitter">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#twitter"/>
								</svg>
							</a>
						</li></ul>
				</div>
			</nav>
			<nav class="row nav">
				<div>
					<ul class="flat">
						
						<li>
							<a href="/">Blog</a>
						</li>
						
						<li>
							<a href="/projects/">Projects</a>
						</li>
						
						<li>
							<a href="/conferences/">Conferences</a>
						</li>
						
						<li>
							<a href="/podcasts/">Podcasts</a>
						</li>
						
						<li>
							<a href="/about/">About</a>
						</li>
						
					</ul>
				</div>
				<div class="pull-right">
					<div class="club">
						<form id="myFormMobile">
							<input type="text" id="inputSearchMobile" name="q" placeholder="Search..." onfocus="warmUp(this)">
							<button type="submit" id="buttonSubmitSearchMobile" style="line-height: normal;"><i id="iconSearchMobile" class="fa fa-search"></i></button>
						</form>
					</div>
				</div>
			</nav>
		</div>
	</div>
</div>

<script type="text/javascript">
	window.addEventListener( "load", function () {
		const urlParams = new URLSearchParams(window.location.search);

		


		const form = document.getElementById( "myForm" );

		form.addEventListener("submit", function (event) {
			event.preventDefault();
			sendData(new FormData(form));
		});

		const formMobile = document.getElementById( "myFormMobile" );

		formMobile.addEventListener("submit", function (event) {
			event.preventDefault();
			sendData(new FormData(formMobile));
		});
	});
</script>


		<div id = "main-content">
			<div class="post-header">
				<h1 class="title">Smaller, Faster-starting Container Images With jlink and AppCDS</h1>
				<div class="meta">Posted at Dec 13, 2020</div>
			</div>

			<div class="markdown">
				<div class="paragraph">
<p>A few months ago I <a href="/blog/building-class-data-sharing-archives-with-apache-maven/">wrote about</a> how you could speed up your Java application&#8217;s start-up times using application class data sharing (<a href="http://openjdk.java.net/jeps/350">AppCDS</a>),
based on the example of a simple <a href="https://quarkus.io/">Quarkus</a> application.
Since then, quite some progress has been made in this area:
Quarkus 1.6 brought <a href="https://quarkus.io/guides/maven-tooling#quarkus-package-pkg-package-config_quarkus.package.create-appcds">built-in support for AppCDS</a>,
so that now you just need to provide the <em>-Dquarkus.package.create-appcds=true</em> option when building your project,
and you&#8217;ll find an AppCDS file in the <em>target</em> folder.</p>
</div>
<div class="paragraph">
<p>Things get more challenging though when combining AppCDS with custom Java runtime images,
as produced using the <a href="https://docs.oracle.com/en/java/javase/15/docs/specs/man/jlink.html">jlink</a> tool added in Java 9.
Combining custom runtime images with AppCDS is very attractive,
in particular when looking at the deployment of Java applications via Linux containers.
Instead of putting the full Java runtime into the container image, you only add those JDK modules which your application actually requires.
(Parts of) what you save in image size by doing so,
can be used for adding an AppCDS archive to your container image.
The result will be a container image which still is smaller than before&#8201;&#8212;&#8201;and thus is faster to push to a container registry, distribute to worker nodes in a Kubernetes cluster, etc.&#8201;&#8212;&#8201;and which starts up significantly faster.</p>
</div>
<div class="paragraph">
<p>A challenge though is that AppCDS archives must be created with exactly same Java runtime which later on is used to run the application.
In the case of jlink this means the custom runtime image itself must be used to produce the AppCDS archive.
In other words, the default archive produced by the Quarkus build unfortunately cannot be used with jlink images.
The goal for this post is to explore</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the steps required to create a custom runtime image for a simple  <a href="https://github.com/gunnarmorling/quarkus-cds">Java CRUD application</a> based on Quarkus,</p>
</li>
<li>
<p>how to build a Linux container image with this custom runtime image and the application itself,</p>
</li>
<li>
<p>how this approach compares to container images with the full Java runtime in terms of size and start-up time.</p>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="_creating_a_modular_runtime_image_for_a_quarkus_application">Creating a Modular Runtime Image for a Quarkus Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It&#8217;s a common misbelief that only Java applications which have been fully ported to the Java module system (JPMS) would be able to benefit from jlink.
But as explained by Simon Ritter in this <a href="https://medium.com/azulsystems/using-jlink-to-build-java-runtimes-for-non-modular-applications-9568c5e70ef4">blog post</a>, this is not true actually; you don&#8217;t need to fully modularize an application in order to run it via a custom runtime image.</p>
</div>
<div class="paragraph">
<p>While indeed the creation of a runtime image is a bit easier when it only is comprised of proper Java modules,
it also is possible to create a runtime image by explicitly stating which JDK (or other) modules it should contain.
The application can then be run via the traditional classpath, just as you&#8217;d do it with a full Java runtime.
Which JDK modules to add though?
To answer this question, the <a href="https://docs.oracle.com/en/java/javase/15/docs/specs/man/jdeps.html">jdeps</a> tool comes in handy.
Via its <em>--print-module-deps</em> option it can determine for a given set of JARs which (JDK) modules they depend on,
and which thus are the ones that need to go into the custom runtime image.</p>
</div>
<div class="paragraph">
<p>Having built the example application from the previous blog post via <em>mvn clean verify</em>,
let&#8217;s try and invoke jdeps like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">jdeps <span class="nt">--print-module-deps</span> <span class="se">\</span>
    <span class="nt">--class-path</span> target/lib/<span class="k">*</span> <span class="se">\</span>
    target/todo-manager-1.0.0-SNAPSHOT-runner.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in an error though:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">Error: com.sun.istack.istack-commons-runtime-3.0.10.jar is a multi-release jar file but <span class="nt">--multi-release</span> option is not <span class="nb">set</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ok, we need to tell which code version to analyse for <a href="https://openjdk.java.net/jeps/238">multi-release JARs</a>;
no problem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">jdeps <span class="nt">--print-module-deps</span> <span class="se">\</span>
    <span class="nt">--multi-release</span> 15 <span class="se">\</span>
    <span class="nt">--class-path</span> target/lib/<span class="k">*</span> <span class="se">\</span>
    target/todo-manager-1.0.0-SNAPSHOT-runner.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hum, some progress, but still an issue:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">Exception <span class="k">in </span>thread <span class="s2">"main"</span> java.lang.module.FindException: Module java.xml.bind not found, required by java.ws.rs</code></pre>
</div>
</div>
<div class="paragraph">
<p>This one is a bit odd;
the file <em>org.jboss.spec.javax.ws.rs.jboss-jaxrs-api_2.1_spec-2.0.1.Final.jar</em> is an explicit module with a module-info.class descriptor,
which references the module <code>java.xml.bind</code>,
and this one is not found on the module path.
It&#8217;s not quite clear to me why this is flagged here, given that the JAX-RS API JAR is part of the class path and not the module path.
But it&#8217;s not a big problem, we simply can add the JAXB API (which also is provided on the class path) on the module path, too.</p>
</div>
<div class="paragraph">
<p>The same issue arises for some other dependencies which are explicit modules already,
so we end up with the following configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">jdeps <span class="nt">--print-module-deps</span> <span class="se">\</span>
    <span class="nt">--multi-release</span> 15 <span class="se">\</span>
    <span class="nt">--module-path</span> target/lib/jakarta.activation.jakarta.activation-api-1.2.1.jar:target/lib/org.reactivestreams.reactive-streams-1.0.3.jar:target/lib/org.jboss.spec.javax.xml.bind.jboss-jaxb-api_2.3_spec-2.0.0.Final.jar <span class="se">\</span>
    <span class="nt">--class-path</span> target/lib/<span class="k">*</span> <span class="se">\</span>
    target/todo-manager-1.0.0-SNAPSHOT-runner.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>And another issue, now about some missing dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">...
org.postgresql.util.internal.Nullness              -&gt; org.checkerframework.dataflow.qual.Pure            not found
org.wildfly.common.wildfly-common-1.5.4.Final-format-001.jar
   org.wildfly.common.Substitutions<span class="nv">$Target_Branch</span>     -&gt; com.oracle.svm.core.annotate.AlwaysInline          not found
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>After taking a closer look, these are either compile-time only dependencies (like annotations from the <a href="https://checkerframework.org/">Checker framework</a>),
or dependencies of optional features which are not relevant for our case.
These can be safely ignored using the <em>--ignore-missing-deps</em> switch,
which leaves us with this jdeps invocation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">jdeps <span class="nt">--print-module-deps</span> <span class="se">\</span>
    <span class="nt">--ignore-missing-deps</span> <span class="se">\</span>
    <span class="nt">--multi-release</span> 15 <span class="se">\</span>
    <span class="nt">--module-path</span> target/lib/jakarta.activation.jakarta.activation-api-1.2.1.jar:target/lib/org.reactivestreams.reactive-streams-1.0.3.jar:target/lib/org.jboss.spec.javax.xml.bind.jboss-jaxb-api_2.3_spec-2.0.0.Final.jar <span class="se">\</span>
    <span class="nt">--class-path</span> target/lib/<span class="k">*</span> <span class="se">\</span>
    target/todo-manager-1.0.0-SNAPSHOT-runner.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>The required JDK modules are printed out finally:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">java.base,java.compiler,java.instrument,java.naming,java.rmi,java.security.jgss,java.security.sasl,java.sql,jdk.jconsole,jdk.unsupported</code></pre>
</div>
</div>
<div class="paragraph">
<p>I.e. out of the nearly 60 modules which make up OpenJDK 15,
only ten are required by this particular application.
Building a custom runtime image containing only these modules should result in quite some space saving.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Why is a Particular Module Required?</div>
<div class="paragraph">
<p>When looking at the module list, you might wonder why certain modules actually are needed.
What is this application doing with <code>jdk.jconsole</code> for instance?
To gain insight into this, jdeps can help, too.
Run it again without the <em>--print-module-deps</em> switch, and you can grep for interesting module references:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">jdeps &lt;...&gt; | <span class="nb">grep </span>jconsole

org.jboss.narayana.jta.narayana-jta-5.10.6.Final.jar -&gt; jdk.jconsole
  com.arjuna.ats.arjuna.tools.stats -&gt;
    com.sun.tools.jconsole jdk.jconsole</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, there&#8217;s a single dependency to jconsole, from the Narayana transaction manager.
Depending on the details, it might be an opportunity to reach out to the maintainers of such library and discuss,
whether this dependency really is needed or whether it could be avoided (e.g. by moving the code in question to a separate module),
resulting in a further decreased size of custom runtime images.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With the list of required modules,
creating the actual runtime image is rather simple:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$JAVA_HOME</span>/bin/jlink <span class="se">\</span>
  <span class="nt">--add-modules</span> java.base,java.compiler,java.instrument,java.naming,java.rmi,java.security.jgss,java.security.sasl,java.sql,jdk.jconsole,jdk.unsupported <span class="se">\</span>
  <span class="nt">--compress</span> 2 <span class="nt">--no-header-files</span> <span class="nt">--no-man-pages</span> <span class="se">\</span><i class="conum" data-value="1"></i><b>(1)</b>
  <span class="nt">--output</span> target/runtime-image <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Compressing the runtime image as well as omitting header files and man pages helps to further reduce the size of the runtime image</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Output location for creating the runtime image</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In order to create a dynamic AppCDS archive for our application classes later on,
we now need to add the class data archive for all of the classes of the image itself.
Failing to do so results in this error message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">Error occurred during initialization of VM
DynamicDumpSharedSpaces is unsupported when base CDS archive is not loaded</code></pre>
</div>
</div>
<div class="paragraph">
<p>This step isn&#8217;t very well documented, and at this point I was somewhat stuck.
But you always can count on the OpenJDK community: after asking about this on Twitter,
Claes Redestad <a href="https://twitter.com/cl4es/status/1337797258058862597">pointed me</a>  into the right direction:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">./target/runtime-image/bin/java <span class="nt">-Xshare</span>:dump</code></pre>
</div>
</div>
<div class="paragraph">
<p>Thanks, Claes! This creates the base class data archive under <em>target/runtime-image/lib/server/classes.jsa</em>,
adding ~12 MB to the runtime image, which now has a size of ~63 MB;
not too bad.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adding_an_appcds_archive_to_a_custom_runtime_image">Adding an AppCDS Archive to a Custom Runtime Image</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Having created the custom Java runtime image,
let&#8217;s now add the AppCDS archive to it.
Since the introduction of dynamic AppCDS archives in JDK 13,
this is one simple step which only requires to run the application with the <em>-XX:ArchiveClassesAtExit</em> option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nb">cd </span>target <i class="conum" data-value="1"></i><b>(1)</b>

<span class="nb">mkdir </span>runtime-image/cds <i class="conum" data-value="2"></i><b>(2)</b>

<i class="conum" data-value="3"></i><b>(3)</b>
runtime-image/bin/java <span class="se">\</span>
  <span class="nt">-XX</span>:ArchiveClassesAtExit<span class="o">=</span>runtime-image/cds/app-cds.jsa <span class="se">\</span>
  <span class="nt">-jar</span> todo-manager-1.0.0-SNAPSHOT-runner.jar

<span class="nb">cd</span> ..</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class path used when running the application later on must be the same as (or rather a prefix of, to be precise) the class path used for building the AppCDS archive; hence changing to the <em>target</em> directory,
so to run with <em>-jar *-runner.jar</em>, instead of with <em>-jar target/*-runner.jar</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Creating a folder for storing the AppCDS archive</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Using the <em>java</em> binary of the runtime image to launch the application and create the AppCDS archive when exiting</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This will create the CDS archive under <em>target/runtime-image/cds/app-cds.jsa</em>.
In the next step this can be added to a Linux container image,
built e.g. using Docker or <a href="https://podman.io/">podman</a>.
Note that while jlink supports cross-platform builds
(so for instance you could build a custom runtime image for a Linux container on macOS),
the same isn&#8217;t the case for AppCDS.
This means an AppCDS archive to be used by a containerized application needs to be built on Linux.
When not running on Linux yourself, but on Windows or macOS,
you could put the entire build process into a container for this purpose.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_a_linux_container_image">Creating a Linux Container Image</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At this point we have built our actual application,
a custom Java runtime image with the required JDK modules,
and an AppCDS archive for the application&#8217;s classes.
The final step is to put everything into a Linux container image,
which is quickly done via a small Dockerfile:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="Dockerfile">FROM registry.fedoraproject.org/fedora-minimal:33

COPY target/runtime-image /opt/todo-manager/jdk
COPY target/lib/* /opt/todo-manager/lib/
COPY target/todo-manager-1.0.0-SNAPSHOT-runner.jar /opt/todo-manager
COPY todo-manager.sh /opt/todo-manager

ENTRYPOINT [ "/opt/todo-manager/todo-manager.sh" ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>This uses the <a href="https://registry.fedoraproject.org/repo/fedora-minimal/tags/">Fedora minimal base image</a>,
which is a great foundation for container images.
With a size of ~120 MB, it&#8217;s small enough to be distributed efficiently,
while still providing the flexibility of a complete Linux distribution,
e.g. allowing for the installation of additional tools if needed.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Even Smaller Container Images</div>
<div class="paragraph">
<p>If you wanted to shrink the image size further and felt adventureous, you could look into using <a href="https://alpinelinux.org/">Alpine Linux</a> as a base image;
the issue there though is that Alpine comes with musl instead of glibc
(as used by the JDK)
as its implementation of the ISO C and POSIX standard APIs.
The OpenJDK <a href="https://openjdk.java.net/projects/portola/">Portola</a> project aims at providing a port to Alpine and musl.
But as of JDK 15, no GA build of this port exists yet.
For JDK 16, an <a href="https://jdk.java.net/16/">early access build</a> of the Alpine/musl port is available.</p>
</div>
<div class="paragraph">
<p>Another option for smaller images is to use <a href="https://github.com/GoogleContainerTools/jib">jib</a>,
which also is supported by Quarkus <a href="https://quarkus.io/guides/container-image#jib">out of the box</a>.
I haven&#8217;t tried out yet though whether/how jib would work with custom runtime images and AppCDS.</p>
</div>
<div class="paragraph">
<p>It&#8217;s also worth pointing out that the size of base images doesn&#8217;t matter too much in practice,
as container images use a layered file system,
which means that typically rather stable base image layers don&#8217;t need to be redistributed too often when pushing or pulling a container image.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The container&#8217;s entry point, <em>todo-manager.sh</em>, is a basic shell script,
which starts the actual Java application via the Java runtime image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="c">#!/bin/bash</span>

<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">"/opt/todo-manager/jdk/bin:</span><span class="k">${</span><span class="nv">PATH</span><span class="k">}</span><span class="s2">"</span>

<span class="nb">cd</span> /opt/todo-manager <span class="o">&amp;&amp;</span> <span class="se">\ </span><i class="conum" data-value="1"></i><b>(1)</b>
  <span class="nb">exec </span>java <span class="nt">-Xshare</span>:on <span class="nt">-XX</span>:SharedArchiveFile<span class="o">=</span>jdk/cds/app-cds.jsa <span class="nt">-jar</span> <span class="se">\ </span><i class="conum" data-value="2"></i><b>(2)</b>
  todo-manager-1.0.0-SNAPSHOT-runner.jar</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Changing into the <em>todo-manager</em> directory, so to make sure the same JAR path is passed as when creating the CDS archive</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Specifying the archive name; the <em>-Xshare:on</em> isn&#8217;t strictly needed, it&#8217;s used here though to ensure the process will fail if something is wrong with the CDS archive, instead of silently not using it</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_lets_see_some_numbers">Let&#8217;s See Some Numbers!</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Finally, let&#8217;s compare some numbers: container image size, and start-up time for different ways of containerizing the todo manager application.
I&#8217;ve tried out four different aproaches:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>OpenJDK 11 on the <a href="https://developers.redhat.com/products/rhel/ubi">RHEL UBI 8.3 image</a> (universal base image), as per the default Dockerfile created for new Quarkus applications</p>
</li>
<li>
<p>A full OpenJDK 15 on Fedora 33 (as there&#8217;s no OpenJDK 15 package for the RHEL base image yet)</p>
</li>
<li>
<p>A custom runtime image for OpenJDK 15 on Fedora 33</p>
</li>
<li>
<p>A custome runtime image with AppCDS on Fedora 33</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here are the results, running on a <a href="https://www.hetzner.com/cloud">Hetzner Cloud</a> CX4 instance (4 vCPUs, 16 GB RAM),
using Fedora 33 as the host OS:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/jlink_app_cds_image_size_and_startup_times.png" alt="Container Image Sizes and Startup Times">
</div>
</div>
<div class="paragraph">
<p>As we can see, the container image size is significantly lower when adding a custom Java runtime image instead of the full JDK.
In particular when comparing to the OpenJDK package of Fedora 33 which is a fair bit larger than the OpenJDK 11 package of the RHEL UBI 8.3 image, the difference is striking.</p>
</div>
<div class="paragraph">
<p>The start-up times are as displayed by Quarkus, averaged over five runs.
Numbers have improved by about 10% by going from OpenJDK 11 to 15,
which is explained by multiple improvements in this area, most notably the introduction of default CDS archives for the JDK&#8217;s own classes in JDK 12 (<a href="http://openjdk.java.net/jeps/341">JEP 341</a>).
Using a custom runtime image by itself doesn&#8217;t have any measurable impact on start-up time.
The AppCDS archive improves the start-up time by a whopping 54%.
Unless pure image size is the key factor for you
(in which case you should look for alternative approaches anyways, see note "Even Smaller Container Images" above),
I would say that the additional 40 MB for the AppCDS archive are more than worth it.
In particular as the resulting container image still is way smaller than when adding the full JDK,
be it with the Fedora base image or the RHEL UBI one.</p>
</div>
<div class="paragraph">
<p>Based on those numbers,
I think it&#8217;s fair to say that custom Java runtime images created via jlink,
combined with AppCDS archives are a great foundation for containerized Java applications.
Adding a custom runtime image containing only those JDK modules actually needed by an application help to cut down image size signficantly.
Parts of that saved space can be invested into adding an AppCDS archive,
so you end up with a container image that&#8217;s smaller <em>and</em> starts up faster.
I.e. you can have this cake, and eat it, too!</p>
</div>
<div class="paragraph">
<p>The one downside is the increased complexity of the build process for producing the runtime image as well as the AppCDS archive.
This should be manageable though by means of scripting and automation;
also I&#8217;d expect tooling like the Quarkus Maven plug-in and others to further improve on this front.
One tricky aspect is that you must not forget to rebuild the custom runtime image,
in case you have added dependencies to your application which affect the set of required JDK modules.
Automated tests of the application running via the runtime image should help to identify this situation.</p>
</div>
<div class="paragraph">
<p>If you&#8217;d like to give it a try yourself, or obtain numbers for the different deployment approaches on your own hardware,
you can find all the required code and information in this <a href="https://github.com/gunnarmorling/quarkus-cds">GitHub repository</a>.</p>
</div>
</div>
</div>
			</div>

			<div class="post-tags">
				
					
				
			</div>
		</div><div id="disqus_thread">
  <script src="https://giscus.app/client.js"
    data-repo="gunnarmorling/discussions.morling.dev"
    data-repo-id="R_kgDOGXzqNQ"
    data-category="Announcements"
    data-category-id="DIC_kwDOGXzqNc4B_2Pq"
    data-mapping="title"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-theme="light"
    data-lang="en"
    crossorigin="anonymous"
    async>
  </script>
</div>

<noscript>Please enable JavaScript, or join the <a href="https://github.com/gunnarmorling/discussions.morling.dev/discussions/">discussion on GitHub</a>.</noscript>
</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> Â© 2019 - 2022 Gunnar Morling |  Licensed Under <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons BY-SA 4.0</a></div>
	</nav>
</div>


<script type="application/javascript">
var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
var doNotTrack = (dnt == "1" || dnt == "yes");
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	if (window.sessionStorage) {
		var GA_SESSION_STORAGE_KEY = 'ga:clientId';
		ga('create', 'UA-156032495-1', {
	    'storage': 'none',
	    'clientId': sessionStorage.getItem(GA_SESSION_STORAGE_KEY)
	   });
	   ga(function(tracker) {
	    sessionStorage.setItem(GA_SESSION_STORAGE_KEY, tracker.get('clientId'));
	   });
   }
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<script>
	mediumZoom(document.querySelectorAll('div.imageblock > div.content > img'))
</script>

</body>
</html>
