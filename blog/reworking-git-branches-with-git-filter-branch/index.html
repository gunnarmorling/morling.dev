<!DOCTYPE html>
<html>
<head>
	
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-DD997656SV"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'G-DD997656SV');
	</script>

	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Reworking Git Branches with git filter-branch - Gunnar Morling</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Reworking Git Branches with git filter-branch" />
<meta property="og:description" content="
Within Debezium, the project I&#8217;m working on at Red Hat, we recently encountered an &#34;interesting&#34; situation where we had to resolve a rather difficult merge conflict.
As others where interested in how we addressed the issue, and also for our own future reference,
I&#8217;m going to give a quick run down of the problem we encountered and how we solved it.
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.morling.dev/blog/reworking-git-branches-with-git-filter-branch/" />
<meta property="article:published_time" content="2020-03-16T00:00:10+01:00" />
<meta property="article:modified_time" content="2020-03-16T00:00:10+01:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Reworking Git Branches with git filter-branch"/>
<meta name="twitter:description" content="
Within Debezium, the project I&#8217;m working on at Red Hat, we recently encountered an &#34;interesting&#34; situation where we had to resolve a rather difficult merge conflict.
As others where interested in how we addressed the issue, and also for our own future reference,
I&#8217;m going to give a quick run down of the problem we encountered and how we solved it.
"/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel="stylesheet" />
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" />
 
	<link rel="stylesheet" type="text/css" media="screen" href="https://www.morling.dev/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://www.morling.dev/css/main.css" />

	
	<link rel="stylesheet" type="text/css" href="https://www.morling.dev/css/base16.dark.css" />
	
	<link rel="stylesheet" type="text/css" href="https://www.morling.dev/css/morlingdev.css" />
	

	<script>
		const searchUrl = "https:\/\/search-morling-dev.onrender.com\/";
		const apiKey = "ff90d45f4afad3bd914c";
	</script>

	<script src="https://www.morling.dev//js/main.js"></script>
	<script src="https://www.morling.dev//js/medium-zoom.min.js"></script>

	<noscript>
		<style type="text/css">
			.club { display:none; }
		</style>
	</noscript>
</head>

<body>
	<div class="container wrapper post">
		<div class="header desktop">

	<div class="row">
		<div class="header-image-container">
			<img class="header-image" src="/images/gunnar_morling.jpg" alt="Gunnar Morling">
		</div>
		<div class="fill">
			<h1 class="site-title"><a href="https://www.morling.dev/">Gunnar Morling</a></h1>
			<div class="site-description"><h2>Random Musings on All Things Software Engineering</h2></div>

			<nav class="row pre-nav">
				<div class="pull-right">
					<ul class="flat"><li>
							<a href="/blog/index.xml" title="RSS FEED">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#rss"/>
								</svg>
							</a>
						</li><li>
							<a href="https://github.com/gunnarmorling" title="GitHub">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#github"/>
								</svg>
							</a>
						</li><li>
							<a href="https://twitter.com/gunnarmorling" title="Twitter">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#twitter"/>
								</svg>
							</a>
						</li><li>
							<a href="https://www.linkedin.com/in/gunnar-morling-2b44b7229/" title="LinkedIn">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#linkedin"/>
								</svg>
							</a>
						</li><li>
							<a href="https://mastodon.online/@gunnarmorling" title="Mastodon">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#message-square"/>
								</svg>
							</a>
						</li></ul>
				</div>
			</nav>
			<nav class="row nav">
				<div>
					<ul class="flat">
						
						<li>
							<a href="/">Blog</a>
						</li>
						
						<li>
							<a href="/projects/">Projects</a>
						</li>
						
						<li>
							<a href="/conferences/">Conferences</a>
						</li>
						
						<li>
							<a href="/podcasts/">Podcasts</a>
						</li>
						
						<li>
							<a href="/about/">About</a>
						</li>
						
					</ul>
				</div>
				<div class="pull-right">
					<div class="club">
						<form id="myForm">
							<input type="text" id="inputSearch" name="q" placeholder="Search..." onfocus="warmUp(this)">
							<button type="submit" id="buttonSubmitSearch" style="line-height: normal;"><i id="iconSearch" class="fa fa-search"></i></button>
						</form>
					</div>
				</div>
			</nav>
		</div>
	</div>
</div>

<div class="header mobile">

	<div class="row">
		<div class="header-image-container">
			<img class="header-image" src="/images/gunnar_morling.jpg" alt="Gunnar Morling">
		</div>
		<div class="fill">
			<h1 class="site-title"><a href="https://www.morling.dev/">Gunnar Morling</a></h1>
			<div class="site-description"><h2>Random Musings on All Things Software Engineering</h2></div>
		</div>
	</div>
	<div>
		<div>
			<nav class="row pre-nav">
				<div class="pull-right">
					<ul class="flat"><li>
							<a href="/blog/index.xml" title="RSS FEED">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#rss"/>
								</svg>
							</a>
						</li><li>
							<a href="https://github.com/gunnarmorling" title="GitHub">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#github"/>
								</svg>
							</a>
						</li><li>
							<a href="https://twitter.com/gunnarmorling" title="Twitter">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#twitter"/>
								</svg>
							</a>
						</li><li>
							<a href="https://www.linkedin.com/in/gunnar-morling-2b44b7229/" title="LinkedIn">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#linkedin"/>
								</svg>
							</a>
						</li><li>
							<a href="https://mastodon.online/@gunnarmorling" title="Mastodon">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#message-square"/>
								</svg>
							</a>
						</li></ul>
				</div>
			</nav>
			<nav class="row nav">
				<div>
					<ul class="flat">
						
						<li>
							<a href="/">Blog</a>
						</li>
						
						<li>
							<a href="/projects/">Projects</a>
						</li>
						
						<li>
							<a href="/conferences/">Conferences</a>
						</li>
						
						<li>
							<a href="/podcasts/">Podcasts</a>
						</li>
						
						<li>
							<a href="/about/">About</a>
						</li>
						
					</ul>
				</div>
				<div class="pull-right">
					<div class="club">
						<form id="myFormMobile">
							<input type="text" id="inputSearchMobile" name="q" placeholder="Search..." onfocus="warmUp(this)">
							<button type="submit" id="buttonSubmitSearchMobile" style="line-height: normal;"><i id="iconSearchMobile" class="fa fa-search"></i></button>
						</form>
					</div>
				</div>
			</nav>
		</div>
	</div>
</div>

<script type="text/javascript">
	window.addEventListener( "load", function () {
		const urlParams = new URLSearchParams(window.location.search);

		


		const form = document.getElementById( "myForm" );

		form.addEventListener("submit", function (event) {
			event.preventDefault();
			sendData(new FormData(form));
		});

		const formMobile = document.getElementById( "myFormMobile" );

		formMobile.addEventListener("submit", function (event) {
			event.preventDefault();
			sendData(new FormData(formMobile));
		});
	});
</script>


		<div id = "main-content">
			<div class="post-header">
				<h1 class="title">Reworking Git Branches with git filter-branch</h1>
				<div class="meta">Posted at Mar 16, 2020</div>
			</div>

			<div class="markdown">
				<div class="paragraph">
<p>Within <a href="https://debezium.io/">Debezium</a>, the project I&#8217;m working on at Red Hat, we recently encountered an "interesting" situation where we had to resolve a rather difficult merge conflict.
As others where interested in how we addressed the issue, and also for our own future reference,
I&#8217;m going to give a quick run down of the problem we encountered and how we solved it.</p>
</div>
<div class="sect1">
<h2 id="_the_problem">The Problem</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ideally, we&#8217;d only ever work on a single branch and would never have to deal with porting changes between the <em>master</em> and other branches.
Oftentimes we cannot get around this, though: specific versions of a software may have to be maintained for some time,
requiring to backport bugfixes from the current development branch to the branch corresponding to the maintained version.</p>
</div>
<div class="paragraph">
<p>In our specific case we had to deal with backporting changes to our <a href="https://debezium.io/documentation/">project documentation</a>.
To complicate things, this documentation (written in AsciiDoc) has been largely re-organized between <em>master</em> and the targeted older branch, <em>1.0</em>.
What used to be one large AsciiDoc file for each of the Debezium connectors,
got split up into multiple smaller files on <em>master</em> now.
This split was meant to be applied to <em>1.0</em> too, but due to some miscommunication in the team (these things happen, right) this wasn&#8217;t done, whereas an asorted set of documentation changes had been backported already to the larger, monolithic AsciiDoc files.</p>
</div>
<div class="paragraph">
<p>So the situation we faced was this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>large, monolithic AsciiDoc files on the <em>1.0</em> branch</p>
</li>
<li>
<p>smaller, modularized AsciiDoc files on <em>master</em></p>
</li>
<li>
<p>Documentation updates applied on <em>master</em>, of which only a subset is relevant for <em>1.0</em> (new features shouldn&#8217;t be added to the Debezium 1.0 documentation)</p>
</li>
<li>
<p>Some of the documentation updates relevant for the <em>1.0</em> branch already had been backported from <em>master</em>, while others had not</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All in all, a rather convoluted situation;
the full diff of the <em>documentation</em> sub-directory between the two branches was about 13K lines.</p>
</div>
<div class="paragraph">
<p>So what should we do?
Cherry-picking individual commits from master was not really an option,
as there were a few hundred commits on <em>master</em> since <em>1.0</em> had been forked off.
Also many commits would contain documentation and code changes.
The latter had already been backported successfully before.</p>
</div>
<div class="paragraph">
<p>Realizing that resolving that merge conflict was next to impossible,
the next idea was to essentially start from scratch and re-apply all relevant documentation changes to the <em>1.0</em> branch.
Our initial idea was to create a patch with the difference of the <em>documentation</em> directory between the two branches.
But editing that patch file with 13K lines turned out to be not manageable, either.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_solution">The Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is when we were reminded of the possibilities of <a href="https://git-scm.com/docs/git-filter-branch">git filter-branch</a>:
using this command it should be possible to isolate all the documentation changes done on <em>master</em> since Debezium 1.0 and apply the required sub-set of these changes to the <em>1.0</em> branch.</p>
</div>
<div class="paragraph">
<p>To start with a clean slate, we created a new temporary branch based on <em>1.0</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">git checkout <span class="nt">-b</span> docs_backport 1.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>We then reset the contents of the <em>documentation</em> directory to its state as of the 1.0.0.Final release,
as that&#8217;s where the <em>1.0</em> and <em>master</em> branches diverged.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nb">rm</span> <span class="nt">-rf</span> documentation
git add documentation
git checkout v1.0.0.Final documentation
git commit <span class="nt">-m</span> <span class="s2">"Resetting documentation dir to v1.0.0.Final"</span>

<span class="c"># This should yield no differences</span>
git diff v1.0.0.Final..docs_backport documentation</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next step was to filter all commits on <em>master</em> so to only keep any changes to the <em>documentation</em> directory.
This was done on a new branch, <em>docs_filtered</em>.
The <code>--subdirectory-filter</code> option comes in handy for that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">git checkout <span class="nt">-b</span> docs_filtered master

git filter-branch <span class="nt">-f</span> <span class="nt">--prune-empty</span> <span class="se">\</span>
    <span class="nt">--subdirectory-filter</span> documentation <span class="se">\</span>
    v1.0.0.Final..docs_filtered</code></pre>
</div>
</div>
<div class="paragraph">
<p>This leaves us with a branch <em>docs_filtered</em> which only contains the commits since the <code>v1.0.0.Final</code> tag that modified the <em>documentation</em> directory.</p>
</div>
<div class="paragraph">
<p>The <code>--subdirectory-filter</code> option also moves the contents of the given directory to the root of the repo, though.
That&#8217;s not exactly what we need.
But another option, <code>--tree-filter</code>, lets us restore the original directory layout.
It allows to run a set of commands against each of the filtered commits.
We can use this to move the contents of <em>documentation</em> back to that directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">git filter-branch <span class="nt">-f</span> <span class="se">\</span>
    <span class="nt">--tree-filter</span> <span class="s1">'mkdir -p documentation; \
      mv antora.yml documentation 1&gt;/dev/null 2&gt;/dev/null; \
      mv modules documentation 1&gt;/dev/null 2&gt;/dev/null;'</span> <span class="se">\</span>
    v1.0.0.Final..docs_filtered</code></pre>
</div>
</div>
<div class="paragraph">
<p>Examining the history now, we can see that the commits on the <em>docs_filtered</em> apply the changes to the <em>documentation</em> directory, as expected.</p>
</div>
<div class="paragraph">
<p>One problem still remains, though:
by means of the <code>--subdirectory-filter</code> option,
the very first commit removes all contents besides the <em>documentation</em> directory.
This can be fixed by doing an interactive rebase of the current branch,
beginning at the <em>v1.0.0.Final</em> tag:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">git rebase <span class="nt">-i</span> v1.0.0.Final</code></pre>
</div>
</div>
<div class="paragraph">
<p>We need to edit the very first commit;
all changes besides those to the <em>documentation</em> directory need to be reverted from that commit.
There might be a better way of doing so,
I simply ran <code>git checkout</code> for all the other resources:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">git checkout v1.0.0.Final debezium-connector-mongodb
git checkout v1.0.0.Final debezium-connector-mysql
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point the filtered branch still is based off of the <em>v1.0.0.Final</em> tag,
whereas it should be based off of the <em>docs_backport</em> branch.
<code>git rebase --onto</code> to the rescue:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">git rebase <span class="nt">--onto</span> docs_backport v1.0.0.Final docs_filtered</code></pre>
</div>
</div>
<div class="paragraph">
<p>This rebases all the commits from the <em>docs_filtered</em> branch onto the <em>docs_backport</em> branch.
Now we have a state where where <strong>all</strong> the documention changes have been cleanly applied to the 1.0 code base,
i.e. the following should yield no differences:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">git diff docs_filtered..master documentation</code></pre>
</div>
</div>
<div class="paragraph">
<p>The last and missing step is to do another rebase of all the documentation commits, discarding those that apply to any features that didn&#8217;t get backported to 1.0.</p>
</div>
<div class="paragraph">
<p>Thankfully, my partner-in-crime Jiri Pechanec stepped in here:
as he had done the original feature backport,
it didn&#8217;t take him too long to go through the list of documentation commits and identify those which were relevant for the 1.0 code base.
After one more interactive rebase for applying those we finally were in a state, where all the required documentation changes had been backported.</p>
</div>
<div class="paragraph">
<p>Looking at the 1.0 history, you&#8217;d still see some partial documentation changes up to the point, where we decided to start all over and revert these.
Theoretically we could do another git filter run to exclude those,
but we decided against that,
as we already had done releases off of the 1.0 branch and didn&#8217;t want to alter the commit history of a released branch after the fact.</p>
</div>
</div>
</div>
			</div>

			<div class="post-tags">
				
					
				
			</div>
		</div><div id="disqus_thread">
  <script src="https://giscus.app/client.js"
    data-repo="gunnarmorling/discussions.morling.dev"
    data-repo-id="R_kgDOGXzqNQ"
    data-category="Announcements"
    data-category-id="DIC_kwDOGXzqNc4B_2Pq"
    data-mapping="title"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-theme="light"
    data-lang="en"
    crossorigin="anonymous"
    async>
  </script>
</div>

<noscript>Please enable JavaScript, or join the <a href="https://github.com/gunnarmorling/discussions.morling.dev/discussions/">discussion on GitHub</a>.</noscript>
</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> Â© 2019 - 2023 Gunnar Morling |  Licensed Under <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons BY-SA 4.0</a></div>
	</nav>
</div><script>
	mediumZoom(document.querySelectorAll('div.imageblock > div.content > img'))
</script>

</body>
</html>
