<!DOCTYPE html>
<html>
<head>
	
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-DD997656SV"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'G-DD997656SV');
	</script>

	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Postgres Replication Slots: Confirmed Flush LSN vs. Restart LSN - Gunnar Morling</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:url" content="https://www.morling.dev/blog/postgres-replication-slots-confirmed-flush-lsn-vs-restart-lsn/">
  <meta property="og:site_name" content="Gunnar Morling">
  <meta property="og:title" content="Postgres Replication Slots: Confirmed Flush LSN vs. Restart LSN">
  <meta property="og:description" content=" Replication slots in Postgres keep track of how far consumers have read a replication stream. After a restart, consumers—​either Postgres read replicas or external tools for change data capture …">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="blog">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2025-08-05T13:55:00&#43;02:00">
    <meta property="article:modified_time" content="2025-08-05T13:55:00&#43;02:00">
<meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Postgres Replication Slots: Confirmed Flush LSN vs. Restart LSN">
  <meta name="twitter:description" content=" Replication slots in Postgres keep track of how far consumers have read a replication stream. After a restart, consumers—​either Postgres read replicas or external tools for change data capture …">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" />
 
	<link rel="stylesheet" type="text/css" media="screen" href="https://www.morling.dev/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://www.morling.dev/css/main.css" />

	
	<link rel="stylesheet" type="text/css" href="https://www.morling.dev/css/base16.dark.css" />
	
	<link rel="stylesheet" type="text/css" href="https://www.morling.dev/css/morlingdev.css" />
	

	<script>
		const searchUrl = "https:\/\/search-morling-dev.onrender.com\/";
		const apiKey = "ff90d45f4afad3bd914c";
	</script>

	<script src="https://www.morling.dev//js/main.js"></script>
	<script src="https://www.morling.dev//js/medium-zoom.min.js"></script>

	<noscript>
		<style type="text/css">
			.club { display:none; }
		</style>
	</noscript>
</head>

<body>
	<div class="container wrapper post">
		<div class="header desktop">

	<div class="row">
		<div class="header-image-container">
			<img class="header-image" src="/images/gunnar_morling.jpg" alt="Gunnar Morling">
		</div>
		<div class="fill">
			<h1 class="site-title"><a href="https://www.morling.dev/">Gunnar Morling</a></h1>
			<div class="site-description"><h2>Random Musings on All Things Software Engineering</h2></div>

			<nav class="row pre-nav">
				<div class="pull-right">
					<ul class="flat"><li>
							<a href="/blog/index.xml" title="RSS FEED">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#rss"/>
								</svg>
							</a>
						</li><li>
							<a href="https://github.com/gunnarmorling" title="GitHub">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#github"/>
								</svg>
							</a>
						</li><li>
							<a href="https://bsky.app/profile/gunnarmorling.dev" title="Bluesky">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#cloud"/>
								</svg>
							</a>
						</li><li>
							<a href="https://twitter.com/gunnarmorling" title="Twitter">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#twitter"/>
								</svg>
							</a>
						</li><li>
							<a href="https://www.linkedin.com/in/gunnar-morling/" title="LinkedIn">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#linkedin"/>
								</svg>
							</a>
						</li><li>
							<a href="https://mastodon.online/@gunnarmorling" title="Mastodon">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#message-square"/>
								</svg>
							</a>
						</li></ul>
				</div>
			</nav>
			<nav class="row nav">
				<div>
					<ul class="flat">
						
						<li>
							<a href="/blog">Blog</a>
						</li>
						
						<li>
							<a href="/projects/">Projects</a>
						</li>
						
						<li>
							<a href="/conferences/">Conferences</a>
						</li>
						
						<li>
							<a href="/podcasts/">Podcasts</a>
						</li>
						
						<li>
							<a href="/about/">About</a>
						</li>
						
					</ul>
				</div>
				<div class="pull-right">
					<div class="club">
						<form id="myForm">
							<input type="text" id="inputSearch" name="q" placeholder="Search..." onfocus="warmUp(this)">
							<button type="submit" id="buttonSubmitSearch" style="line-height: normal;"><i id="iconSearch" class="fa fa-search"></i></button>
						</form>
					</div>
				</div>
			</nav>
		</div>
	</div>
</div>

<div class="header mobile">

	<div class="row">
		<div class="header-image-container">
			<img class="header-image" src="/images/gunnar_morling.jpg" alt="Gunnar Morling">
		</div>
		<div class="fill">
			<h1 class="site-title"><a href="https://www.morling.dev/">Gunnar Morling</a></h1>
			<div class="site-description"><h2>Random Musings on All Things Software Engineering</h2></div>
		</div>
	</div>
	<div>
		<div>
			<nav class="row pre-nav">
				<div class="pull-right">
					<ul class="flat"><li>
							<a href="/blog/index.xml" title="RSS FEED">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#rss"/>
								</svg>
							</a>
						</li><li>
							<a href="https://github.com/gunnarmorling" title="GitHub">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#github"/>
								</svg>
							</a>
						</li><li>
							<a href="https://bsky.app/profile/gunnarmorling.dev" title="Bluesky">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#cloud"/>
								</svg>
							</a>
						</li><li>
							<a href="https://twitter.com/gunnarmorling" title="Twitter">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#twitter"/>
								</svg>
							</a>
						</li><li>
							<a href="https://www.linkedin.com/in/gunnar-morling/" title="LinkedIn">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#linkedin"/>
								</svg>
							</a>
						</li><li>
							<a href="https://mastodon.online/@gunnarmorling" title="Mastodon">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#message-square"/>
								</svg>
							</a>
						</li></ul>
				</div>
			</nav>
			<nav class="row nav">
				<div>
					<ul class="flat">
						
						<li>
							<a href="/blog">Blog</a>
						</li>
						
						<li>
							<a href="/projects/">Projects</a>
						</li>
						
						<li>
							<a href="/conferences/">Conferences</a>
						</li>
						
						<li>
							<a href="/podcasts/">Podcasts</a>
						</li>
						
						<li>
							<a href="/about/">About</a>
						</li>
						
					</ul>
				</div>
				<div class="pull-right">
					<div class="club">
						<form id="myFormMobile">
							<input type="text" id="inputSearchMobile" name="q" placeholder="Search..." onfocus="warmUp(this)">
							<button type="submit" id="buttonSubmitSearchMobile" style="line-height: normal;"><i id="iconSearchMobile" class="fa fa-search"></i></button>
						</form>
					</div>
				</div>
			</nav>
		</div>
	</div>
</div>

<script type="text/javascript">
	window.addEventListener( "load", function () {
		const urlParams = new URLSearchParams(window.location.search);

		


		const form = document.getElementById( "myForm" );

		form.addEventListener("submit", function (event) {
			event.preventDefault();
			sendData(new FormData(form));
		});

		const formMobile = document.getElementById( "myFormMobile" );

		formMobile.addEventListener("submit", function (event) {
			event.preventDefault();
			sendData(new FormData(formMobile));
		});
	});
</script>


		<div id = "main-content">
			<div class="post-header">
				<h1 class="title">Postgres Replication Slots: Confirmed Flush LSN vs. Restart LSN</h1>
				<div class="meta">Posted at Aug 5, 2025</div>
			</div>

			<div class="post-content">
				<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_confirmed_flush_sn_tracking_consumer_progress">confirmed_flush_sn: Tracking Consumer Progress</a></li>
<li><a href="#_restart_lsn_handling_concurrent_transactions">restart_lsn: Handling Concurrent Transactions</a></li>
<li><a href="#_mid_transaction_recovery">Mid-Transaction Recovery</a></li>
<li><a href="#_looking_forward_streaming_in_progress_transactions">Looking Forward: Streaming In-Progress Transactions</a></li>
</ul>
</div>
<div class="paragraph">
<p>Replication slots in Postgres keep track of how far consumers have read a replication stream.
After a restart, consumers—​either Postgres read replicas or external tools for change data capture (CDC), like <a href="https://debezium.io/">Debezium</a>—resume reading from the last confirmed log sequence number (LSN) of their replication slot. The slot prevents the database from disposing of required log segments, allowing safe resumption after downtime.</p>
</div>
<div class="paragraph">
<p>In this post, we are going to take a look at why Postgres replication slots don’t have one but two LSN-related attributes: <code>restart_lsn</code> and <code>confirmed_flush_lsn</code>.
Understanding the difference between the two is crucial for troubleshooting replication issues, optimizing WAL retention, and avoiding common pitfalls in production environments.</p>
</div>
<div class="paragraph">
<p>To examine the state of a replication slot, you can query the <code>pg_replication_slots</code> view.
It also shows the <code>restart_lsn</code> and <code>confirmed_flush_lsn</code> of each slot:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
</pre></td><td class="code"><pre><span class="k">SELECT</span>
  <span class="n">slot_name</span><span class="p">,</span> <span class="n">plugin</span><span class="p">,</span> <span class="n">restart_lsn</span><span class="p">,</span> <span class="n">confirmed_flush_lsn</span>
<span class="k">FROM</span>
  <span class="n">pg_replication_slots</span><span class="p">;</span>
<span class="o">+</span><span class="c1">----------------+---------------+-------------+---------------------+</span>
<span class="o">|</span> <span class="n">slot_name</span>      <span class="o">|</span> <span class="n">plugin</span>        <span class="o">|</span> <span class="n">restart_lsn</span> <span class="o">|</span> <span class="n">confirmed_flush_lsn</span> <span class="o">|</span>
<span class="o">|</span><span class="c1">----------------+---------------+-------------+---------------------|</span>
<span class="o">|</span> <span class="n">logical_slot_4</span> <span class="o">|</span> <span class="n">pgoutput</span>      <span class="o">|</span> <span class="mi">0</span><span class="o">/</span><span class="mi">1</span><span class="n">D4A478</span>   <span class="o">|</span> <span class="mi">0</span><span class="o">/</span><span class="mi">1</span><span class="n">D52850</span>           <span class="o">|</span>
<span class="o">|</span> <span class="n">demo_slot</span>      <span class="o">|</span> <span class="n">test_decoding</span> <span class="o">|</span> <span class="mi">0</span><span class="o">/</span><span class="mi">1</span><span class="n">DDC4D0</span>   <span class="o">|</span> <span class="mi">0</span><span class="o">/</span><span class="mi">1</span><span class="n">DDC4D0</span>           <span class="o">|</span>
<span class="o">+</span><span class="c1">----------------+---------------+-------------+---------------------+</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>So what’s the difference between the two?
Shouldn’t a single LSN be enough for tracking the progress a consumer has made?</p>
</div>
<div class="sect1">
<h2 id="_confirmed_flush_sn_tracking_consumer_progress">confirmed_flush_sn: Tracking Consumer Progress</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to understand why Postgres manages these two LSN separately,
let’s take a look at what the <a href="https://www.postgresql.org/docs/current/view-pg-replication-slots.html">Postgres docs</a> have to say,
starting with <code>confirmed_flush_lsn</code>:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><code>confirmed_flush_lsn</code>: The address (LSN) up to which the logical slot’s consumer has confirmed receiving data. Data corresponding to the transactions committed before this LSN is not available anymore. NULL for physical slots.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>So this is the latest LSN acknowledged by the slot’s consumer.
In general, streaming will be continued from the next entry in the write-ahead log (WAL) after this LSN when restarting a consumer
(we’ll get to one exception later on).
Let’s confirm this by creating a slot using the <a href="https://www.postgresql.org/docs/current/test-decoding.html"><code>test_decoding</code></a> plug-in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
</pre></td><td class="code"><pre><span class="c1">-- Creating a table for experimenting</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">inventory</span><span class="p">.</span><span class="n">customers</span> <span class="p">(</span>
  <span class="n">id</span> <span class="nb">SERIAL</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
  <span class="n">first_name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">last_name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">email</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">UNIQUE</span><span class="p">,</span>
  <span class="n">is_test_account</span> <span class="nb">BOOLEAN</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="p">);</span>

<span class="k">ALTER</span> <span class="n">SEQUENCE</span> <span class="n">inventory</span><span class="p">.</span><span class="n">customers_id_seq</span> <span class="k">RESTART</span> <span class="k">WITH</span> <span class="mi">1001</span><span class="p">;</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">inventory</span><span class="p">.</span><span class="n">customers</span> <span class="n">REPLICA</span> <span class="k">IDENTITY</span> <span class="k">FULL</span><span class="p">;</span>

<span class="c1">-- Creating a replication slot</span>
<span class="k">SELECT</span>
  <span class="o">*</span>
<span class="k">FROM</span>
  <span class="n">pg_create_logical_replication_slot</span><span class="p">(</span><span class="s1">&#39;demo_slot&#39;</span><span class="p">,</span> <span class="s1">&#39;test_decoding&#39;</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>test_decoding</code> logical decoding plug-in is great for some quick testing and experimenting.
For production use cases, the <code>pgoutput</code> plug-in should be used.
You can learn more about this and other best practices for managing Postgres replication slots in this <a href="/blog/mastering-postgres-replication-slots/">blog post</a> I wrote recently.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Insert some data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="k">INSERT</span> <span class="k">INTO</span>
  <span class="n">inventory</span><span class="p">.</span><span class="n">customers</span> <span class="p">(</span><span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">is_test_account</span><span class="p">)</span>
  <span class="k">SELECT</span>
    <span class="n">md5</span><span class="p">(</span><span class="n">random</span><span class="p">()::</span><span class="nb">text</span><span class="p">),</span>
    <span class="n">md5</span><span class="p">(</span><span class="n">random</span><span class="p">()::</span><span class="nb">text</span><span class="p">),</span>
    <span class="n">md5</span><span class="p">(</span><span class="n">random</span><span class="p">()::</span><span class="nb">text</span><span class="p">),</span>
    <span class="k">false</span>
  <span class="k">FROM</span>
    <span class="n">generate_series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">g</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>And consume it using Postgres&#39; built-in <a href="https://www.postgresql.org/docs/current/functions-admin.html#FUNCTIONS-REPLICATION">SQL interface</a> for working with logical replication streams
(output shortened for readability):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
</pre></td><td class="code"><pre><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">pg_logical_slot_get_changes</span><span class="p">(</span><span class="s1">&#39;demo_slot&#39;</span><span class="p">,</span> <span class="k">NULL</span><span class="p">,</span> <span class="k">NULL</span><span class="p">);</span>
<span class="o">+</span><span class="c1">-----------+-----+-----------------------------------------------+</span>
<span class="o">|</span> <span class="n">lsn</span>       <span class="o">|</span> <span class="n">xid</span> <span class="o">|</span> <span class="k">data</span>                                          <span class="o">|</span>
<span class="o">|</span><span class="c1">-----------+-----+-----------------------------------------------|</span>
<span class="o">|</span> <span class="mi">0</span><span class="o">/</span><span class="mi">1</span><span class="n">DDC648</span> <span class="o">|</span> <span class="mi">765</span> <span class="o">|</span> <span class="k">BEGIN</span> <span class="mi">765</span>                                     <span class="o">|</span>
<span class="o">|</span> <span class="mi">0</span><span class="o">/</span><span class="mi">1</span><span class="n">DDC6B0</span> <span class="o">|</span> <span class="mi">765</span> <span class="o">|</span> <span class="k">table</span> <span class="n">customers</span><span class="p">:</span> <span class="k">INSERT</span><span class="p">:</span> <span class="n">id</span><span class="p">[</span><span class="nb">integer</span><span class="p">]:</span><span class="mi">1138</span> <span class="p">...</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">0</span><span class="o">/</span><span class="mi">1</span><span class="n">DDF4D0</span> <span class="o">|</span> <span class="mi">765</span> <span class="o">|</span> <span class="k">table</span> <span class="n">customers</span><span class="p">:</span> <span class="k">INSERT</span><span class="p">:</span> <span class="n">id</span><span class="p">[</span><span class="nb">integer</span><span class="p">]:</span><span class="mi">1139</span> <span class="p">...</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">0</span><span class="o">/</span><span class="mi">1</span><span class="n">DDF610</span> <span class="o">|</span> <span class="mi">765</span> <span class="o">|</span> <span class="k">table</span> <span class="n">customers</span><span class="p">:</span> <span class="k">INSERT</span><span class="p">:</span> <span class="n">id</span><span class="p">[</span><span class="nb">integer</span><span class="p">]:</span><span class="mi">1140</span> <span class="p">...</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">0</span><span class="o">/</span><span class="mi">1</span><span class="n">DDF780</span> <span class="o">|</span> <span class="mi">765</span> <span class="o">|</span> <span class="k">COMMIT</span> <span class="mi">765</span>                                    <span class="o">|</span>
<span class="o">+</span><span class="c1">-----------+-----+-----------------------------------------------+</span>
<span class="k">SELECT</span> <span class="mi">5</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The slot’s <code>confirmed_flush_lsn</code> is the last consumed LSN, <code>0/1DDF780</code>, automatically acknowledged by <code>pg_logical_slot_get_changes()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="k">SELECT</span>
  <span class="n">slot_name</span><span class="p">,</span> <span class="n">plugin</span><span class="p">,</span> <span class="n">restart_lsn</span><span class="p">,</span> <span class="n">confirmed_flush_lsn</span>
<span class="k">FROM</span>
  <span class="n">pg_replication_slots</span><span class="p">;</span>
<span class="o">+</span><span class="c1">----------------+---------------+-------------+---------------------+</span>
<span class="o">|</span> <span class="n">slot_name</span>      <span class="o">|</span> <span class="n">plugin</span>        <span class="o">|</span> <span class="n">restart_lsn</span> <span class="o">|</span> <span class="n">confirmed_flush_lsn</span> <span class="o">|</span>
<span class="o">|</span><span class="c1">----------------+---------------+-------------+---------------------|</span>
<span class="o">|</span> <span class="n">demo_slot</span>      <span class="o">|</span> <span class="n">test_decoding</span> <span class="o">|</span> <span class="mi">0</span><span class="o">/</span><span class="mi">1</span><span class="n">DDC610</span>   <span class="o">|</span> <span class="mi">0</span><span class="o">/</span><span class="mi">1</span><span class="n">DDF780</span>           <span class="o">|</span>
<span class="o">+</span><span class="c1">----------------+---------------+-------------+---------------------+</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we were to do more data changes and consume the slot again, we’d receive any events after LSN <code>0/1DDF780</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_restart_lsn_handling_concurrent_transactions">restart_lsn: Handling Concurrent Transactions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So far, so good; what’s the deal with <code>restart_lsn</code> then?
Unfortunately, the official docs are a bit vague on this one:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><code>restart_lsn</code>: The address (LSN) of oldest WAL which still might be required by the consumer of this slot and thus won’t be automatically removed during checkpoints unless this LSN gets behind more than max_slot_wal_keep_size from the current LSN. NULL if the LSN of this slot has never been reserved.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>When would a consumer need access to events older than its last confirmed LSN?
This becomes clear when we examine how the WAL captures multiple transactions running concurrently, and how these are streamed to logical replication consumers.
By default, the events of a transaction will only be published after the transaction has been committed.
Suppose there are two transactions A and B running at the same time,
with transaction A beginning before transaction B, but B committing before A.
The WAL might look like this (LSNs shortened for readability):</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/replication_slots_confirmed_flush_lsn_restart_lsn.png" alt="replication slots confirmed flush lsn restart lsn"/>
</div>
</div>
<div class="paragraph">
<p>When transaction B commits, all its changes get published to the consumer of the replication slot,
which eventually will confirm the latest LSN it has seen, <code>0/A6</code> (the LSN of the commit event).
This does not mean though that the database can prune all earlier WAL sections just yet.
At this point, transaction A still is running, so any WAL sections with the changes from this transaction still need to be retained until the transaction commits and the change events have been received and acknowledged by the replication slot consumer.</p>
</div>
<div class="paragraph">
<p>And this is exactly the purpose of the replication slot’s <code>restart_lsn</code>:
it is the latest LSN prior to all transactions which either are still in-flight, or which have committed but not been acknowledged by the consumer yet,
in the example <code>0/A0</code>.
It acts as a retention boundary—​WAL segments before this point can be safely discarded.</p>
</div>
<div class="paragraph">
<p>This way of handling concurrent transactions has a few important implications:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Consumers of logical replication cannot rely on the LSNs of received events to be strictly increasing.
As transactions are exposed in commit order, events with a lower LSN can be published after events with a higher LSN.
Only the tuple <code>(commit_lsn, lsn)</code> is guaranteed to be strictly increasing,
i.e. commit LSNs are non-decreasing, and the LSNs of the events within one and the same transaction are non-decreasing.</p>
</li>
<li>
<p>Large or long-running transactions prevent the database from increasing the restart LSN of replication slots and hence may cause excessive amounts of WAL to be retained; therefore, you should generally avoid these types of transactions when possible</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You also might wonder how the logical replication engine identifies the events to publish when encountering a <code>COMMIT</code> event in the WAL.
A data structure called the <a href="https://github.com/postgres/postgres/blob/master/src/backend/replication/logical/reorderbuffer.c#L652">&#34;reorder buffer&#34;</a> is used for this purpose.
It stores all events retrieved from the WAL, keyed by transaction id.
Upon processing a transaction’s commit event,
all events for the transaction are fetched from the buffer and emitted to the consumer.
That way, no costly seeking in the WAL is required.</p>
</div>
<div class="paragraph">
<p>The buffer can spill over to disk for large transactions when reaching a given threshold,
defaulting to 64 MB and configurable via the <a href="https://postgresqlco.nf/doc/en/param/logical_decoding_work_mem/"><code>logical_decoding_work_mem</code></a> setting.
As this means additional disk I/O though,
you should keep an eye on the amount of disk spill, using the <a href="https://www.postgresql.org/docs/current/monitoring-stats.html#MONITORING-PG-STAT-REPLICATION-SLOTS-VIEW">pg_stat_replication_slots</a> view.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_mid_transaction_recovery">Mid-Transaction Recovery</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Above, I mentioned there’d be one situation where a consumer may receive events from before the <code>confirmed_flush_lsn</code> of its replication slot when resuming to process a replication stream after a downtime.
This happens when <code>confirmed_flush_lsn</code> points to an event in the middle of a transaction, rather than to a <code>COMMIT</code> event.
In this case, all events of the entire transaction will be replayed to the consumer, starting with a <code>BEGIN</code> event.</p>
</div>
<div class="paragraph">
<p>Let’s try to reproduce this situation.
<code>pg_logical_slot_get_changes()</code> always returns all the events of a transaction, also when instructed to fetch a lower number of events.
So we’ll have to be a bit more creative.
First, let’s retrieve the current LSN and then insert a couple of rows into the <code>customers</code> table in a transaction:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre><span class="k">SELECT</span> <span class="n">pg_current_wal_lsn</span><span class="p">();</span>
<span class="o">+</span><span class="c1">--------------------+</span>
<span class="o">|</span> <span class="n">pg_current_wal_lsn</span> <span class="o">|</span>
<span class="o">|</span><span class="c1">--------------------|</span>
<span class="o">|</span> <span class="mi">2</span><span class="o">/</span><span class="mi">50955</span><span class="n">BD8</span>         <span class="o">|</span>
<span class="o">+</span><span class="c1">--------------------+</span>

<span class="k">BEGIN</span><span class="p">;</span>
<span class="k">INSERT</span> <span class="k">INTO</span>
    <span class="n">inventory</span><span class="p">.</span><span class="n">customers</span> <span class="p">(</span><span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">is_test_account</span><span class="p">)</span>
    <span class="k">SELECT</span>
      <span class="n">md5</span><span class="p">(</span><span class="n">random</span><span class="p">()::</span><span class="nb">text</span><span class="p">),</span>
      <span class="n">md5</span><span class="p">(</span><span class="n">random</span><span class="p">()::</span><span class="nb">text</span><span class="p">),</span>
      <span class="n">md5</span><span class="p">(</span><span class="n">random</span><span class="p">()::</span><span class="nb">text</span><span class="p">),</span>
      <span class="k">false</span>
    <span class="k">FROM</span>
      <span class="n">generate_series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">g</span><span class="p">;</span>
<span class="k">COMMIT</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>To find out the LSN of one of the individual row inserts, we can use the <a href="https://www.postgresql.org/docs/current/pgwalinspect.html"><code>pg_walinspect</code></a> extension;
it provides the <code>pg_get_wal_records_info()</code> function which lets you take a view at the WAL events of a given LSN range
(as an aside, this shows that there is no explicit event for the begin of a transaction in the WAL;
the <code>BEGIN</code> events in a replication stream are inserted by the logical replication system):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="code"><pre><span class="k">SELECT</span>
  <span class="n">start_lsn</span><span class="p">,</span> <span class="n">end_lsn</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="n">record_type</span>
<span class="k">FROM</span>
  <span class="n">pg_get_wal_records_info</span><span class="p">(</span>
      <span class="s1">&#39;2/50955BD8&#39;</span><span class="p">,</span>
      <span class="n">pg_current_wal_lsn</span><span class="p">()</span>
  <span class="p">);</span>
<span class="o">+</span><span class="c1">------------+------------+-----+---------------+</span>
<span class="o">|</span> <span class="n">start_lsn</span>  <span class="o">|</span> <span class="n">end_lsn</span>    <span class="o">|</span> <span class="n">xid</span> <span class="o">|</span> <span class="n">record_type</span>   <span class="o">|</span>
<span class="o">|</span><span class="c1">------------+------------+-----+---------------|</span>
<span class="o">|</span> <span class="mi">2</span><span class="o">/</span><span class="mi">50955</span><span class="n">BD8</span> <span class="o">|</span> <span class="mi">2</span><span class="o">/</span><span class="mi">50955</span><span class="n">C40</span> <span class="o">|</span> <span class="mi">777</span> <span class="o">|</span> <span class="n">LOG</span>           <span class="o">|</span>
<span class="o">|</span> <span class="mi">2</span><span class="o">/</span><span class="mi">50955</span><span class="n">C40</span> <span class="o">|</span> <span class="mi">2</span><span class="o">/</span><span class="mi">50956</span><span class="n">E18</span> <span class="o">|</span> <span class="mi">777</span> <span class="o">|</span> <span class="k">INSERT</span>        <span class="o">|</span>
<span class="o">|</span> <span class="mi">2</span><span class="o">/</span><span class="mi">50956</span><span class="n">E18</span> <span class="o">|</span> <span class="mi">2</span><span class="o">/</span><span class="mi">50956</span><span class="n">E90</span> <span class="o">|</span> <span class="mi">777</span> <span class="o">|</span> <span class="n">INSERT_LEAF</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">2</span><span class="o">/</span><span class="mi">50956</span><span class="n">E90</span> <span class="o">|</span> <span class="mi">2</span><span class="o">/</span><span class="mi">50956</span><span class="n">F90</span> <span class="o">|</span> <span class="mi">777</span> <span class="o">|</span> <span class="n">INSERT_LEAF</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">2</span><span class="o">/</span><span class="mi">50956</span><span class="n">F90</span> <span class="o">|</span> <span class="mi">2</span><span class="o">/</span><span class="mi">50957030</span> <span class="o">|</span> <span class="mi">777</span> <span class="o">|</span> <span class="k">INSERT</span>        <span class="o">|</span>
<span class="o">|</span> <span class="mi">2</span><span class="o">/</span><span class="mi">50957030</span> <span class="o">|</span> <span class="mi">2</span><span class="o">/</span><span class="mi">50957070</span> <span class="o">|</span> <span class="mi">777</span> <span class="o">|</span> <span class="n">INSERT_LEAF</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">2</span><span class="o">/</span><span class="mi">50957070</span> <span class="o">|</span> <span class="mi">2</span><span class="o">/</span><span class="mi">50957170</span> <span class="o">|</span> <span class="mi">777</span> <span class="o">|</span> <span class="n">INSERT_LEAF</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">2</span><span class="o">/</span><span class="mi">50957170</span> <span class="o">|</span> <span class="mi">2</span><span class="o">/</span><span class="mi">50957210</span> <span class="o">|</span> <span class="mi">777</span> <span class="o">|</span> <span class="k">INSERT</span>        <span class="o">|</span>
<span class="o">|</span> <span class="mi">2</span><span class="o">/</span><span class="mi">50957210</span> <span class="o">|</span> <span class="mi">2</span><span class="o">/</span><span class="mi">50957250</span> <span class="o">|</span> <span class="mi">777</span> <span class="o">|</span> <span class="n">INSERT_LEAF</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">2</span><span class="o">/</span><span class="mi">50957250</span> <span class="o">|</span> <span class="mi">2</span><span class="o">/</span><span class="mi">50957350</span> <span class="o">|</span> <span class="mi">777</span> <span class="o">|</span> <span class="n">INSERT_LEAF</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">2</span><span class="o">/</span><span class="mi">50957350</span> <span class="o">|</span> <span class="mi">2</span><span class="o">/</span><span class="mi">50957388</span> <span class="o">|</span> <span class="mi">0</span>   <span class="o">|</span> <span class="n">RUNNING_XACTS</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">2</span><span class="o">/</span><span class="mi">50957388</span> <span class="o">|</span> <span class="mi">2</span><span class="o">/</span><span class="mi">509573</span><span class="n">B8</span> <span class="o">|</span> <span class="mi">777</span> <span class="o">|</span> <span class="k">COMMIT</span>        <span class="o">|</span>
<span class="o">+</span><span class="c1">------------+------------+-----+---------------+</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, move the replication slot forward to the LSN of the second <code>INSERT</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="k">SELECT</span> <span class="n">pg_replication_slot_advance</span><span class="p">(</span><span class="s1">&#39;demo_slot&#39;</span><span class="p">,</span> <span class="s1">&#39;2/50956F90&#39;</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you now retrieve the changes from the slot, you’ll see that it still returns all the events from that transaction,
including the first <code>INSERT</code>, despite this one having an LSN older than <code>confirmed_flush_lsn</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
</pre></td><td class="code"><pre><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">pg_logical_slot_get_changes</span><span class="p">(</span><span class="s1">&#39;demo_slot&#39;</span><span class="p">,</span> <span class="k">NULL</span><span class="p">,</span> <span class="k">NULL</span><span class="p">);</span>
<span class="o">+</span><span class="c1">------------+-----+---------------------------------------------------+</span>
<span class="o">|</span> <span class="n">lsn</span>        <span class="o">|</span> <span class="n">xid</span> <span class="o">|</span> <span class="k">data</span>                                              <span class="o">|</span>
<span class="o">|</span><span class="c1">------------+-----+---------------------------------------------------|</span>
<span class="o">|</span> <span class="mi">2</span><span class="o">/</span><span class="mi">50955</span><span class="n">BD8</span> <span class="o">|</span> <span class="mi">777</span> <span class="o">|</span> <span class="k">BEGIN</span> <span class="mi">777</span>                                         <span class="o">|</span>
<span class="o">|</span> <span class="mi">2</span><span class="o">/</span><span class="mi">50955</span><span class="n">C40</span> <span class="o">|</span> <span class="mi">777</span> <span class="o">|</span> <span class="k">table</span> <span class="n">customers</span><span class="p">:</span> <span class="k">INSERT</span><span class="p">:</span> <span class="n">id</span><span class="p">[</span><span class="nb">integer</span><span class="p">]:</span><span class="mi">10001159</span> <span class="p">...</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">2</span><span class="o">/</span><span class="mi">50956</span><span class="n">F90</span> <span class="o">|</span> <span class="mi">777</span> <span class="o">|</span> <span class="k">table</span> <span class="n">customers</span><span class="p">:</span> <span class="k">INSERT</span><span class="p">:</span> <span class="n">id</span><span class="p">[</span><span class="nb">integer</span><span class="p">]:</span><span class="mi">10001160</span> <span class="p">...</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">2</span><span class="o">/</span><span class="mi">50957170</span> <span class="o">|</span> <span class="mi">777</span> <span class="o">|</span> <span class="k">table</span> <span class="n">customers</span><span class="p">:</span> <span class="k">INSERT</span><span class="p">:</span> <span class="n">id</span><span class="p">[</span><span class="nb">integer</span><span class="p">]:</span><span class="mi">10001161</span> <span class="p">...</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">2</span><span class="o">/</span><span class="mi">509573</span><span class="n">B8</span> <span class="o">|</span> <span class="mi">777</span> <span class="o">|</span> <span class="k">COMMIT</span> <span class="mi">777</span>                                        <span class="o">|</span>
<span class="o">+</span><span class="c1">------------+-----+---------------------------------------------------+</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is therefore generally advisable to confirm commit LSNs,
as it allows the database to discard all the WAL elements for that transaction.
When using Debezium, you can set the connector option <a href="https://debezium.io/documentation/reference/stable/connectors/postgresql#postgresql-property-provide-transaction-metadata"><code>provide.transaction.metadata</code></a> to <code>true</code> in order to achieve that.
Otherwise, Debezium would only acknowledge the LSN of the last event within a transaction.
This is due to the constraints of the Kafka Connect framework, which only triggers a commit of source offsets when emitting records to Kafka.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_looking_forward_streaming_in_progress_transactions">Looking Forward: Streaming In-Progress Transactions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One last thing worth mentioning is that since version 14,
Postgres also supports <a href="https://amitkapila16.blogspot.com/2021/07/logical-replication-of-in-progress.html">logical replication of in-progress transactions</a>.
This can be an interesting option to mitigate the issue of replication slots retaining a lot of WAL for large transactions,
and it also can help to reduce end-to-end latencies as CDC tools can process change events (format them, filter them, etc.) before a transaction commits.</p>
</div>
<div class="paragraph">
<p>On the other hand, it also shifts quite a bit of complexity into the CDC layer,
which now—​similar to Postgres&#39; internal reorder buffer—​requires a way to store all the events of a transaction,
so as to drop the events of transactions which eventually get rolled back.
Debezium tracks this feature under the issue <a href="https://issues.redhat.com/browse/DBZ-9309">DBZ-9309</a>.</p>
</div>
</div>
</div>
			</div>

			<div class="post-tags">
				
					
				
			</div>
		</div>

		<div class="post-footer">
			<div style="display: flex; align-items: center; gap: 1rem;">
				<div class="header-image-container" style="flex-shrink: 0;">
					<img class="footer-image" src="/images/gunnar_morling.jpg" alt="Gunnar Morling">
				</div>
				<p style="margin: 0;">Gunnar Morling is an open-source software engineer in the Java and data streaming space. He currently works as a Technologist for Confluent. In his past role at Decodable he focused on developer outreach and helped them build their stream processing platform based on Apache Flink. Prior to that, he spent ten years at Red Hat, where he led the Debezium project, a platform for change data capture.</p>
			</div>
		</div>

		
		
		<div class="post-discussions">
			<p>Comment below or join the discussion on
			<a href="https://hn.algolia.com/?query=morling.dev/blog/postgres-replication-slots-confirmed-flush-lsn-vs-restart-lsn/">Hacker News</a>,
			<a href="https://lobste.rs/search?q=domain:morling.dev+title:%22Postgres%20Replication%20Slots%3a%20Confirmed%20Flush%20LSN%20vs.%20Restart%20LSN%22&what=stories">Lobsters</a>, and
			<a href="https://www.reddit.com/search/?q=url:morling.dev/blog/postgres-replication-slots-confirmed-flush-lsn-vs-restart-lsn/">Reddit</a>.
			</p>
		</div>
		<div id="disqus_thread"></div>

<script>
  
  window.addEventListener('load', function() {
    
    setTimeout(function() {
      const commentsContainer = document.getElementById('disqus_thread');
      const script = document.createElement('script');
      script.src = 'https://giscus.app/client.js';
      script.setAttribute('data-repo', 'gunnarmorling/discussions.morling.dev');
      script.setAttribute('data-repo-id', 'R_kgDOGXzqNQ');
      script.setAttribute('data-category', 'Announcements');
      script.setAttribute('data-category-id', 'DIC_kwDOGXzqNc4B_2Pq');
      script.setAttribute('data-mapping', 'title');
      script.setAttribute('data-reactions-enabled', '1');
      script.setAttribute('data-emit-metadata', '0');
      script.setAttribute('data-theme', 'light');
      script.setAttribute('data-lang', 'en');
      script.setAttribute('crossorigin', 'anonymous');
      script.async = true;
      commentsContainer.appendChild(script);
    }, 100);
  });
</script>

<noscript>Please enable JavaScript, or join the <a href="https://github.com/gunnarmorling/discussions.morling.dev/discussions/">discussion on GitHub</a>.</noscript>
</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> © 2019 - 2025 Gunnar Morling |  Licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons BY-SA 4.0</a> | <a href="/ai">How I use (and don't use) AI</a></div>
	</nav>
</div><script>
	mediumZoom(document.querySelectorAll('div.imageblock > div.content > img'))
</script>

</body>
</html>
