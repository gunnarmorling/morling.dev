<!DOCTYPE html>
<html>
<head>
	
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-DD997656SV"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'G-DD997656SV');
	</script>

	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Single Message Transformations - The Swiss Army Knife of Kafka Connect - Gunnar Morling</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:url" content="https://www.morling.dev/blog/single-message-transforms-swiss-army-knife-of-kafka-connect/">
  <meta property="og:site_name" content="Gunnar Morling">
  <meta property="og:title" content="Single Message Transformations - The Swiss Army Knife of Kafka Connect">
  <meta property="og:description" content=" Do you remember Angus &amp;#34;Mac&amp;#34; MacGyver? The always creative protagonist of the popular 80ies/90ies TV show, who could solve about any problem with nothing more than a Swiss Army knife, â€¦">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="blog">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2020-05-14T15:30:00&#43;02:00">
    <meta property="article:modified_time" content="2020-05-14T15:30:00&#43;02:00">
<meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Single Message Transformations - The Swiss Army Knife of Kafka Connect">
  <meta name="twitter:description" content=" Do you remember Angus &amp;#34;Mac&amp;#34; MacGyver? The always creative protagonist of the popular 80ies/90ies TV show, who could solve about any problem with nothing more than a Swiss Army knife, â€¦">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="/css/normalize.min.efd5060e5dbdbc4655a896b01b99c2b759dc5710f5cfda5ed34c2259de325469.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="/css/main.min.672476d25c0fad0fd490e21222003c6c89ca45b73df6a5634305e06e889c49ad.css" />

	
	<link rel="stylesheet" type="text/css" href="/css/base16.dark.min.c40398d5ec04ac387c57141dc29e820fc4012da1cf2af8235004fc9945fa76a8.css" />
	
	<link rel="stylesheet" type="text/css" href="/css/morlingdev.min.1f7c90fe21e9cb9a420de17091548a5bddce9099924773750cedf84f08a3adce.css" />
	

	<script>
		const searchUrl = "https:\/\/search-morling-dev.onrender.com\/";
		const apiKey = "ff90d45f4afad3bd914c";
	</script>
	<script src="/js/main.min.9ee619eea7f51473f4284ef86c76bdb1b0089e19781ca97275924edf53be5bd4.js"></script>
	<script src="https://www.morling.dev//js/medium-zoom.min.js"></script>

	<noscript>
		<style type="text/css">
			.club { display:none; }
		</style>
	</noscript>
</head>

<body>
	<div class="container wrapper post">
		<div class="header desktop">

	<div class="row">
		<div class="header-image-container">
			<img class="header-image" src="/images/gunnar_morling.jpg" alt="Gunnar Morling">
		</div>
		<div class="fill">
			<h1 class="site-title"><a href="https://www.morling.dev/">Gunnar Morling</a></h1>
			<div class="site-description"><h2>Random Musings on All Things Software Engineering</h2></div>

			<nav class="row pre-nav">
				<div class="pull-right">
					<ul class="flat"><li>
							<a href="/blog/index.xml" title="RSS FEED">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#rss"/>
								</svg>
							</a>
						</li><li>
							<a href="https://github.com/gunnarmorling" title="GitHub">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#github"/>
								</svg>
							</a>
						</li><li>
							<a href="https://bsky.app/profile/gunnarmorling.dev" title="Bluesky">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#cloud"/>
								</svg>
							</a>
						</li><li>
							<a href="https://twitter.com/gunnarmorling" title="Twitter">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#twitter"/>
								</svg>
							</a>
						</li><li>
							<a href="https://www.linkedin.com/in/gunnar-morling/" title="LinkedIn">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#linkedin"/>
								</svg>
							</a>
						</li><li>
							<a href="https://mastodon.online/@gunnarmorling" title="Mastodon">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#message-square"/>
								</svg>
							</a>
						</li></ul>
				</div>
			</nav>
			<nav class="row nav">
				<div>
					<ul class="flat">
						
						<li>
							<a href="/blog">Blog</a>
						</li>
						
						<li>
							<a href="/projects/">Projects</a>
						</li>
						
						<li>
							<a href="/conferences/">Conferences</a>
						</li>
						
						<li>
							<a href="/podcasts/">Podcasts</a>
						</li>
						
						<li>
							<a href="/about/">About</a>
						</li>
						
					</ul>
				</div>
				<div class="pull-right">
					<div class="club">
						<form id="myForm">
							<input type="text" id="inputSearch" name="q" placeholder="Search..." onfocus="warmUp(this)">
							<button type="submit" id="buttonSubmitSearch" style="line-height: normal;"><i id="iconSearch" class="fa fa-search"></i></button>
						</form>
					</div>
				</div>
			</nav>
		</div>
	</div>
</div>

<div class="header mobile">

	<div class="row">
		<div class="header-image-container">
			<img class="header-image" src="/images/gunnar_morling.jpg" alt="Gunnar Morling">
		</div>
		<div class="fill">
			<h1 class="site-title"><a href="https://www.morling.dev/">Gunnar Morling</a></h1>
			<div class="site-description"><h2>Random Musings on All Things Software Engineering</h2></div>
		</div>
	</div>
	<div>
		<div>
			<nav class="row pre-nav">
				<div class="pull-right">
					<ul class="flat"><li>
							<a href="/blog/index.xml" title="RSS FEED">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#rss"/>
								</svg>
							</a>
						</li><li>
							<a href="https://github.com/gunnarmorling" title="GitHub">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#github"/>
								</svg>
							</a>
						</li><li>
							<a href="https://bsky.app/profile/gunnarmorling.dev" title="Bluesky">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#cloud"/>
								</svg>
							</a>
						</li><li>
							<a href="https://twitter.com/gunnarmorling" title="Twitter">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#twitter"/>
								</svg>
							</a>
						</li><li>
							<a href="https://www.linkedin.com/in/gunnar-morling/" title="LinkedIn">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#linkedin"/>
								</svg>
							</a>
						</li><li>
							<a href="https://mastodon.online/@gunnarmorling" title="Mastodon">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#message-square"/>
								</svg>
							</a>
						</li></ul>
				</div>
			</nav>
			<nav class="row nav">
				<div>
					<ul class="flat">
						
						<li>
							<a href="/blog">Blog</a>
						</li>
						
						<li>
							<a href="/projects/">Projects</a>
						</li>
						
						<li>
							<a href="/conferences/">Conferences</a>
						</li>
						
						<li>
							<a href="/podcasts/">Podcasts</a>
						</li>
						
						<li>
							<a href="/about/">About</a>
						</li>
						
					</ul>
				</div>
				<div class="pull-right">
					<div class="club">
						<form id="myFormMobile">
							<input type="text" id="inputSearchMobile" name="q" placeholder="Search..." onfocus="warmUp(this)">
							<button type="submit" id="buttonSubmitSearchMobile" style="line-height: normal;"><i id="iconSearchMobile" class="fa fa-search"></i></button>
						</form>
					</div>
				</div>
			</nav>
		</div>
	</div>
</div>

<script type="text/javascript">
	window.addEventListener( "load", function () {
		const urlParams = new URLSearchParams(window.location.search);

		


		const form = document.getElementById( "myForm" );

		form.addEventListener("submit", function (event) {
			event.preventDefault();
			sendData(new FormData(form));
		});

		const formMobile = document.getElementById( "myFormMobile" );

		formMobile.addEventListener("submit", function (event) {
			event.preventDefault();
			sendData(new FormData(formMobile));
		});
	});
</script>


		<div id = "main-content">
			<div class="post-header">
				<h1 class="title">Single Message Transformations - The Swiss Army Knife of Kafka Connect</h1>
				<div class="meta">Posted at May 14, 2020</div>
			</div>

			<div class="post-content">
				<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_format_conversions">Format Conversions</a></li>
<li><a href="#_ensuring_backwards_compatibility">Ensuring Backwards Compatibility</a></li>
<li><a href="#_filtering_and_routing">Filtering and Routing</a></li>
<li><a href="#_tombstone_handling">Tombstone Handling</a></li>
<li><a href="#_externalizing_large_payloads">Externalizing Large Payloads</a></li>
<li><a href="#_limitations">Limitations</a></li>
<li><a href="#_learning_more">Learning More</a></li>
</ul>
</div>
<div class="paragraph">
<p>Do you remember Angus &#34;Mac&#34; MacGyver?
The always creative protagonist of the popular 80ies/90ies TV show, who could solve about any problem with nothing more than a Swiss Army knife, duct tape, shoe strings and a paper clip?</p>
</div>
<div class="paragraph">
<p>The single message transformations (SMTs) of Kafka Connect are almost as versatile as MacGyverâ€™s Swiss Army knife:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How to change the timezone or format of date/time message fields?</p>
</li>
<li>
<p>How to change the topic a specific message gets sent to?</p>
</li>
<li>
<p>How to filter out specific records?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>SMTs can be the answer to these and many other questions that come up in the context of Kafka Connect.
Applied to source or sink connectors,
SMTs allow to modify Kafka records before they are sent to Kafka, or after they are consumed from a topic, respectively.</p>
</div>
<div class="paragraph">
<p>In this post Iâ€™d like to focus on some interesting (hopefully anyways) usages of SMTs.
Those use cases are mostly based on my experiences from using Kafka Connect with <a href="https://debezium.io/">Debezium</a>, an open-source platform for change data capture (CDC).
I also got some great pointers on interesting SMT usages when <a href="https://twitter.com/gunnarmorling/status/1253005581071405056">asking the community</a> about this on Twitter some time ago:</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="https://twitter.com/gunnarmorling/status/1253005581071405056"><img src="/images/kafka_connect_smt_tweet.png" alt="kafka connect smt tweet" width="500"/></a>
</div>
</div>
<div class="paragraph">
<p>I definitely recommend to check out the thread; thanks a lot to all who replied!
In order to learn more about SMTs in general, how to configure them etc., refer to the resources given towards the end of this post.</p>
</div>
<div class="paragraph">
<p>For each category of use cases, Iâ€™ve also asked our sympathetic TV hero for his opinion on the usefulness of SMTs for the task at hand.
You can find his rating at the end of each section,
ranging from ðŸ“Ž (poor fit) to ðŸ“ŽðŸ“ŽðŸ“ŽðŸ“ŽðŸ“Ž (perfect fit).</p>
</div>
<div class="sect1">
<h2 id="_format_conversions">Format Conversions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Probably the most common application of SMTs is format conversion,
i.e. adjustments to type, format and representation of data.
This may apply to entire messages, or to specific message attributes.
Letâ€™s first look at a few examples for converting individual message attribute formats:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Timestamps:</strong> Different systems tend to have different assumptions of how timestamps should be typed and formatted.
Debezium for instance represents most temporal column types as milli-seconds since epoch.
Change event consumers on the other hand might expect such date and time values using Kafka Connectâ€™s <code>Date</code> type, or as an ISO-8601 formatted string, potentially using a specific timezone</p>
</li>
<li>
<p><strong>Value masking:</strong> Sensitive data might have be to masked or truncated, or specific fields should even be removed altogether; the <code>org.apache.kafka.connect.transforms.MaskField</code> and <code>ReplaceField</code> SMTs <a href="https://kafka.apache.org/documentation/#connect_transforms">shipping with Kafka Connect</a> out of the box come in handy for that</p>
</li>
<li>
<p><strong>Numeric types:</strong> Similar to timestamps, requirements around the representation of (decimal) numbers may differ between systems; e.g. Kafka Connectâ€™s <code>Decimal</code> type allows to convey arbitrary-precision decimals, but its binary representation of numbers might not be supported by all sink connectors and consumers</p>
</li>
<li>
<p><strong>Name adjustments:</strong> Depending on the chosen serialization formats, specific field names might be unsupported; when working with <a href="https://avro.apache.org/">Apache Avro</a> for instance, field names must not start with a number</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In all these cases, either existing, ready-made SMTs or bespoke implementations can be used to apply the required attribute type and/or format conversions.</p>
</div>
<div class="paragraph">
<p>When using Kafka Connect for integrating legacy services and databases with newly built microservices, such format conversions can play an important role for creating an <em>anti-corruption layer</em>: by using better field names, choosing more suitable data types or by removing unneeded fields, SMTs can help to shield a new serviceâ€™s model from the oddities and quirks of the legacy world.</p>
</div>
<div class="paragraph">
<p>But SMTs cannot only modify the representation of single fields, also the format and structure of entire messages can be adjusted.
E.g. Kafka Connectâ€™s <code>ExtractField</code> transformation allows to extract a single field from a message and propagate that one.
A related SMT is Debeziumâ€™s SMT for <a href="https://debezium.io/documentation/reference/configuration/event-flattening.html">change event flattening</a>.
It can be used to convert the complex Debezium change event structure with old and new row state, metadata and more, into a flat row representation, which can be consumed by many existing sink connectors.</p>
</div>
<div class="paragraph">
<p>SMTs also allow to fine-tune schema namespaces; that can be of interest when working with a schema registry for managing schemas and their versions, and specific schema namespaces should be enforced for the messages on given topics.
Two more, very useful examples of SMTs in this category are <a href="https://github.com/jcustenborder/kafka-connect-transform-xml">kafka-connect-transform-xml</a> and <a href="https://github.com/jcustenborder/kafka-connect-json-schema">kafka-connect-json-schema</a> by Jeremy Custenborder, which will take XML or text and produce a typed Kafka Connect <code>Struct</code>,
based on a given XML schema or JSON schema, respectively.</p>
</div>
<div class="paragraph">
<p>Lastly, as a special kind of format conversion, SMTs can be used to modify or set the key of Kafka records.
This may be desirable if a source connector doesnâ€™t produce any meaningful key, but one can be extracted from the record value.
Also <em>changing</em> the message key can be useful, when considering subsequent stream processing.
Choosing matching keys right at the source side e.g. allows for joining multiple topics via Kafka Streams, without the need for re-keying records.</p>
</div>
<div class="paragraph">
<p><em>Macâ€™s rating:</em> Â Â  ðŸ“ŽðŸ“ŽðŸ“ŽðŸ“ŽðŸ“ŽÂ Â  <em>SMTs are the perfect tool for format conversions of Kafka Connect records</em></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ensuring_backwards_compatibility">Ensuring Backwards Compatibility</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Changes to the schema of Kafka records can potentially be disruptive for consumers.
If for instance a record field gets renamed, a consumer must be adapted accordingly,
reading the value using the new field name.
In case a field gets dropped altogether, consumers must not expect this field any longer.</p>
</div>
<div class="paragraph">
<p>Message transformations can help with such transition from one schema version to the next,
thus reducing the coupling of the lifecycles of message producers and consumers.
In case of a renamed field, an SMT could add the field another time, using the original name.
Thatâ€™ll allow consumers to continue reading the field using the old name and to be upgraded to use the new name at their own pace.
After some time, once all consumers have been adjusted, the SMT can be removed again,
only exposing the new field name going forward.
Similarly, a field that got removed from a message schema could be re-added,
e.g. using some sort of constant placeholder value.
In other cases it might be possible to derive the field value from other, still existing fields.
Again consumers could then be updated at their own pace to not expect and access that field any longer.</p>
</div>
<div class="paragraph">
<p>It should be said though that there are limits for this usage: e.g. when changing the type of a field, things quickly become tricky.
One option could be a multi-step approach where at first a separate field with the new type is added, before renaming it again as described above.</p>
</div>
<div class="paragraph">
<p><em>Macâ€™s rating:</em> Â Â  ðŸ“ŽðŸ“ŽðŸ“ŽÂ Â  <em>SMTs can primarily help to address basic compatibility concerns around schema evolution</em></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_filtering_and_routing">Filtering and Routing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When applied on the source side,
SMTs allow to filter out specific records produced by the connector.
They also can be used for controlling the Kafka topic a record gets sent to.
Thatâ€™s in particular interesting when filtering and routing is based on the actual record contents.
In an IoT scenario for instance where Kafka Connect is used to ingest data from some kind of sensors,
an SMT might be used to filter out all sensor measurements <em>below</em> a certain threshold, or route measurement events <em>above</em> a threshold to a special topic.</p>
</div>
<div class="paragraph">
<p>Debezium  provides a range of SMTs for record filtering and routing:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <a href="https://debezium.io/documentation/reference/configuration/topic-routing.html">logical topic routing SMT</a> allows to send change events originating from multiple tables to the same Kafka topic,
which can be useful when working with partition tables in Postgres, or with data that is sharded into multiple tables</p>
</li>
<li>
<p>The <a href="https://debezium.io/documentation/reference/1.2/configuration/filtering.html"><code>Filter</code></a> and <a href="https://debezium.io/documentation/reference/1.2/configuration/content-based-routing.html"><code>ContentBasedRouter</code></a> SMTs let you use script expressions in languages such as Groovy or JavaScript for filtering and routing change events based on their contents;
such script-based approach can be an interesting middleground between ease-of-use (no Java code must be compiled and deployed to Kafka Connect) and expressiveness; e.g. here is how the routing SMT could be used with <a href="https://github.com/graalvm/graaljs">GraalVMâ€™s JavaScript engine</a> for routing change events from a table with purchase orders to different topics in Kafka, based on the order type:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre>...
transforms=route
transforms.route.type=io.debezium.transforms.ContentBasedRouter
transforms.route.topic.regex=.*purchaseorders
transforms.route.language=jsr223.graal.js
transforms.route.topic.expression=
    value.after.ordertype == &#39;B2B&#39; ? &#39;b2b_orders&#39; : &#39;b2c_orders&#39;
...
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</li>
<li>
<p>The <a href="https://debezium.io/documentation/reference/configuration/outbox-event-router.html">outbox event router</a> comes in handy when implementing the <a href="https://microservices.io/patterns/data/transactional-outbox.html">transactional outbox pattern</a> for data propagation between microservices: it can be used to send events originating from a single outbox table to a specific Kafka topic per aggregate (when thinking of domain driven design) or event type</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are also two SMTs for routing purposes in Kafka Connect <a href="https://kafka.apache.org/documentation/#connect_transforms">itself</a>: <code>RegexRouter</code> which allows to re-route records two different topics based on regular expressions, and <code>TimestampRouter</code> for determining topic names based on the recordâ€™s timestamp.</p>
</div>
<div class="paragraph">
<p>While routing SMTs usually are applied to source connectors
(defining the Kafka topic a record gets sent to),
it can also make sense to use them with sink connectors.
Thatâ€™s the case when a sink connector derives the name of downstream table names, index names or similar from the topic name.</p>
</div>
<div class="paragraph">
<p><em>Macâ€™s rating:</em> Â Â  ðŸ“ŽðŸ“ŽðŸ“ŽðŸ“ŽðŸ“ŽÂ Â  <em>Message filtering and topic routingâ€‰â€”â€‰no problem for SMTs</em></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tombstone_handling">Tombstone Handling</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Tombstone records are Kafka records with a <code>null</code> value.
They carry special semantics when working with <a href="https://kafka.apache.org/documentation/#compaction">compacted topics</a>:
during log compaction, all records with the same key as a tombstone record will be removed from the topic.</p>
</div>
<div class="paragraph">
<p>Tombstones will be retained on a topic for a configurable time before compaction happens (controlled via <a href="https://kafka.apache.org/documentation/#delete.retention.ms"><code>delete.retention.ms</code></a> topic setting),
which means that also Kafka Connect sink connectors need to handle them.
Unfortunately though, not all connectors are prepared for records with a <code>null</code> value,
typically resulting in <code>NullPointerException</code>s and similar.
A filtering SMT such as the one above can be used to drop tombstone records in such case.</p>
</div>
<div class="paragraph">
<p>But also the exact oppositeâ€‰â€”â€‰producing tombstone recordsâ€‰â€”â€‰can be useful:
some sink connectors use tombstone records as the indicator to delete corresponding rows from a downstream datastore.
Now when using a CDC connector like Debezium to capture changes from a database where &#34;soft deletes&#34; are used (i.e. records are not physically deleted, but a logically deleted flag is set to <code>true</code> when deleting a record), those change events will be exported as update events (which they technically are).
A bespoke SMT can be used to translate these update events into tombstone records, triggering the deletion of corresponding records in downstream datastores.</p>
</div>
<div class="paragraph">
<p><em>Macâ€™s rating:</em> Â Â  ðŸ“ŽðŸ“ŽðŸ“ŽðŸ“ŽÂ Â  <em>SMTs work well to discard tombstones or convert soft delete events into tombstones. Whatâ€™s not possible though is to keep the original event and produce an additional tombstone record at the same time</em></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_externalizing_large_payloads">Externalizing Large Payloads</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Even some advanced <a href="https://www.enterpriseintegrationpatterns.com/">enterprise application patterns</a> can be implemented with the help of SMTs, one example being the <a href="https://www.enterpriseintegrationpatterns.com/patterns/messaging/StoreInLibrary.html">claim check pattern</a>.
This pattern comes in handy in situations like this:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>A message may contain a set of data items that may be needed later in the message flow, but that are not necessary for all intermediate processing steps. We may not want to carry all this information through each processing step because it may cause performance degradation and makes debugging harder because we carry so much extra data.</p>
</div>
<div class="paragraph">
<p>â€‰â€”â€‰Gregor Hohpe, Bobby Woolf; Enterprise Application Patterns</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>A specific example could again be a CDC connector that captures changes from a database table <code>Users</code>, with a BLOB column that contains the userâ€™s profile picture
(surely not a best practice, still not that uncommon in realityâ€¦â€‹).</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Apache Kafka and Large Messages</div>
<div class="paragraph">
<p>Apache Kafka isnâ€™t meant for large messages.
The maximum message size is 1 MB by default, and while this can be increased,
benchmarks are showing best throughput for much smaller messages.
Strategies like <a href="https://medium.com/workday-engineering/large-message-handling-with-kafka-chunking-vs-external-store-33b0fc4ccf14">chunking and externalizing</a> large payloads can thus be vital in order to ensure a satisfying performance.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>When propagating change data events from that table to Apache Kafka,
adding the picture data to each event poses a significant overhead.
In particular, if the picture BLOB hasnâ€™t changed between two events at all.</p>
</div>
<div class="paragraph">
<p>Using an SMT, the BLOB data could be externalized to some other storage.
On the source side, the SMT could extract the image data from the original record and e.g. write it to a network file system or an Amazon S3 bucket.
The corresponding field in the record would be updated so it just contains the unique address of the externalised payload, such as the S3 bucket name and file path:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/kafka_connect_smt_claimcheck_pattern.png" alt="kafka connect smt claimcheck pattern"/>
</div>
</div>
<div class="paragraph">
<p>As an optimization, it could be avoided to re-upload unchanged file contents another time by comparing earlier and current hash of the externalized file.</p>
</div>
<div class="paragraph">
<p>A corresponding SMT instance applied to sink connectors would retrieve the identifier of the externalized files from the incoming record, obtain the contents from the external storage and put it back into the record before passing it on to the connector.</p>
</div>
<div class="paragraph">
<p><em>Macâ€™s rating:</em> Â Â  ðŸ“ŽðŸ“ŽðŸ“ŽðŸ“ŽÂ Â  <em>SMTs can help to externalize payloads, avoiding large Kafka records. Relying on another service increases overall complexity, though</em></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_limitations">Limitations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As weâ€™ve seen, single message transformations can help to address quite a few requirements that commonly come up for users of Kafka Connect.
But there are limitations, too;
Like MacGyver, who sometimes has to reach for some other tool than his beloved Swiss Army knife, you shouldnâ€™t think of SMTs as the perfect solution all the time.</p>
</div>
<div class="paragraph">
<p>The biggest shortcoming is already hinted at in their name:
SMTs only can be used to process <em>single</em> records, one at a time.
E.g. you cannot split up a record into multiple ones using an SMT, as they only can return (at most) one record.
Also any kind of stateful processing, like aggregating data from multiple records, or correlating records from several topics is off limits for SMTs.
For such use cases, you should be looking at stream processing technologies like <a href="https://kafka.apache.org/25/documentation/streams/developer-guide/">Kafka Streams</a> and <a href="https://flink.apache.org/">Apache Flink</a>; also integration technologies like <a href="https://camel.apache.org/">Apache Camel</a> can be of great use here.</p>
</div>
<div class="paragraph">
<p>One thing to be aware of when working with SMTs is configuration complexity;
when using generic, highly configurable SMTs, you might end up with lengthy configuration thatâ€™s hard to grasp and debug.
You might be better off implementing a bespoke SMT which is focussing on one particular task, leveraging the full capabilities of the Java programming language.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">SMT Testing</div>
<div class="paragraph">
<p>Whether you use ready-made SMTs by means of configuration, or you implement custom SMTs in Java,
testing your work is essential.</p>
</div>
<div class="paragraph">
<p>While unit tests are a viable option for basic testing of bespoke SMT implementations,
integration tests running against Kafka Connect connectors are recommended for testing SMT configurations.
That way youâ€™ll be sure that the SMT can process actual messages and it has been configured the way you intended to.</p>
</div>
<div class="paragraph">
<p>Testcontainers and the Debezium <a href="https://debezium.io/documentation/reference/integrations/testcontainers.html">support for Testcontainers</a> are a great foundation for setting up all the required components such as Apache Kafka, Kafka Connect, connectors and the SMTs to test.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>A specific feature I wished for every now and then is the ability to apply SMTs only to a specific sub-set of the topics created or consumed by a connector.
In particular if connectors create different kinds of topics (like an actual data topic and another one with with metadata),
it can be desirable to apply SMTs only to the topics of one group but not the other.
This requirement is captured in <a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-585%3A+Filter+and+Conditional+SMTs">KIP-585</a> (&#34;Filter and Conditional SMTs&#34;),
please join the discussion on that one if you got requirements or feedback related to that.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_learning_more">Learning More</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are several great presentations and blog posts out there which describe in depth what SMTs are,
how you can implement your own one,
how they are configured etc.</p>
</div>
<div class="paragraph">
<p>Here are a few resources I found particularly helpful:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-66%3A+Single+Message+Transforms+for+Kafka+Connect">KIP-66</a>: The original KIP (Kafka Improvement Proposal) that introduced SMTs</p>
</li>
<li>
<p><a href="https://www.slideshare.net/ConfluentInc/kafka-summit-nyc-2017-singe-message-transforms-are-not-the-transformations-youre-looking-for">Singe Message Transforms are not the Transformations Youâ€™re Looking For</a>: A great overview on SMTs, their capabilities as well as limitations, by Ewen Cheslack-Postava</p>
</li>
<li>
<p><a href="https://medium.com/credimi-tech-blog/an-on-the-field-experience-with-kafka-connect-smts-45b170cbb5fa">A hands-on experience with Kafka Connect SMTs</a>: In-depth blog post on SMT use cases, things to be aware of and more, by Gian Dâ€™Uia</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now, considering this wide range of use cases for SMTs, would MacGyver like and use them for implementing various tasks around Kafka Connect?
I would certainly think so.
But as always, the right tool for the job must be chosen: sometimes an SMT may be a great fit, another time a more flexible (and complex) stream processing solution might be preferable.</p>
</div>
<div class="paragraph">
<p>Just as MacGyver, you got to make a call when to use your Swiss Army knife, duct tape or a paper clip.</p>
</div>
<div class="paragraph">
<p><em>Many thanks to <a href="https://twitter.com/hpgrahsl">Hans-Peter Grahsl</a> for his feedback while writing this blog post!</em></p>
</div>
</div>
</div>
			</div>

			<div class="post-tags">
				
					
				
			</div>
		</div>

		<div class="post-footer">
			<div style="display: flex; align-items: center; gap: 1rem;">
				<div class="header-image-container" style="flex-shrink: 0;">
					<img class="footer-image" src="/images/gunnar_morling.jpg" alt="Gunnar Morling">
				</div>
				<p style="margin: 0;">Gunnar Morling is an open-source software engineer in the Java and data streaming space. He currently works as a Technologist for Confluent. In his past role at Decodable he focused on developer outreach and helped them build their stream processing platform based on Apache Flink. Prior to that, he spent ten years at Red Hat, where he led the Debezium project, a platform for change data capture.</p>
			</div>
		</div>

		
		
		<div class="post-discussions">
			<p>Comment below or join the discussion on
			<a href="https://hn.algolia.com/?query=morling.dev/blog/single-message-transforms-swiss-army-knife-of-kafka-connect/">Hacker News</a>,
			<a href="https://lobste.rs/search?q=domain:morling.dev+title:%22Single%20Message%20Transformations%20-%20The%20Swiss%20Army%20Knife%20of%20Kafka%20Connect%22&what=stories">Lobsters</a>, and
			<a href="https://www.reddit.com/search/?q=url:morling.dev/blog/single-message-transforms-swiss-army-knife-of-kafka-connect/">Reddit</a>.
			</p>
		</div>
		<div id="disqus_thread"></div>

<script>
  
  window.addEventListener('load', function() {
    
    setTimeout(function() {
      const commentsContainer = document.getElementById('disqus_thread');
      const script = document.createElement('script');
      script.src = 'https://giscus.app/client.js';
      script.setAttribute('data-repo', 'gunnarmorling/discussions.morling.dev');
      script.setAttribute('data-repo-id', 'R_kgDOGXzqNQ');
      script.setAttribute('data-category', 'Announcements');
      script.setAttribute('data-category-id', 'DIC_kwDOGXzqNc4B_2Pq');
      script.setAttribute('data-mapping', 'title');
      script.setAttribute('data-reactions-enabled', '1');
      script.setAttribute('data-emit-metadata', '0');
      script.setAttribute('data-theme', 'light');
      script.setAttribute('data-lang', 'en');
      script.setAttribute('crossorigin', 'anonymous');
      script.async = true;
      commentsContainer.appendChild(script);
    }, 100);
  });
</script>

<noscript>Please enable JavaScript, or join the <a href="https://github.com/gunnarmorling/discussions.morling.dev/discussions/">discussion on GitHub</a>.</noscript>
</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> Â© 2019 - 2025 Gunnar Morling |  Licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons BY-SA 4.0</a> | <a href="/ai">How I use (and don't use) AI</a></div>
	</nav>
</div><script>
	mediumZoom(document.querySelectorAll('div.imageblock > div.content > img'))
</script>

</body>
</html>
