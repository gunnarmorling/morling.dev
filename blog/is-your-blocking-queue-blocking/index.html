<!DOCTYPE html>
<html>
<head>
	
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-DD997656SV"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'G-DD997656SV');
	</script>

	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Is your Blocking Queue... Blocking? - Gunnar Morling</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Is your Blocking Queue... Blocking?" />
<meta property="og:description" content="
Java’s BlockingQueue hierarchy is widely used for coordinating work between different producer and consumer threads.
When set up with a maximum capacity (i.e. a bounded queue), no more elements can be added by producers to the queue once it is full, until a consumer has taken at least one element.
For scenarios where new work may arrive more quickly than it can be consumed, this applies means of back-pressure,
ensuring the application doesn’t run out of memory eventually, while enqueuing more and more work items.
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.morling.dev/blog/is-your-blocking-queue-blocking/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2023-01-03T22:10:00+01:00" />
<meta property="article:modified_time" content="2023-01-03T22:10:00+01:00" />

<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Is your Blocking Queue... Blocking?"/>
<meta name="twitter:description" content="
Java’s BlockingQueue hierarchy is widely used for coordinating work between different producer and consumer threads.
When set up with a maximum capacity (i.e. a bounded queue), no more elements can be added by producers to the queue once it is full, until a consumer has taken at least one element.
For scenarios where new work may arrive more quickly than it can be consumed, this applies means of back-pressure,
ensuring the application doesn’t run out of memory eventually, while enqueuing more and more work items.
"/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel="stylesheet" />
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" />
 
	<link rel="stylesheet" type="text/css" media="screen" href="https://www.morling.dev/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://www.morling.dev/css/main.css" />

	
	<link rel="stylesheet" type="text/css" href="https://www.morling.dev/css/base16.dark.css" />
	
	<link rel="stylesheet" type="text/css" href="https://www.morling.dev/css/morlingdev.css" />
	

	<script>
		const searchUrl = "https:\/\/search-morling-dev.onrender.com\/";
		const apiKey = "ff90d45f4afad3bd914c";
	</script>

	<script src="https://www.morling.dev//js/main.js"></script>
	<script src="https://www.morling.dev//js/medium-zoom.min.js"></script>

	<noscript>
		<style type="text/css">
			.club { display:none; }
		</style>
	</noscript>
</head>

<body>
	<div class="container wrapper post">
		<div class="header desktop">

	<div class="row">
		<div class="header-image-container">
			<img class="header-image" src="/images/gunnar_morling.jpg" alt="Gunnar Morling">
		</div>
		<div class="fill">
			<h1 class="site-title"><a href="https://www.morling.dev/">Gunnar Morling</a></h1>
			<div class="site-description"><h2>Random Musings on All Things Software Engineering</h2></div>

			<nav class="row pre-nav">
				<div class="pull-right">
					<ul class="flat"><li>
							<a href="/blog/index.xml" title="RSS FEED">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#rss"/>
								</svg>
							</a>
						</li><li>
							<a href="https://github.com/gunnarmorling" title="GitHub">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#github"/>
								</svg>
							</a>
						</li><li>
							<a href="https://bsky.app/profile/gunnarmorling.dev" title="Bluesky">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#cloud"/>
								</svg>
							</a>
						</li><li>
							<a href="https://twitter.com/gunnarmorling" title="Twitter">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#twitter"/>
								</svg>
							</a>
						</li><li>
							<a href="https://www.linkedin.com/in/gunnar-morling/" title="LinkedIn">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#linkedin"/>
								</svg>
							</a>
						</li><li>
							<a href="https://mastodon.online/@gunnarmorling" title="Mastodon">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#message-square"/>
								</svg>
							</a>
						</li></ul>
				</div>
			</nav>
			<nav class="row nav">
				<div>
					<ul class="flat">
						
						<li>
							<a href="/">Blog</a>
						</li>
						
						<li>
							<a href="/projects/">Projects</a>
						</li>
						
						<li>
							<a href="/conferences/">Conferences</a>
						</li>
						
						<li>
							<a href="/podcasts/">Podcasts</a>
						</li>
						
						<li>
							<a href="/about/">About</a>
						</li>
						
					</ul>
				</div>
				<div class="pull-right">
					<div class="club">
						<form id="myForm">
							<input type="text" id="inputSearch" name="q" placeholder="Search..." onfocus="warmUp(this)">
							<button type="submit" id="buttonSubmitSearch" style="line-height: normal;"><i id="iconSearch" class="fa fa-search"></i></button>
						</form>
					</div>
				</div>
			</nav>
		</div>
	</div>
</div>

<div class="header mobile">

	<div class="row">
		<div class="header-image-container">
			<img class="header-image" src="/images/gunnar_morling.jpg" alt="Gunnar Morling">
		</div>
		<div class="fill">
			<h1 class="site-title"><a href="https://www.morling.dev/">Gunnar Morling</a></h1>
			<div class="site-description"><h2>Random Musings on All Things Software Engineering</h2></div>
		</div>
	</div>
	<div>
		<div>
			<nav class="row pre-nav">
				<div class="pull-right">
					<ul class="flat"><li>
							<a href="/blog/index.xml" title="RSS FEED">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#rss"/>
								</svg>
							</a>
						</li><li>
							<a href="https://github.com/gunnarmorling" title="GitHub">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#github"/>
								</svg>
							</a>
						</li><li>
							<a href="https://bsky.app/profile/gunnarmorling.dev" title="Bluesky">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#cloud"/>
								</svg>
							</a>
						</li><li>
							<a href="https://twitter.com/gunnarmorling" title="Twitter">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#twitter"/>
								</svg>
							</a>
						</li><li>
							<a href="https://www.linkedin.com/in/gunnar-morling/" title="LinkedIn">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#linkedin"/>
								</svg>
							</a>
						</li><li>
							<a href="https://mastodon.online/@gunnarmorling" title="Mastodon">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#message-square"/>
								</svg>
							</a>
						</li></ul>
				</div>
			</nav>
			<nav class="row nav">
				<div>
					<ul class="flat">
						
						<li>
							<a href="/">Blog</a>
						</li>
						
						<li>
							<a href="/projects/">Projects</a>
						</li>
						
						<li>
							<a href="/conferences/">Conferences</a>
						</li>
						
						<li>
							<a href="/podcasts/">Podcasts</a>
						</li>
						
						<li>
							<a href="/about/">About</a>
						</li>
						
					</ul>
				</div>
				<div class="pull-right">
					<div class="club">
						<form id="myFormMobile">
							<input type="text" id="inputSearchMobile" name="q" placeholder="Search..." onfocus="warmUp(this)">
							<button type="submit" id="buttonSubmitSearchMobile" style="line-height: normal;"><i id="iconSearchMobile" class="fa fa-search"></i></button>
						</form>
					</div>
				</div>
			</nav>
		</div>
	</div>
</div>

<script type="text/javascript">
	window.addEventListener( "load", function () {
		const urlParams = new URLSearchParams(window.location.search);

		


		const form = document.getElementById( "myForm" );

		form.addEventListener("submit", function (event) {
			event.preventDefault();
			sendData(new FormData(form));
		});

		const formMobile = document.getElementById( "myFormMobile" );

		formMobile.addEventListener("submit", function (event) {
			event.preventDefault();
			sendData(new FormData(formMobile));
		});
	});
</script>


		<div id = "main-content">
			<div class="post-header">
				<h1 class="title">Is your Blocking Queue... Blocking?</h1>
				<div class="meta">Posted at Jan 3, 2023</div>
			</div>

			<div class="markdown">
				<div class="paragraph">
<p>Java’s <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/BlockingQueue.html"><code>BlockingQueue</code></a> hierarchy is widely used for coordinating work between different producer and consumer threads.
When set up with a maximum capacity (i.e. a <em>bounded queue</em>), no more elements can be added by producers to the queue once it is full, until a consumer has taken at least one element.
For scenarios where new work may arrive more quickly than it can be consumed, this applies means of back-pressure,
ensuring the application doesn’t run out of memory eventually, while enqueuing more and more work items.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>One interesting usage of blocking queues is to buffer writes to a database.
Let’s take <a href="https://www.sqlite.org/index.html">SQLite</a>, an embedded RDBMS, as an example;
SQLite only allows for a single writer at any given time,
and it tends to yield a sub-optimal write through-put when executing many small transactions.</p>
</div>
<div class="paragraph">
<p>A blocking queue can be used to mitigate that situation:
all threads that wish to perform an update to the database,
for instance the worker threads of a web application,
submit work items with their write tasks to a blocking queue.
Another thread fetches items in batches from that queue,
executing one single transaction for all work items of a batch.</p>
</div>
<div class="paragraph">
<p>This results in a much better performance compared to each thread executing its own individual write transaction,
in particular when keeping those open for the entire duration of web requests,
as it’s commonly the case with most web frameworks.
More on that architecture, in particular in regards to failure handling, in a future blog post.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>How do you find out though when a producer actually is blocked while trying to add items to a <code>BlockingQueue</code>?
After all, this is an indicator that the through-put of your system isn’t as high as it would need to be in order to fully satisfy the workload submitted by the producers.</p>
</div>
<div class="paragraph">
<p>If you have the means of running a profiler against the system,
then for instance <a href="https://github.com/jvm-profiling-tools/async-profiler">async-profiler</a> with its <a href="https://krzysztofslusarski.github.io/2022/12/12/async-manual.html#wall">wall-clock profiling option</a> will come in handy for this task;
unlike CPU profiling which only profiles running threads,
wall-clock profiling will also tell you about the time spent by threads in blocked and waiting states,
as is the case here.</p>
</div>
<div class="paragraph">
<p>But what when connecting with a wall-clock profiler is not an option?
In this case, <a href="https://openjdk.org/jeps/328">JDK Flight Recorder</a>, Java’s go-to tool for all kinds of performance analyses,
and its accompanying client, JDK Mission Control (JMC),
can be of help to you.
JFR specifically has been designed as an &#34;always-on&#34; event recording engine for usage in production environment.
It doesn’t provide bespoke support for identifying blocked queue producers, though.
<code>BlockingQueue</code> implementations such as <code>ArrayBlockingQueue</code> don’t use Java intrinsic locks
(i.e. what you’d get when using the <code>synchronized</code> keyword),
but rather locks based on the <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/locks/LockSupport.html"><code>LockSupport</code></a> primitives.
These <a href="https://bugs.openjdk.org/browse/JMC-3619">don’t show up</a> in the &#34;Lock Instances&#34; view in JMC at this point.</p>
</div>
<div class="sect1">
<h2 id="_emitting_custom_events">Emitting Custom Events</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One possible solution is to emit <a href="/blog/rest-api-monitoring-with-custom-jdk-flight-recorder-events/">custom JFR events</a> from within your own code whenever you’re trying to submit an item to a bounded queue at its maximum capacity.
For this, you couldn’t use the <code>put()</code> method of the <code>BlockingQueue</code> interface, though,
as it actually is blocking and you’d have no way to react to that.</p>
</div>
<div class="paragraph">
<p>Instead, you’d have to rely on either <code>offer()</code> (which returns <code>false</code> when it cannot submit an item) or <code>add()</code> (which raises an exception).
When the queue is full and you can’t submit another item, you’d instantiate your custom JFR event type, retry to submit the item for as long as it’s needed,
and finally commit the JFR event.
Needless to say that this kind of busy waiting is not only rather inefficient,
you’d also have to remember to implement this pattern in all your blocking queue producers of your program.</p>
</div>
<div class="paragraph">
<p>A better option, at least in theory, would be to use the <a href="https://github.com/openjdk/jmc/blob/master/agent/README.md">JMC Agent</a>.
Part of the JDK Mission Control project, this Java agent allows you to instrument the byte code of existing methods,
so that a JFR event will be emitted whenever they are invoked.
The configuration of JMC Agent happens via an XML file and is rather straightforward.
Here’s how instrumenting the <code>put()</code> method of the <code>ArrayBlockingQueue</code> type would look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="code"><pre><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span class="nt">&lt;jfragent&gt;</span>
  <span class="nt">&lt;config&gt;</span>
    <span class="nt">&lt;classprefix&gt;</span>__JFREvent<span class="nt">&lt;/classprefix&gt;</span>
    <span class="nt">&lt;allowtostring&gt;</span>true<span class="nt">&lt;/allowtostring&gt;</span>
    <span class="nt">&lt;allowconverter&gt;</span>true<span class="nt">&lt;/allowconverter&gt;</span>
  <span class="nt">&lt;/config&gt;</span>

  <span class="nt">&lt;events&gt;</span>
    <span class="nt">&lt;event</span> <span class="na">id=</span><span class="s">&#34;queue.Put&#34;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;label&gt;</span>Put<span class="nt">&lt;/label&gt;</span>
      <span class="nt">&lt;description&gt;</span>Queue Put<span class="nt">&lt;/description&gt;</span>
      <span class="nt">&lt;path&gt;</span>Queues<span class="nt">&lt;/path&gt;</span>
      <span class="nt">&lt;stacktrace&gt;</span>true<span class="nt">&lt;/stacktrace&gt;</span>
      <span class="nt">&lt;class&gt;</span>java.util.concurrent.ArrayBlockingQueue<span class="nt">&lt;/class&gt;</span>
      <span class="nt">&lt;method&gt;</span>
        <span class="nt">&lt;name&gt;</span>put<span class="nt">&lt;/name&gt;</span>
        <span class="nt">&lt;descriptor&gt;</span>(Ljava/lang/Object;)V<span class="nt">&lt;/descriptor&gt;</span>
      <span class="nt">&lt;/method&gt;</span>
      <span class="nt">&lt;location&gt;</span>WRAP<span class="nt">&lt;/location&gt;</span>
    <span class="nt">&lt;/event&gt;</span>
  <span class="nt">&lt;/events&gt;</span>
<span class="nt">&lt;/jfragent&gt;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>With this agent configuration in place, you’d get an event for <em>every</em> invocation of <code>put()</code> though,
no matter whether it actually is blocking or not.
While you might be able to make some educated guess based on the duration of these events,
that’s not totally reliable.
For instance, you couldn’t be quite sure whether a &#34;long&#34; event actually is caused by blocking on the queue or by some GC activity.</p>
</div>
<div class="paragraph">
<p>So how about going one level deeper then?
If you look at the <a href="https://github.com/openjdk/jdk/blob/jdk-17%2B35/src/java.base/share/classes/java/util/concurrent/ArrayBlockingQueue.java#L370">implementation</a> of <code>ArrayBlockingQueue::put()</code>,
you’ll find that the actual blocking call happens through the <code>await()</code> method on the <code>notFull</code> <code>Condition</code> object.
You could use JMC Agent to instrument that <code>await()</code> method,
but this would give you events for <em>every</em> <code>Condition</code> instance,
also for those not used by <code>BlockingQueue</code> implementations.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_filtering_thread_park_events">Filtering &#34;Thread Park&#34; Events</h2>
<div class="sectionbody">
<div class="paragraph">
<p>But this finally hints us into the right direction:
<code>await()</code> is implemented on top of <a href="https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/locks/LockSupport.html#park()"><code>LockSupport::park()</code></a>,
and the JVM itself <a href="https://bestsolution-at.github.io/jfr-doc/openjdk-17.html#jdk.ThreadPark">emits a JFR event</a> whenever a thread is parked.
How to identify though those &#34;Java Thread Park&#34; events actually triggered by blocking on a queue?
If there only was a way to query and filter JFR events in a structured query language!</p>
</div>
<div class="paragraph">
<p>Turns out there is.
<a href="https://github.com/moditect/jfr-analytics">JFR Analytics</a> lets you do exactly that:
analysing JFR recording files using standard SQL.
I haven’t worked that much on this project over the last year,
but extending it for the use case at hand was easy enough.
By means of the new <code>HAS_MATCHING_FRAME()</code> function it becomes trivial to identify the relevant events.</p>
</div>
<div class="paragraph">
<p>JFR Analytics hasn’t been released to Maven Central yet, so you need to check out its source code and build it from source yourself.
You then can use the SQLLine command line interface for examining your recordings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre>java <span class="nt">--class-path</span> <span class="s2">&#34;target/lib/*:target/jfr-analytics-1.0.0-SNAPSHOT.jar&#34;</span> <span class="se">\</span>
  sqlline.SqlLine
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, within the CLI tool, &#34;connect&#34; to a recording file and change the output format to &#34;vertical&#34; for better readability of stack traces:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="n">sqlline</span><span class="o">&gt;</span> <span class="o">!</span><span class="k">connect</span> <span class="n">jdbc</span><span class="p">:</span><span class="n">calcite</span><span class="p">:</span><span class="n">schemaFactory</span><span class="o">=</span><span class="n">org</span><span class="p">.</span><span class="n">moditect</span><span class="p">.</span><span class="n">jfranalytics</span><span class="p">.</span><span class="n">JfrSchemaFactory</span><span class="p">;</span><span class="k">schema</span><span class="p">.</span><span class="n">file</span><span class="o">=</span><span class="n">path</span><span class="o">/</span><span class="k">to</span><span class="o">/</span><span class="k">lock</span><span class="o">-</span><span class="n">recording</span><span class="p">.</span><span class="n">jfr</span> <span class="n">dummy</span> <span class="n">dummy</span>
<span class="n">sqlline</span><span class="o">&gt;</span> <span class="o">!</span><span class="n">outputformat</span> <span class="n">vertical</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you need a recording file to play with, check out <a href="https://github.com/gunnarmorling/jfr-blocking-analysis">this example project</a>.
It has a very simple main class with two threads:
a producer thread which inserts 20 items per second to a blocking queue, and a consumer thread, which takes those items at a rate of ten items per second.
Once the queue’s capacity has been reached, the producer will regularly block, as it can only insert ten items per second instead of 20.
With JFR Analytics, the affected <code>put()</code> calls can be identified via the following query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="k">SELECT</span>
  <span class="nv">&#34;startTime&#34;</span><span class="p">,</span>
  <span class="nv">&#34;duration&#34;</span> <span class="o">/</span> <span class="mi">1000000</span> <span class="k">AS</span> <span class="nv">&#34;duration&#34;</span><span class="p">,</span>
  <span class="nv">&#34;eventThread&#34;</span><span class="p">,</span>
  <span class="n">TRUNCATE_STACKTRACE</span><span class="p">(</span><span class="nv">&#34;stackTrace&#34;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="k">as</span> <span class="nv">&#34;stack trace&#34;</span>
<span class="k">FROM</span> <span class="nv">&#34;jdk.ThreadPark&#34;</span>
<span class="k">WHERE</span>
  <span class="n">HAS_MATCHING_FRAME</span><span class="p">(</span><span class="nv">&#34;stackTrace&#34;</span><span class="p">,</span> <span class="s1">&#39;.*ArrayBlockingQueue</span><span class="se">\.</span><span class="s1">put.*&#39;</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà, the query returns exactly those thread park events emitted for any blocked <code>put()</code> call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="code"><pre>...
startTime    2023-01-02 18:42:57.594
duration     455
eventThread  pool-1-thread-1
stack trace  jdk.internal.misc.Unsafe.park(boolean, long)
java.util.concurrent.locks.LockSupport.park():371
java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionNode.block():506
java.util.concurrent.ForkJoinPool.unmanagedBlock(ForkJoinPool$ManagedBlocker):3744
java.util.concurrent.ForkJoinPool.managedBlock(ForkJoinPool$ManagedBlocker):3689
java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await():1625
java.util.concurrent.ArrayBlockingQueue.put(Object):370
dev.morling.demos.BlockingQueueExample$1.run():35

startTime    2023-01-02 18:42:58.097
duration     954
eventThread  pool-1-thread-1
stack trace  jdk.internal.misc.Unsafe.park(boolean, long)
java.util.concurrent.locks.LockSupport.park():371
java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionNode.block():506
java.util.concurrent.ForkJoinPool.unmanagedBlock(ForkJoinPool$ManagedBlocker):3744
java.util.concurrent.ForkJoinPool.managedBlock(ForkJoinPool$ManagedBlocker):3689
java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await():1625
java.util.concurrent.ArrayBlockingQueue.put(Object):370
dev.morling.demos.BlockingQueueExample$1.run():35
...
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note how the stack traces are truncated so you can see the immediate caller,
in this case the producer thread of the aforementioned example application.
One thing to be aware of is that JFR applies a minimum threshold for capturing thread park events:
20 ms with the <em>default</em> configuration and 10 ms with the <em>profile</em> configuration.
I.e. you would not know about any calls blocking shorter than that.
You can adjust the threshold in your JFR configuration, but be aware of the potential overhead.</p>
</div>
<div class="paragraph">
<p>Equipped with the information about any blocked invocations of <code>put()</code>, you now could take appropriate action;
depending on the specific workload and its characteristics,
you might for instance look into tuning your queue consumers,
add more of them (when not in a sequencer scenario as with SQLite above),
or maybe share the load across multiple machines.
You also might increase the size of the queue,
providing more wiggle room to accommodate short load spikes.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_towards_real_time_analysis_of_jfr_events">Towards Real-Time Analysis of JFR Events</h2>
<div class="sectionbody">
<div class="paragraph">
<p>All this happens after the fact though, through offline analysis of JFR recording files.
An alternative would be to run this kind of analysis in realtime on live JFR data.
The foundation for this is <a href="https://openjdk.org/jeps/349">JFR event streaming</a> which provides low-latency access to the JFR events of a running JVM.</p>
</div>
<div class="paragraph">
<p>Expanding JFR Analytics into this direction is one of my goals for this year:
complementing its current <em>pull query</em> capabilities (based on Apache Calcite) with <em>push queries</em>,
leveraging <a href="https://flink.apache.org/">Apache Flink</a> as a stream processing engine.
That way, blocked queue producers could trigger some kind of alert in a live production environment,
for instance raised when the overall duration of blocked calls exceeds a given threshold in a given time window,
indicating the need for intervention with a much lower delay than possible with offline analysis.</p>
</div>
<div class="paragraph">
<p>Taking things even further, streaming queries could even enable <em>predictive</em> analytics;
Flink’s <a href="https://nightlies.apache.org/flink/flink-docs-release-1.16/docs/dev/table/sql/queries/match_recognize/">pattern matching</a> capabilities and the <code>MATCH_RECOGNIZE</code> clause could be used for instance to identify specific sequences of events which indicate that a full garbage collection is going to happen very soon.
This information could be exposed via a health check,
signalling to the load balancer in front of a clustered web application that affected nodes should not receive any more requests for some time,
so as to shield users from long GC-induced response times.</p>
</div>
<div class="paragraph">
<p>If this sounds interesting to you, please let me know; I’d love to collaborate with the open-source community on this effort.</p>
</div>
<div class="paragraph">
<p><em>Many thanks to <a href="https://www.linkedin.com/in/richard-startin-a20798236/">Richard Startin</a> for his feedback while working on this post!</em></p>
</div>
</div>
</div>
			</div>

			<div class="post-tags">
				
					
				
			</div>
		</div><div id="disqus_thread">
  <script src="https://giscus.app/client.js"
    data-repo="gunnarmorling/discussions.morling.dev"
    data-repo-id="R_kgDOGXzqNQ"
    data-category="Announcements"
    data-category-id="DIC_kwDOGXzqNc4B_2Pq"
    data-mapping="title"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-theme="light"
    data-lang="en"
    crossorigin="anonymous"
    async>
  </script>
</div>

<noscript>Please enable JavaScript, or join the <a href="https://github.com/gunnarmorling/discussions.morling.dev/discussions/">discussion on GitHub</a>.</noscript>
</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> © 2019 - 2024 Gunnar Morling |  Licensed Under <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons BY-SA 4.0</a></div>
	</nav>
</div><script>
	mediumZoom(document.querySelectorAll('div.imageblock > div.content > img'))
</script>

</body>
</html>
