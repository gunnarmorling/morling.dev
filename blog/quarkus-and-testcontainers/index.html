<!DOCTYPE html>
<html>
<head>
	
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-DD997656SV"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'G-DD997656SV');
	</script>

	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Quarkus and Testcontainers - Gunnar Morling</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Quarkus and Testcontainers" />
<meta property="og:description" content="
The Testcontainers project is invaluable for spinning up containerized resources during your (JUnit) tests,
e.g. databases or Kafka clusters.


For users of JUnit 5, the project provides the @Testcontainers extension, which controls the lifecycle of containers used by a test.
When testing a Quarkus application though, this is at odds with Quarkus&#39; own @QuarkusTest extension;
it’s a recommended best practice to avoid fixed ports for any containers started by Testcontainers.
Instead, you should rely on Docker to automatically allocate random free ports.
This avoids conflicts between concurrently running tests,
e.g. amongst multiple Postgres containers,
started up by several parallel job runs in a CI environment, all trying to allocate Postgres&#39; default port 5432.
Obtaining the randomly assigned port and passing it into the Quarkus bootstrap process isn’t possible though when combining the two JUnit extensions.
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.morling.dev/blog/quarkus-and-testcontainers/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2020-11-28T17:45:00+01:00" />
<meta property="article:modified_time" content="2020-11-28T17:45:00+01:00" />

<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Quarkus and Testcontainers"/>
<meta name="twitter:description" content="
The Testcontainers project is invaluable for spinning up containerized resources during your (JUnit) tests,
e.g. databases or Kafka clusters.


For users of JUnit 5, the project provides the @Testcontainers extension, which controls the lifecycle of containers used by a test.
When testing a Quarkus application though, this is at odds with Quarkus&#39; own @QuarkusTest extension;
it’s a recommended best practice to avoid fixed ports for any containers started by Testcontainers.
Instead, you should rely on Docker to automatically allocate random free ports.
This avoids conflicts between concurrently running tests,
e.g. amongst multiple Postgres containers,
started up by several parallel job runs in a CI environment, all trying to allocate Postgres&#39; default port 5432.
Obtaining the randomly assigned port and passing it into the Quarkus bootstrap process isn’t possible though when combining the two JUnit extensions.
"/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel="stylesheet" />
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" />
 
	<link rel="stylesheet" type="text/css" media="screen" href="https://www.morling.dev/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://www.morling.dev/css/main.css" />

	
	<link rel="stylesheet" type="text/css" href="https://www.morling.dev/css/base16.dark.css" />
	
	<link rel="stylesheet" type="text/css" href="https://www.morling.dev/css/morlingdev.css" />
	

	<script>
		const searchUrl = "https:\/\/search-morling-dev.onrender.com\/";
		const apiKey = "ff90d45f4afad3bd914c";
	</script>

	<script src="https://www.morling.dev//js/main.js"></script>
	<script src="https://www.morling.dev//js/medium-zoom.min.js"></script>

	<noscript>
		<style type="text/css">
			.club { display:none; }
		</style>
	</noscript>
</head>

<body>
	<div class="container wrapper post">
		<div class="header desktop">

	<div class="row">
		<div class="header-image-container">
			<img class="header-image" src="/images/gunnar_morling.jpg" alt="Gunnar Morling">
		</div>
		<div class="fill">
			<h1 class="site-title"><a href="https://www.morling.dev/">Gunnar Morling</a></h1>
			<div class="site-description"><h2>Random Musings on All Things Software Engineering</h2></div>

			<nav class="row pre-nav">
				<div class="pull-right">
					<ul class="flat"><li>
							<a href="/blog/index.xml" title="RSS FEED">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#rss"/>
								</svg>
							</a>
						</li><li>
							<a href="https://github.com/gunnarmorling" title="GitHub">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#github"/>
								</svg>
							</a>
						</li><li>
							<a href="https://bsky.app/profile/gunnarmorling.dev" title="Bluesky">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#cloud"/>
								</svg>
							</a>
						</li><li>
							<a href="https://twitter.com/gunnarmorling" title="Twitter">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#twitter"/>
								</svg>
							</a>
						</li><li>
							<a href="https://www.linkedin.com/in/gunnar-morling/" title="LinkedIn">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#linkedin"/>
								</svg>
							</a>
						</li><li>
							<a href="https://mastodon.online/@gunnarmorling" title="Mastodon">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#message-square"/>
								</svg>
							</a>
						</li></ul>
				</div>
			</nav>
			<nav class="row nav">
				<div>
					<ul class="flat">
						
						<li>
							<a href="/">Blog</a>
						</li>
						
						<li>
							<a href="/projects/">Projects</a>
						</li>
						
						<li>
							<a href="/conferences/">Conferences</a>
						</li>
						
						<li>
							<a href="/podcasts/">Podcasts</a>
						</li>
						
						<li>
							<a href="/about/">About</a>
						</li>
						
					</ul>
				</div>
				<div class="pull-right">
					<div class="club">
						<form id="myForm">
							<input type="text" id="inputSearch" name="q" placeholder="Search..." onfocus="warmUp(this)">
							<button type="submit" id="buttonSubmitSearch" style="line-height: normal;"><i id="iconSearch" class="fa fa-search"></i></button>
						</form>
					</div>
				</div>
			</nav>
		</div>
	</div>
</div>

<div class="header mobile">

	<div class="row">
		<div class="header-image-container">
			<img class="header-image" src="/images/gunnar_morling.jpg" alt="Gunnar Morling">
		</div>
		<div class="fill">
			<h1 class="site-title"><a href="https://www.morling.dev/">Gunnar Morling</a></h1>
			<div class="site-description"><h2>Random Musings on All Things Software Engineering</h2></div>
		</div>
	</div>
	<div>
		<div>
			<nav class="row pre-nav">
				<div class="pull-right">
					<ul class="flat"><li>
							<a href="/blog/index.xml" title="RSS FEED">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#rss"/>
								</svg>
							</a>
						</li><li>
							<a href="https://github.com/gunnarmorling" title="GitHub">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#github"/>
								</svg>
							</a>
						</li><li>
							<a href="https://bsky.app/profile/gunnarmorling.dev" title="Bluesky">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#cloud"/>
								</svg>
							</a>
						</li><li>
							<a href="https://twitter.com/gunnarmorling" title="Twitter">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#twitter"/>
								</svg>
							</a>
						</li><li>
							<a href="https://www.linkedin.com/in/gunnar-morling/" title="LinkedIn">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#linkedin"/>
								</svg>
							</a>
						</li><li>
							<a href="https://mastodon.online/@gunnarmorling" title="Mastodon">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#message-square"/>
								</svg>
							</a>
						</li></ul>
				</div>
			</nav>
			<nav class="row nav">
				<div>
					<ul class="flat">
						
						<li>
							<a href="/">Blog</a>
						</li>
						
						<li>
							<a href="/projects/">Projects</a>
						</li>
						
						<li>
							<a href="/conferences/">Conferences</a>
						</li>
						
						<li>
							<a href="/podcasts/">Podcasts</a>
						</li>
						
						<li>
							<a href="/about/">About</a>
						</li>
						
					</ul>
				</div>
				<div class="pull-right">
					<div class="club">
						<form id="myFormMobile">
							<input type="text" id="inputSearchMobile" name="q" placeholder="Search..." onfocus="warmUp(this)">
							<button type="submit" id="buttonSubmitSearchMobile" style="line-height: normal;"><i id="iconSearchMobile" class="fa fa-search"></i></button>
						</form>
					</div>
				</div>
			</nav>
		</div>
	</div>
</div>

<script type="text/javascript">
	window.addEventListener( "load", function () {
		const urlParams = new URLSearchParams(window.location.search);

		


		const form = document.getElementById( "myForm" );

		form.addEventListener("submit", function (event) {
			event.preventDefault();
			sendData(new FormData(form));
		});

		const formMobile = document.getElementById( "myFormMobile" );

		formMobile.addEventListener("submit", function (event) {
			event.preventDefault();
			sendData(new FormData(formMobile));
		});
	});
</script>


		<div id = "main-content">
			<div class="post-header">
				<h1 class="title">Quarkus and Testcontainers</h1>
				<div class="meta">Posted at Nov 28, 2020</div>
			</div>

			<div class="markdown">
				<div class="paragraph">
<p>The <a href="https://www.testcontainers.org/">Testcontainers</a> project is invaluable for spinning up containerized resources during your (JUnit) tests,
e.g. databases or Kafka clusters.</p>
</div>
<div class="paragraph">
<p>For users of JUnit 5, the project provides the <a href="https://www.testcontainers.org/quickstart/junit_5_quickstart/"><code>@Testcontainers</code></a> extension, which controls the lifecycle of containers used by a test.
When testing a <a href="https://quarkus.io/">Quarkus</a> application though, this is at odds with Quarkus&#39; own <a href="https://quarkus.io/guides/getting-started-testing#recap-of-http-based-testing-in-jvm-mode"><code>@QuarkusTest</code></a> extension;
it’s a recommended <a href="https://bsideup.github.io/posts/testcontainers_fixed_ports/">best practice</a> to avoid fixed ports for any containers started by Testcontainers.
Instead, you should rely on Docker to automatically allocate random free ports.
This avoids conflicts between concurrently running tests,
e.g. amongst multiple Postgres containers,
started up by several parallel job runs in a CI environment, all trying to allocate Postgres&#39; default port 5432.
Obtaining the randomly assigned port and passing it into the Quarkus bootstrap process isn’t possible though when combining the two JUnit extensions.</p>
</div>
<div class="paragraph">
<p>One work-around you can find described <a href="https://stackoverflow.com/questions/61447252/integration-testing-with-testcontainers-quarkus-mongodb">e.g. on StackOverflow</a> is setting up the database container via a static class initializer block and then propagating the host and port to Quarkus through system properties.
While this works, it’s not ideal in terms of lifecycle control (e.g. how to make sure the container is started up once at the beginning of an entire test suite), and in general, it just feels a bit hack-ish.</p>
</div>
<div class="paragraph">
<p>Luckily, there’s a better alternative, which interestingly isn’t discussed as much:
using Quarkus&#39; notion of <em>test resources</em>.
There’s just two steps involved.
First, create an implementation of the <code>QuarkusTestResourceLifecycleManager</code> interface,
which controls your resource’s lifecycle.
In case of a Postgres database, this could look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PostgresResource</span> <span class="kd">implements</span>
        <span class="nc">QuarkusTestResourceLifecycleManager</span> <span class="o">{</span>

  <span class="kd">static</span> <span class="nc">PostgreSQLContainer</span><span class="o">&lt;?&gt;</span> <span class="n">db</span> <span class="o">=</span>
      <span class="k">new</span> <span class="nc">PostgreSQLContainer</span><span class="o">&lt;&gt;(</span><span class="s">&#34;postgres:13&#34;</span><span class="o">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="o">.</span><span class="na">withDatabaseName</span><span class="o">(</span><span class="s">&#34;tododb&#34;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withUsername</span><span class="o">(</span><span class="s">&#34;todouser&#34;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withPassword</span><span class="o">(</span><span class="s">&#34;todopw&#34;</span><span class="o">);</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="n">db</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="k">return</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonMap</span><span class="o">(</span>
        <span class="s">&#34;quarkus.datasource.url&#34;</span><span class="o">,</span> <span class="n">db</span><span class="o">.</span><span class="na">getJdbcUrl</span><span class="o">()</span>
    <span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">stop</span><span class="o">()</span> <span class="o">{</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="n">db</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configure the database container, using the Postgres 13 container image, the given database name, and credentials</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Start up the database; the returned map of configuration properties amends/overrides the configuration properties of the test; in this case the datasource URL will be overridden with the value obtained from Testcontainers, which contains the randomly allocated public port of the Postgres container</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Shut down the database after all tests have been executed</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>All you then need to do is to reference that test resource from your test class using the <code>@QuarkusTestResource</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@QuarkusTest</span>
<span class="nd">@QuarkusTestResource</span><span class="o">(</span><span class="nc">PostgresResource</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoResourceTest</span> <span class="o">{</span>

  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createTodoShouldYieldId</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">given</span><span class="o">()</span>
      <span class="o">.</span><span class="na">when</span><span class="o">()</span>
        <span class="o">.</span><span class="na">contentType</span><span class="o">(</span><span class="nc">ContentType</span><span class="o">.</span><span class="na">JSON</span><span class="o">)</span>
        <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="sh">&#34;&#34;&#34;
              {
                &#34;title&#34; : &#34;Learn Quarkus&#34;,
                &#34;priority&#34; : 1,
              }
              &#34;&#34;&#34;</span><span class="o">)</span>
      <span class="o">.</span><span class="na">then</span><span class="o">()</span>
        <span class="o">.</span><span class="na">statusCode</span><span class="o">(</span><span class="mi">201</span><span class="o">)</span>
        <span class="o">.</span><span class="na">body</span><span class="o">(</span>
            <span class="n">matchesJson</span><span class="o">(</span>
              <span class="sh">&#34;&#34;&#34;
              {
                &#34;id&#34; : 1,
                &#34;title&#34; : &#34;Learn Quarkus&#34;,
                &#34;priority&#34; : 1,
                &#34;completed&#34; : false,
              }
              &#34;&#34;&#34;</span><span class="o">));</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Ensures the Postgres database is started up</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>And that’s it! Note that <em>all</em> the test resources of the test module are detected and started up,
before starting the first test.</p>
</div>
<div class="sect1">
<h2 id="_bonus_schema_creation">Bonus: Schema Creation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One other subtle issue is the creation of the database schema for the test.
E.g. for my <a href="https://github.com/gunnarmorling/jfr-custom-events/tree/master/example-service">Todo example application</a>, I’d like to use a schema named &#34;todo&#34; in the Postgres database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">create</span> <span class="k">schema</span> <span class="n">todo</span><span class="p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Quarkus supports <a href="https://quarkus.io/guides/hibernate-orm#quarkus-hibernate-orm_quarkus.hibernate-orm.sql-load-script">SQL load scripts</a> for executing SQL scripts when Hibernate ORM starts.
But this will be executed only <em>after</em> Hibernate ORM has set up all the database objects,
such as tables, sequences, indexes etc.
(I’m using the <code>drop-and-create</code> <a href="https://quarkus.io/guides/hibernate-orm#quarkus-hibernate-orm_quarkus.hibernate-orm.database.generation)">database generation</a> mode during testing).
This means that while a load script is great for inserting test data,
it’s executed too late for defining the actual database schema itself.</p>
</div>
<div class="paragraph">
<p>Luckily, most database container images themselves support the execution of load scripts right upon database start-up;
The Postgres image is no exception,
so it’s just a matter of exposing that script via Testcontainers.
All it needs for that is a bit of tweaking of the Quarkus test resource for Postgres:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">static</span> <span class="nc">PostgreSQLContainer</span><span class="o">&lt;?&gt;</span> <span class="n">db</span> <span class="o">=</span>
        <span class="k">new</span> <span class="nc">PostgreSQLContainer</span><span class="o">&lt;&gt;(</span><span class="s">&#34;postgres:13&#34;</span><span class="o">)</span>
    <span class="o">.</span><span class="na">withDatabaseName</span><span class="o">(</span><span class="s">&#34;tododb&#34;</span><span class="o">)</span>
    <span class="o">.</span><span class="na">withUsername</span><span class="o">(</span><span class="s">&#34;todouser&#34;</span><span class="o">)</span>
    <span class="o">.</span><span class="na">withPassword</span><span class="o">(</span><span class="s">&#34;todopw&#34;</span><span class="o">)</span>
    <span class="o">.</span><span class="na">withClasspathResourceMapping</span><span class="o">(</span><span class="s">&#34;init.sql&#34;</span><span class="o">,</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="s">&#34;/docker-entrypoint-initdb.d/init.sql&#34;</span><span class="o">,</span>
        <span class="nc">BindMode</span><span class="o">.</span><span class="na">READ_ONLY</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Expose the file <em>src/main/resources/init.sql</em> as <em>/docker-entrypoint-initdb.d/init.sql</em> within the container</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>With that in place, Postgres will start up and the &#34;todo&#34; schema will be created in the database,
before Quarkus boots Hibernate ORM, which will populate the schema, and finally, all tests can run.</p>
</div>
<div class="paragraph">
<p>You can find the <a href="https://github.com/gunnarmorling/jfr-custom-events/blob/master/example-service/src/test/java/dev/morling/demos/quarkus/TodoResourceTest.java">complete source code</a> of this test and the Postgres test resource on GitHub.</p>
</div>
<div class="paragraph">
<p><em>Many thanks to <a href="https://twitter.com/bsideup">Sergei Egorov</a> for his feedback while writing this blog post!</em></p>
</div>
</div>
</div>
			</div>

			<div class="post-tags">
				
					
				
			</div>
		</div><div id="disqus_thread">
  <script src="https://giscus.app/client.js"
    data-repo="gunnarmorling/discussions.morling.dev"
    data-repo-id="R_kgDOGXzqNQ"
    data-category="Announcements"
    data-category-id="DIC_kwDOGXzqNc4B_2Pq"
    data-mapping="title"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-theme="light"
    data-lang="en"
    crossorigin="anonymous"
    async>
  </script>
</div>

<noscript>Please enable JavaScript, or join the <a href="https://github.com/gunnarmorling/discussions.morling.dev/discussions/">discussion on GitHub</a>.</noscript>
</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> © 2019 - 2024 Gunnar Morling |  Licensed Under <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons BY-SA 4.0</a></div>
	</nav>
</div><script>
	mediumZoom(document.querySelectorAll('div.imageblock > div.content > img'))
</script>

</body>
</html>
