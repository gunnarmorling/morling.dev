<!DOCTYPE html>
<html>
<head>
	
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-DD997656SV"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'G-DD997656SV');
	</script>

	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Introducing JmFrX: A Bridge From JMX to JDK Flight Recorder - Gunnar Morling</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Introducing JmFrX: A Bridge From JMX to JDK Flight Recorder" />
<meta property="og:description" content="
I’m excited to share the news about an open-source utility I’ve been working on lately:
JmFrX,
a tool for capturing JMX data with JDK Flight Recorder.


When using JMX (Java Management Extensions), The Java platform’s standard for monitoring and managing applications,
JmFrX allows you to periodically record the attributes from any JMX MBean into JDK Flight Recorder (JFR) files,
which you then can analyse using JDK Mission Control (JMC).
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.morling.dev/blog/introducing-jmfrx-a-bridge-from-jmx-to-jdk-flight-recorder/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2020-08-18T17:30:00+02:00" />
<meta property="article:modified_time" content="2020-08-18T17:30:00+02:00" />

<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Introducing JmFrX: A Bridge From JMX to JDK Flight Recorder"/>
<meta name="twitter:description" content="
I’m excited to share the news about an open-source utility I’ve been working on lately:
JmFrX,
a tool for capturing JMX data with JDK Flight Recorder.


When using JMX (Java Management Extensions), The Java platform’s standard for monitoring and managing applications,
JmFrX allows you to periodically record the attributes from any JMX MBean into JDK Flight Recorder (JFR) files,
which you then can analyse using JDK Mission Control (JMC).
"/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel="stylesheet" />
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" />
 
	<link rel="stylesheet" type="text/css" media="screen" href="https://www.morling.dev/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://www.morling.dev/css/main.css" />

	
	<link rel="stylesheet" type="text/css" href="https://www.morling.dev/css/base16.dark.css" />
	
	<link rel="stylesheet" type="text/css" href="https://www.morling.dev/css/morlingdev.css" />
	

	<script>
		const searchUrl = "https:\/\/search-morling-dev.onrender.com\/";
		const apiKey = "ff90d45f4afad3bd914c";
	</script>

	<script src="https://www.morling.dev//js/main.js"></script>
	<script src="https://www.morling.dev//js/medium-zoom.min.js"></script>

	<noscript>
		<style type="text/css">
			.club { display:none; }
		</style>
	</noscript>
</head>

<body>
	<div class="container wrapper post">
		<div class="header desktop">

	<div class="row">
		<div class="header-image-container">
			<img class="header-image" src="/images/gunnar_morling.jpg" alt="Gunnar Morling">
		</div>
		<div class="fill">
			<h1 class="site-title"><a href="https://www.morling.dev/">Gunnar Morling</a></h1>
			<div class="site-description"><h2>Random Musings on All Things Software Engineering</h2></div>

			<nav class="row pre-nav">
				<div class="pull-right">
					<ul class="flat"><li>
							<a href="/blog/index.xml" title="RSS FEED">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#rss"/>
								</svg>
							</a>
						</li><li>
							<a href="https://github.com/gunnarmorling" title="GitHub">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#github"/>
								</svg>
							</a>
						</li><li>
							<a href="https://bsky.app/profile/gunnarmorling.dev" title="Bluesky">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#cloud"/>
								</svg>
							</a>
						</li><li>
							<a href="https://twitter.com/gunnarmorling" title="Twitter">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#twitter"/>
								</svg>
							</a>
						</li><li>
							<a href="https://www.linkedin.com/in/gunnar-morling/" title="LinkedIn">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#linkedin"/>
								</svg>
							</a>
						</li><li>
							<a href="https://mastodon.online/@gunnarmorling" title="Mastodon">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#message-square"/>
								</svg>
							</a>
						</li></ul>
				</div>
			</nav>
			<nav class="row nav">
				<div>
					<ul class="flat">
						
						<li>
							<a href="/">Blog</a>
						</li>
						
						<li>
							<a href="/projects/">Projects</a>
						</li>
						
						<li>
							<a href="/conferences/">Conferences</a>
						</li>
						
						<li>
							<a href="/podcasts/">Podcasts</a>
						</li>
						
						<li>
							<a href="/about/">About</a>
						</li>
						
					</ul>
				</div>
				<div class="pull-right">
					<div class="club">
						<form id="myForm">
							<input type="text" id="inputSearch" name="q" placeholder="Search..." onfocus="warmUp(this)">
							<button type="submit" id="buttonSubmitSearch" style="line-height: normal;"><i id="iconSearch" class="fa fa-search"></i></button>
						</form>
					</div>
				</div>
			</nav>
		</div>
	</div>
</div>

<div class="header mobile">

	<div class="row">
		<div class="header-image-container">
			<img class="header-image" src="/images/gunnar_morling.jpg" alt="Gunnar Morling">
		</div>
		<div class="fill">
			<h1 class="site-title"><a href="https://www.morling.dev/">Gunnar Morling</a></h1>
			<div class="site-description"><h2>Random Musings on All Things Software Engineering</h2></div>
		</div>
	</div>
	<div>
		<div>
			<nav class="row pre-nav">
				<div class="pull-right">
					<ul class="flat"><li>
							<a href="/blog/index.xml" title="RSS FEED">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#rss"/>
								</svg>
							</a>
						</li><li>
							<a href="https://github.com/gunnarmorling" title="GitHub">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#github"/>
								</svg>
							</a>
						</li><li>
							<a href="https://bsky.app/profile/gunnarmorling.dev" title="Bluesky">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#cloud"/>
								</svg>
							</a>
						</li><li>
							<a href="https://twitter.com/gunnarmorling" title="Twitter">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#twitter"/>
								</svg>
							</a>
						</li><li>
							<a href="https://www.linkedin.com/in/gunnar-morling/" title="LinkedIn">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#linkedin"/>
								</svg>
							</a>
						</li><li>
							<a href="https://mastodon.online/@gunnarmorling" title="Mastodon">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#message-square"/>
								</svg>
							</a>
						</li></ul>
				</div>
			</nav>
			<nav class="row nav">
				<div>
					<ul class="flat">
						
						<li>
							<a href="/">Blog</a>
						</li>
						
						<li>
							<a href="/projects/">Projects</a>
						</li>
						
						<li>
							<a href="/conferences/">Conferences</a>
						</li>
						
						<li>
							<a href="/podcasts/">Podcasts</a>
						</li>
						
						<li>
							<a href="/about/">About</a>
						</li>
						
					</ul>
				</div>
				<div class="pull-right">
					<div class="club">
						<form id="myFormMobile">
							<input type="text" id="inputSearchMobile" name="q" placeholder="Search..." onfocus="warmUp(this)">
							<button type="submit" id="buttonSubmitSearchMobile" style="line-height: normal;"><i id="iconSearchMobile" class="fa fa-search"></i></button>
						</form>
					</div>
				</div>
			</nav>
		</div>
	</div>
</div>

<script type="text/javascript">
	window.addEventListener( "load", function () {
		const urlParams = new URLSearchParams(window.location.search);

		


		const form = document.getElementById( "myForm" );

		form.addEventListener("submit", function (event) {
			event.preventDefault();
			sendData(new FormData(form));
		});

		const formMobile = document.getElementById( "myFormMobile" );

		formMobile.addEventListener("submit", function (event) {
			event.preventDefault();
			sendData(new FormData(formMobile));
		});
	});
</script>


		<div id = "main-content">
			<div class="post-header">
				<h1 class="title">Introducing JmFrX: A Bridge From JMX to JDK Flight Recorder</h1>
				<div class="meta">Posted at Aug 18, 2020</div>
			</div>

			<div class="markdown">
				<div class="paragraph">
<p>I’m excited to share the news about an open-source utility I’ve been working on lately:
<a href="https://github.com/gunnarmorling/jmfrx">JmFrX</a>,
a tool for capturing JMX data with JDK Flight Recorder.</p>
</div>
<div class="paragraph">
<p>When using JMX (<a href="https://en.wikipedia.org/wiki/Java_Management_Extensions">Java Management Extensions</a>), The Java platform’s standard for monitoring and managing applications,
JmFrX allows you to periodically record the attributes from any JMX MBean into <a href="https://openjdk.java.net/jeps/328">JDK Flight Recorder</a> (JFR) files,
which you then can analyse using <a href="https://openjdk.java.net/projects/jmc/">JDK Mission Control</a> (JMC).</p>
</div>
<div class="paragraph">
<p>This is useful for a number of reasons:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You can track changes to the values of JMX MBean attributes over time without resorting to external monitoring tools</p>
</li>
<li>
<p>You can analyze JMX data from offline JFR recording files in cases where you cannot directly connect to the running application</p>
</li>
<li>
<p>You can export JMX data as live data streams using the JFR event streaming API introduced in Java 14</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this blog post I’m going to explain how to use JmFrX for recording JMX data in your applications,
point out some interesting JmFrX implemention details, and lastly will discuss some potential steps for future development of the tool.</p>
</div>
<div class="sect1">
<h2 id="_why_jmfrx">Why JmFrX?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://openjdk.java.net/jeps/328">JDK Flight Recorder</a> is a &#34;low-overhead data collection framework for troubleshooting Java applications and the HotSpot JVM&#34;.
In combination with the JDK Mission Control client application it allows to gain deep insights into the performance characteristics of Java applications.</p>
</div>
<div class="paragraph">
<p>In addition to the built-in metrics and event types, JFR also allows to define and emit <a href="/blog/rest-api-monitoring-with-custom-jdk-flight-recorder-events/">custom event types</a>.
JFR got open-sourced in JDK 11;
since then, developers in the Java eco-system began to support this,
enabling users to work with JFR and JMC for analyzing the runtime behavior of 3rd party libraries and frameworks.
For instance, JUnit 5.7 <a href="https://twitter.com/sormuras/status/1295052530238590978">produces JFR events</a> related to the execution lifecycle of unit tests.</p>
</div>
<div class="paragraph">
<p>At the same time,
many library authors are not (yet) in a position where they could easily emit JFR events from their tools,
as for instance they might wish to keep compatibility with older Java versions.
They might already expose JMX MBeans though which often provide fine-grained information about the execution state of Java applications.
This is where JmFrX comes in:
by periodically capturing the attribute values from a given set of JMX MBeans,
it allows to capture this information in JFR recordings.</p>
</div>
<div class="paragraph">
<p>JmFrX isn’t the first effort that seeks to bridge JMX and JFR;
JDK Mission Control project lead <a href="https://twitter.com/hirt/">Marcus Hirt</a> discusses a similar project in a <a href="http://hirt.se/blog/?p=689">blog post</a> in 2016.
But unlike the implementation described by Marcus in this post,
JmFrX is based on the public and supported APIs for defining, configuring and emitting JFR events, as available since OpenJDK 11.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_use_jmfrx">How To Use JmFrX</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to use JmFrX, make sure to run OpenJDK 11 or newer.
OpenJDK 8 also contains the open-sourced Flight Recorder bits as of release 8u262 (<a href="https://blog.adoptopenjdk.net/2020/07/adoptopenjdk-8u262-1108-and-1402-available/">from July this year</a>);
so this should work, too, but I haven’t tested it yet.</p>
</div>
<div class="paragraph">
<p>Until a stable release will be provided, you can obtain JmFrX snapshot builds via <a href="https://jitpack.io/">JitPack</a>.
For that, add the JitPack repository to your <em>pom.xml</em> when using Apache Maven
(or apply equivalent configuration for your preferred build tool):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml">...
<span class="nt">&lt;repositories&gt;</span>
  <span class="nt">&lt;repository&gt;</span>
    <span class="nt">&lt;id&gt;</span>jitpack.io<span class="nt">&lt;/id&gt;</span>
    <span class="nt">&lt;url&gt;</span>https://jitpack.io<span class="nt">&lt;/url&gt;</span>
  <span class="nt">&lt;/repository&gt;</span>
<span class="nt">&lt;/repositories&gt;</span>
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then add the JmFrX dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml">...
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.github.gunnarmorling<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>jmfrx<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>master-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next step is registering the JmFrX event type with JFR in the start-up routine of your program.
This could for instance be done in the <code>main()</code> method, the static initializer of a class loaded early on, an eagerly initialized Spring or CDI bean, etc.
A Java agent for this purpose will be provided as part of this project soon.</p>
</div>
<div class="paragraph">
<p>When building applications with <a href="https://quarkus.io/">Quarkus</a>, you could use an application start-up event like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@ApplicationScoped</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EventRegisterer</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerEvent</span><span class="o">(</span><span class="nd">@Observes</span> <span class="nc">StartupEvent</span> <span class="n">se</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Jmfrx</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">register</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">unregisterEvent</span><span class="o">(</span><span class="nd">@Observes</span> <span class="nc">ShutdownEvent</span> <span class="n">se</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Jmfrx</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">unregister</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now start your application and create a JFR configuration file which enables the JmFrX event type.
To do so, open JDK Mission Control, and choose your running application in the JVM Browser.
Then perform these steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Right-click the target JVM → Select <em>Start Flight Recording…​</em></p>
</li>
<li>
<p>Click on <em>Template Manager</em></p>
</li>
<li>
<p>Copy the <em>Continuous</em> setting and click <em>Edit</em> for modifying this copy</p>
</li>
<li>
<p>Expand the <em>JMX</em> and <em>JMX Dump</em> nodes</p>
</li>
<li>
<p>Make sure the <em>JMX Dump</em> event type is <em>Enabled</em>; choose a period for dumping the chosen JMX MBeans (by default 60 s) and specify the MBeans whose data should be captured; that’s done by means of a regular expression, which matches one or more JMX object names, for instance <code>.*OperatingSystem.*</code>:</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/jmfrx_mission_control_configuration.png" alt="Configuring JmFrX in JMC"/>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Close the two last dialogues by clicking <em>OK</em> and <em>OK</em></p>
</li>
<li>
<p>Important: Make sure that the template you edited is selected under <em>Event settings</em></p>
</li>
<li>
<p>Click <em>Finish</em> to begin the recording</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once the recording is complete, open the recording file in JDK Mission Control and go to the <em>Event Browser</em>.
You should see periodic events corresponding to the selected MBeans under the <em>JMX</em> node:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/jmfrx_events.png" alt="JmFrX Events in JDK Mission Control"/>
</div>
</div>
<div class="paragraph">
<p>When not using JDK Mission Control to initiate recordings, but the <a href="https://docs.oracle.com/en/java/javase/13/docs/specs/man/jcmd.html"><em>jcmd</em></a> utility on the command line,
also follow the same steps as above for creating a configuration as described above.
But then, instead of starting the recording, export the configuration file from the template manager and specify its name to <em>jcmd</em> via the <em>settings=/path/to/settings.jfc</em> parameter.</p>
</div>
<div class="paragraph">
<p>Now using JmFrX to observe JMX data from for the <code>java.lang</code> MBeans like <code>Runtime</code> and <code>OperatingSystem</code> in JFR isn’t too exciting yet,
as there’s dedicated JFR event types which contain most of that information.
But things get more interesting when capturing data from custom MBean types, as e.g. here for the stream threads metrics from a <a href="https://kafka.apache.org/26/documentation/streams/">Kafka Streams</a> application:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/jmfrx_kafka_streams.png" alt="JmFrX Events for Kafka Streams in JDK Mission Control"/>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_customizing_event_formats">Customizing Event Formats</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By default, JmFrX will propagate the raw attribute values from a JMX MBean to the corresponding JFR event.
This makes sure that all the information can be retrieved from recordings, but the data format can be a bit unwieldy, e.g. when it comes to data amounts in bytes, or time periods in milli-seconds since epoch.</p>
</div>
<div class="paragraph">
<p>To address this, JFR supports a range of metadata annotations such as <code>@DataAmount</code>, <code>@Timespan</code>, or <code>@Percentage</code>, which allow to format event attributes.
This information then is used by JMC for instance when displaying events in the browser (see event <em>Properties</em> to the left in the screenshot above).</p>
</div>
<div class="paragraph">
<p>JmFrX integrates with this metadata facility  via the notion of <em>event profiles</em>,
which describe the data format of one MBean type and its attributes.
When creating an event for a given JMX MBean, JmFrX will look for a corresponding event profile and apply its settings.
Event profiles are defined by implementing the <a href="https://github.com/gunnarmorling/jmfrx/blob/master/src/main/java/dev/morling/jmfrx/spi/EventProfileContributor.java"><code>EventProfileContributor</code></a> SPI.
As an example here’s a subset of the the built-in profile definition for the <code>OperatingSystem</code> MBean:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JavaLangEventProfileContributor</span> <span class="kd">implements</span>
    <span class="nc">EventProfileContributor</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">contributeProfiles</span><span class="o">(</span><span class="nc">EventProfileBuilder</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">addEventProfile</span><span class="o">(</span><span class="s">&#34;java.lang:type=OperatingSystem&#34;</span><span class="o">)</span>          <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="o">.</span><span class="na">addAttributeProfile</span><span class="o">(</span><span class="s">&#34;TotalSwapSpaceSize&#34;</span><span class="o">,</span> <span class="kt">long</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="k">new</span> <span class="nf">AnnotationElement</span><span class="o">(</span><span class="nc">DataAmount</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">DataAmount</span><span class="o">.</span><span class="na">BYTES</span><span class="o">),</span> <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">v</span><span class="o">)</span>
        <span class="o">.</span><span class="na">addAttributeProfile</span><span class="o">(</span><span class="s">&#34;FreeSwapSpaceSize&#34;</span><span class="o">,</span> <span class="kt">long</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="k">new</span> <span class="nf">AnnotationElement</span><span class="o">(</span><span class="nc">DataAmount</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">DataAmount</span><span class="o">.</span><span class="na">BYTES</span><span class="o">),</span>
            <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">v</span><span class="o">)</span>                                                    <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="o">.</span><span class="na">addAttributeProfile</span><span class="o">(</span><span class="s">&#34;CpuLoad&#34;</span><span class="o">,</span> <span class="kt">double</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="k">new</span> <span class="nf">AnnotationElement</span><span class="o">(</span><span class="nc">Percentage</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
            <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">v</span><span class="o">)</span>
        <span class="o">.</span><span class="na">addAttributeProfile</span><span class="o">(</span><span class="s">&#34;ProcessCpuLoad&#34;</span><span class="o">,</span> <span class="kt">double</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="k">new</span> <span class="nf">AnnotationElement</span><span class="o">(</span><span class="nc">Percentage</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">v</span><span class="o">)</span>
        <span class="o">.</span><span class="na">addAttributeProfile</span><span class="o">(</span><span class="s">&#34;SystemCpuLoad&#34;</span><span class="o">,</span> <span class="kt">double</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="k">new</span> <span class="nf">AnnotationElement</span><span class="o">(</span><span class="nc">Percentage</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">v</span><span class="o">)</span>
        <span class="o">.</span><span class="na">addAttributeProfile</span><span class="o">(</span><span class="s">&#34;ProcessCpuTime&#34;</span><span class="o">,</span> <span class="kt">long</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="k">new</span> <span class="nf">AnnotationElement</span><span class="o">(</span><span class="nc">Timespan</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">Timespan</span><span class="o">.</span><span class="na">NANOSECONDS</span><span class="o">),</span>
            <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">v</span> <span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Profiles are linked via the MBean name</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The atribute type is specified via an <code>AnnotationElement</code> for one of the JFR type metadata annotations</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>If needed, the actual value can be modified too, e.g. to convert it into another data type, or to shift its value into an expected range (for instance 0 to 1 for percentage values)</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Once you’ve defined the event profiles for your MBean type(s), don’t forget to register the contributor type either as a service implementation in your <em>module-info.java</em> descriptor (when building a modular Java application):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">module</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span> <span class="o">{</span>
    <span class="n">requires</span> <span class="n">jdk</span><span class="o">.</span><span class="na">jfr</span><span class="o">;</span>
    <span class="n">requires</span> <span class="n">dev</span><span class="o">.</span><span class="na">morling</span><span class="o">.</span><span class="na">jmfrx</span><span class="o">;</span>
    <span class="n">provides</span> <span class="n">dev</span><span class="o">.</span><span class="na">morling</span><span class="o">.</span><span class="na">jmfrx</span><span class="o">.</span><span class="na">spi</span><span class="o">.</span><span class="na">EventProfileContributor</span>
        <span class="n">with</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">MyEventProfileContributor</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When building an application using the traditional classpath, register the names of all profile contributors in the <em>META-INF/services/dev.morling.jmfrx.spi.EventProfileContributor</em> file.</p>
</div>
<div class="paragraph">
<p>There’s a small (yet hopefully growing) set of event profiles built into JmFrX.
But as event profile contributors are discovered using the Java <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/ServiceLoader.html">service loader</a> mechanism,
you can also easily plug in event profiles for other MBean types,
e.g. for the JMX MBeans of <a href="https://kafka.apache.org/documentation/#monitoring">Apache Kafka</a> or Kafka Connect, or application servers like <a href="https://docs.wildfly.org/20/Admin_Guide.html#JMX">WildFly</a>.</p>
</div>
<div class="paragraph">
<p>Also your pull requests for contributing event profiles for common JMX applications to JmFrX itself will be very welcomed!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_it_works">How It Works</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you solely want to use JmFrX, you can pretty much stop reading this post at this point.
But if you’re curious about how it is working internally, stay with me for a bit longer:
JmFrX uses two lesser known JFR features which also might be interesting for your own application-specific event types,
<em>periodic JFR events</em> and <em>dynamic event types</em>.</p>
</div>
<div class="paragraph">
<p>Unlike most JFR event types which are emitted when some specific JVM or application functionality is executed,
periodic events are produced in a regular interval.
The default interval (which can be overridden by the user) is specified using the <code>@Period</code> annotation on the event type definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Name</span><span class="o">(</span><span class="nc">JmxDumpEvent</span><span class="o">.</span><span class="na">NAME</span><span class="o">)</span>
<span class="nd">@Label</span><span class="o">(</span><span class="s">&#34;JMX Dump&#34;</span><span class="o">)</span>
<span class="nd">@Category</span><span class="o">(</span><span class="s">&#34;JMX&#34;</span><span class="o">)</span>
<span class="nd">@Description</span><span class="o">(</span><span class="s">&#34;Periodically dumps specific JMX MBeans&#34;</span><span class="o">)</span>
<span class="nd">@StackTrace</span><span class="o">(</span><span class="kc">false</span><span class="o">)</span>
<span class="nd">@Period</span><span class="o">(</span><span class="s">&#34;60 s&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JmxDumpEvent</span> <span class="kd">extends</span> <span class="nc">Event</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">NAME</span> <span class="o">=</span> <span class="s">&#34;dev.morling.jmfrx.JmxDumpEvent&#34;</span><span class="o">;</span>

  <span class="c1">// event implementation ...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Upon application start-up, JmFrX <a href="https://github.com/gunnarmorling/jmfrx/blob/master/src/main/java/dev/morling/jmfrx/Jmfrx.java#L74">registers</a> this event type with the JFR environment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="o">...</span>
<span class="kd">private</span> <span class="nc">Runnable</span> <span class="n">hook</span><span class="o">;</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">register</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">hook</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>                                             <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="nc">JmxDumpEvent</span> <span class="n">dumpEvent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JmxDumpEvent</span><span class="o">();</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">dumpEvent</span><span class="o">.</span><span class="na">isEnabled</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">dumpEvent</span><span class="o">.</span><span class="na">begin</span><span class="o">();</span>

    <span class="c1">// retrieve data from matching MBean(s) and create event(s) ...</span>

    <span class="n">dumpEvent</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
  <span class="o">};</span>

  <span class="nc">FlightRecorder</span><span class="o">.</span><span class="na">addPeriodicEvent</span><span class="o">(</span><span class="nc">JmxDumpEvent</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">hook</span><span class="o">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">unregister</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">FlightRecorder</span><span class="o">.</span><span class="na">removePeriodicEvent</span><span class="o">(</span><span class="n">hook</span><span class="o">);</span>                  <i class="conum" data-value="3"></i><b>(3)</b>
<span class="o">}</span>
<span class="o">...</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The event hook implementation</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Register the periodic event</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Unregister the periodic event</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The regular expression for specifying the MBean name(s) is passed to the event type as a <code>SettingControl</code>.
You can learn more about event settings in my post on <a href="/blog/rest-api-monitoring-with-custom-jdk-flight-recorder-events/#_event_settings">custom JFR event types</a>.</p>
</div>
<div class="paragraph">
<p>When the periodic event hook runs, it must create one event for each captured MBean.
As JmFrX cannot know which MBean(s) you’re interested in,
it’s not an option to pre-define these event types and their structure.</p>
</div>
<div class="paragraph">
<p>This is where dynamic JFR event types come in:
Using the <a href="https://docs.oracle.com/en/java/javase/11/docs/api/jdk.jfr/jdk/jfr/EventFactory.html"><code>EventFactory</code></a> class, event types can be defined at runtime.
Under the covers, JFR will create a corresponding <code>Event</code> sub-class dynamically using the ASM API.
Here’s the relevant JmFrX code which defines the event type for a given MBean:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="o">...</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="nc">EventDescriptor</span> <span class="nf">getDescriptorFor</span><span class="o">(</span><span class="nc">String</span> <span class="n">mBeanName</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">MBeanServer</span> <span class="n">mbeanServer</span> <span class="o">=</span> <span class="nc">ManagementFactory</span><span class="o">.</span><span class="na">getPlatformMBeanServer</span><span class="o">();</span>

  <span class="k">try</span> <span class="o">{</span>
    <span class="nc">ObjectName</span> <span class="n">objectName</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectName</span><span class="o">(</span><span class="n">mBeanName</span><span class="o">);</span>
    <span class="nc">MBeanInfo</span> <span class="n">mBeanInfo</span> <span class="o">=</span> <span class="n">mbeanServer</span><span class="o">.</span><span class="na">getMBeanInfo</span><span class="o">(</span><span class="n">objectName</span><span class="o">);</span>

    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">AnnotationElement</span><span class="o">&gt;</span> <span class="n">eventAnnotations</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="k">new</span> <span class="nf">AnnotationElement</span><span class="o">(</span><span class="nc">Category</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">getCategory</span><span class="o">(</span><span class="n">objectName</span><span class="o">)),</span>
        <span class="k">new</span> <span class="nf">AnnotationElement</span><span class="o">(</span><span class="nc">StackTrace</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">false</span><span class="o">),</span>
        <span class="k">new</span> <span class="nf">AnnotationElement</span><span class="o">(</span><span class="nc">Name</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">getName</span><span class="o">(</span><span class="n">objectName</span><span class="o">)),</span>
        <span class="k">new</span> <span class="nf">AnnotationElement</span><span class="o">(</span><span class="nc">Label</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">getLabel</span><span class="o">(</span><span class="n">objectName</span><span class="o">)),</span>
        <span class="k">new</span> <span class="nf">AnnotationElement</span><span class="o">(</span><span class="nc">Description</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>  <span class="n">mBeanInfo</span><span class="o">.</span><span class="na">getDescription</span><span class="o">())</span>
    <span class="o">);</span>

    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">AttributeDescriptor</span><span class="o">&gt;</span> <span class="n">fields</span> <span class="o">=</span> <span class="n">getFields</span><span class="o">(</span><span class="n">objectName</span><span class="o">,</span> <span class="n">mBeanInfo</span><span class="o">);</span>

    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ValueDescriptor</span><span class="o">&gt;</span> <span class="n">valueDescriptors</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">AttributeDescriptor:</span><span class="o">:</span><span class="n">getValueDescriptor</span><span class="o">)</span>
        <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nf">EventDescriptor</span><span class="o">(</span><span class="nc">EventFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">eventAnnotations</span><span class="o">,</span>
        <span class="n">valueDescriptors</span><span class="o">),</span> <span class="n">fields</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
<span class="o">...</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define event metadata like name, label, category etc. via the JFR metadata annotations</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>For each MBean attribute, an attribute is added to the event type; its definition is based on the information in the corresponding event profile, if present</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The actual implemention is slightly more complex, as it deals with integrating metadata from JmFrX event profiles and more.
You can find the complete code in the <a href="https://github.com/gunnarmorling/jmfrx/blob/master/src/main/java/dev/morling/jmfrx/internal/profile/EventProfile.java"><code>EventProfile</code></a> class.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_takeaways">Takeaways</h2>
<div class="sectionbody">
<div class="paragraph">
<p>JmFrX is a small utility which allows you to capture JMX data with JDK Flight Recorder.
It’s open-source (Apache License, version 2), you can find the <a href="https://github.com/gunnarmorling/jmfrx/">source code</a> on GitHub.
With the wide usage of JMX for application monitoring in the Java world, JmFrX can help to bring that information into JFR recordings,
making it available for offline investigations and analyses.</p>
</div>
<div class="paragraph">
<p>Potential next steps for JmFrX include more meaningful handling of tabular and composite JMX data,
adding a Java agent for registering the event type,
providing some more built-in event profiles and publishing a stable release on Maven Central.
Eventually, the JmFrX project might move over to the <a href="https://github.com/rh-jmc-team">rh-jmc-team</a> GitHub organization,
which is is managed by Red Hat’s OpenJDK team and contains many other very useful projects around JDK Flight Recorder and Mission Control.</p>
</div>
<div class="paragraph">
<p>Your feedback on and contributions to JmFrX will be very welcomed!</p>
</div>
</div>
</div>
			</div>

			<div class="post-tags">
				
					
				
			</div>
		</div><div id="disqus_thread">
  <script src="https://giscus.app/client.js"
    data-repo="gunnarmorling/discussions.morling.dev"
    data-repo-id="R_kgDOGXzqNQ"
    data-category="Announcements"
    data-category-id="DIC_kwDOGXzqNc4B_2Pq"
    data-mapping="title"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-theme="light"
    data-lang="en"
    crossorigin="anonymous"
    async>
  </script>
</div>

<noscript>Please enable JavaScript, or join the <a href="https://github.com/gunnarmorling/discussions.morling.dev/discussions/">discussion on GitHub</a>.</noscript>
</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> © 2019 - 2024 Gunnar Morling |  Licensed Under <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons BY-SA 4.0</a></div>
	</nav>
</div><script>
	mediumZoom(document.querySelectorAll('div.imageblock > div.content > img'))
</script>

</body>
</html>
