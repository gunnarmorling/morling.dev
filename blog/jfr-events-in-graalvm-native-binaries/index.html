<!DOCTYPE html>
<html>
<head>
	
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-DD997656SV"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'G-DD997656SV');
	</script>

	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>JDK Flight Recorder Events in GraalVM Native Binaries - Gunnar Morling</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="JDK Flight Recorder Events in GraalVM Native Binaries" />
<meta property="og:description" content="
If you have followed this blog for a while,
you’ll know that I am a big fan of JDK Flight Recorder (JFR),
the low-overhead diagnostics and profiling framework built into the HotSpot Java virtual machine.
And indeed, until recently, this meant only HotSpot:
Folks compiling their Java applications into GraalVM native binaries could not benefit from all the JFR goodness so far.
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.morling.dev/blog/jfr-events-in-graalvm-native-binaries/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2021-11-12T18:30:00+01:00" />
<meta property="article:modified_time" content="2021-11-12T18:30:00+01:00" />

<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="JDK Flight Recorder Events in GraalVM Native Binaries"/>
<meta name="twitter:description" content="
If you have followed this blog for a while,
you’ll know that I am a big fan of JDK Flight Recorder (JFR),
the low-overhead diagnostics and profiling framework built into the HotSpot Java virtual machine.
And indeed, until recently, this meant only HotSpot:
Folks compiling their Java applications into GraalVM native binaries could not benefit from all the JFR goodness so far.
"/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel="stylesheet" />
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" />
 
	<link rel="stylesheet" type="text/css" media="screen" href="https://www.morling.dev/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://www.morling.dev/css/main.css" />

	
	<link rel="stylesheet" type="text/css" href="https://www.morling.dev/css/base16.dark.css" />
	
	<link rel="stylesheet" type="text/css" href="https://www.morling.dev/css/morlingdev.css" />
	

	<script>
		const searchUrl = "https:\/\/search-morling-dev.onrender.com\/";
		const apiKey = "ff90d45f4afad3bd914c";
	</script>

	<script src="https://www.morling.dev//js/main.js"></script>
	<script src="https://www.morling.dev//js/medium-zoom.min.js"></script>

	<noscript>
		<style type="text/css">
			.club { display:none; }
		</style>
	</noscript>
</head>

<body>
	<div class="container wrapper post">
		<div class="header desktop">

	<div class="row">
		<div class="header-image-container">
			<img class="header-image" src="/images/gunnar_morling.jpg" alt="Gunnar Morling">
		</div>
		<div class="fill">
			<h1 class="site-title"><a href="https://www.morling.dev/">Gunnar Morling</a></h1>
			<div class="site-description"><h2>Random Musings on All Things Software Engineering</h2></div>

			<nav class="row pre-nav">
				<div class="pull-right">
					<ul class="flat"><li>
							<a href="/blog/index.xml" title="RSS FEED">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#rss"/>
								</svg>
							</a>
						</li><li>
							<a href="https://github.com/gunnarmorling" title="GitHub">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#github"/>
								</svg>
							</a>
						</li><li>
							<a href="https://twitter.com/gunnarmorling" title="Twitter">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#twitter"/>
								</svg>
							</a>
						</li><li>
							<a href="https://www.linkedin.com/in/gunnar-morling-2b44b7229/" title="LinkedIn">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#linkedin"/>
								</svg>
							</a>
						</li><li>
							<a href="https://mastodon.online/@gunnarmorling" title="Mastodon">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#message-square"/>
								</svg>
							</a>
						</li></ul>
				</div>
			</nav>
			<nav class="row nav">
				<div>
					<ul class="flat">
						
						<li>
							<a href="/">Blog</a>
						</li>
						
						<li>
							<a href="/projects/">Projects</a>
						</li>
						
						<li>
							<a href="/conferences/">Conferences</a>
						</li>
						
						<li>
							<a href="/podcasts/">Podcasts</a>
						</li>
						
						<li>
							<a href="/about/">About</a>
						</li>
						
					</ul>
				</div>
				<div class="pull-right">
					<div class="club">
						<form id="myForm">
							<input type="text" id="inputSearch" name="q" placeholder="Search..." onfocus="warmUp(this)">
							<button type="submit" id="buttonSubmitSearch" style="line-height: normal;"><i id="iconSearch" class="fa fa-search"></i></button>
						</form>
					</div>
				</div>
			</nav>
		</div>
	</div>
</div>

<div class="header mobile">

	<div class="row">
		<div class="header-image-container">
			<img class="header-image" src="/images/gunnar_morling.jpg" alt="Gunnar Morling">
		</div>
		<div class="fill">
			<h1 class="site-title"><a href="https://www.morling.dev/">Gunnar Morling</a></h1>
			<div class="site-description"><h2>Random Musings on All Things Software Engineering</h2></div>
		</div>
	</div>
	<div>
		<div>
			<nav class="row pre-nav">
				<div class="pull-right">
					<ul class="flat"><li>
							<a href="/blog/index.xml" title="RSS FEED">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#rss"/>
								</svg>
							</a>
						</li><li>
							<a href="https://github.com/gunnarmorling" title="GitHub">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#github"/>
								</svg>
							</a>
						</li><li>
							<a href="https://twitter.com/gunnarmorling" title="Twitter">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#twitter"/>
								</svg>
							</a>
						</li><li>
							<a href="https://www.linkedin.com/in/gunnar-morling-2b44b7229/" title="LinkedIn">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#linkedin"/>
								</svg>
							</a>
						</li><li>
							<a href="https://mastodon.online/@gunnarmorling" title="Mastodon">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#message-square"/>
								</svg>
							</a>
						</li></ul>
				</div>
			</nav>
			<nav class="row nav">
				<div>
					<ul class="flat">
						
						<li>
							<a href="/">Blog</a>
						</li>
						
						<li>
							<a href="/projects/">Projects</a>
						</li>
						
						<li>
							<a href="/conferences/">Conferences</a>
						</li>
						
						<li>
							<a href="/podcasts/">Podcasts</a>
						</li>
						
						<li>
							<a href="/about/">About</a>
						</li>
						
					</ul>
				</div>
				<div class="pull-right">
					<div class="club">
						<form id="myFormMobile">
							<input type="text" id="inputSearchMobile" name="q" placeholder="Search..." onfocus="warmUp(this)">
							<button type="submit" id="buttonSubmitSearchMobile" style="line-height: normal;"><i id="iconSearchMobile" class="fa fa-search"></i></button>
						</form>
					</div>
				</div>
			</nav>
		</div>
	</div>
</div>

<script type="text/javascript">
	window.addEventListener( "load", function () {
		const urlParams = new URLSearchParams(window.location.search);

		


		const form = document.getElementById( "myForm" );

		form.addEventListener("submit", function (event) {
			event.preventDefault();
			sendData(new FormData(form));
		});

		const formMobile = document.getElementById( "myFormMobile" );

		formMobile.addEventListener("submit", function (event) {
			event.preventDefault();
			sendData(new FormData(formMobile));
		});
	});
</script>


		<div id = "main-content">
			<div class="post-header">
				<h1 class="title">JDK Flight Recorder Events in GraalVM Native Binaries</h1>
				<div class="meta">Posted at Nov 12, 2021</div>
			</div>

			<div class="markdown">
				<div class="paragraph">
<p>If you have followed this blog for a while,
you’ll know that I am a big fan of <a href="https://openjdk.java.net/jeps/328">JDK Flight Recorder</a> (JFR),
the low-overhead diagnostics and profiling framework built into the HotSpot Java virtual machine.
And indeed, until recently, this meant <em>only</em> HotSpot:
Folks compiling their Java applications into <a href="https://www.graalvm.org/reference-manual/native-image/">GraalVM native binaries</a> could not benefit from all the JFR goodness so far.</p>
</div>
<div class="paragraph">
<p>But luckily,
this situation <a href="https://medium.com/graalvm/graalvm-21-2-ee2cce3b57aa">has changed</a> with GraalVM 21.2:
Thanks to a collaboration of engineers from Red Hat and Oracle,
GraalVM native binaries now also support JDK Flight Recorder.
At this point, the JFR recording engine itself has been put in place,
there are not many event types actually emitted yet.
As Jie Kang wrote recently in <a href="https://developers.redhat.com/articles/2021/07/23/jdk-flight-recorder-support-graalvm-native-image-journey-so-far">a post</a> about this ongoing work,
this should change soon, though:</p>
</div>
<div class="quoteblock">
<blockquote>
The initial merge for JFR infrastructure is complete but there is a long road ahead before the system can provide a view into native executables produced by GraalVM that is similar to what is possible for HotSpot. Up next is the work to add events for garbage collection, threads, exceptions, and other useful locations in SubstrateVM.
</blockquote>
<div class="attribution">
— JDK Flight Recorder support for GraalVM Native Image: The journey so far
</div>
</div>
<div class="paragraph">
<p>What already <em>does</em> work is emitting custom JFR events from your application code.
So I took the Quarkus-based todo management application from my earlier post about <a href="https://www.morling.dev/blog/rest-api-monitoring-with-custom-jdk-flight-recorder-events/">monitoring REST APIs with JFR</a> and explored what it’d take to make it work as a native binary.
And what should I say, essentially things &#34;just worked ™️&#34;.
All I had to do, was the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use a current version of GraalVM (21.3 at the time of writing)</p>
</li>
<li>
<p>Upgrade Quarkus to the current version (2.4.2.Final, <a href="https://quarkus.io/blog/quarkus-2-4-2-final-released/">released just today</a>); with 2.2.3.Final, which I had been using before, I’d get an error at image build time about a modifier mismatch with a native method substituted by Quarkus</p>
</li>
<li>
<p>Enable GraalVM’s <code>AllowVMInspection</code> option when creating the native binary</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As per the <a href="https://www.graalvm.org/reference-manual/native-image/JFR/">GraalVM documentation</a>, the latter is required in order to use JFR events in native binaries.
Unfortunately, failing to do so will only be reported at application runtime with an exception like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
</pre></td><td class="code"><pre>2021-11-12 15:31:22,456 ERROR [io.qua.run.Application] (main) Failed to start application (with profile prod): java.lang.UnsatisfiedLinkError: jdk.jfr.internal.JVM.getHandler(Ljava/lang/Class;)Ljava/lang/Object; [symbol: Java_jdk_jfr_internal_JVM_getHandler or Java_jdk_jfr_internal_JVM_getHandler__Ljava_lang_Class_2]
	at com.oracle.svm.jni.access.JNINativeLinkage.getOrFindEntryPoint(JNINativeLinkage.java:153)
	at com.oracle.svm.jni.JNIGeneratedMethodSupport.nativeCallAddress(JNIGeneratedMethodSupport.java:57)
	at jdk.jfr.internal.JVM.getHandler(JVM.java)
	at jdk.jfr.internal.Utils.getHandler(Utils.java:448)
	at jdk.jfr.internal.MetadataRepository.getHandler(MetadataRepository.java:174)
	at jdk.jfr.internal.MetadataRepository.register(MetadataRepository.java:135)
	at jdk.jfr.internal.MetadataRepository.register(MetadataRepository.java:130)
	at jdk.jfr.FlightRecorder.register(FlightRecorder.java:136)
	at dev.morling.demos.jfr.Metrics.registerEvent(Metrics.java:27)
  ...
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is triggered by the application code registering the custom JFR event type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerEvent</span><span class="o">(</span><span class="nd">@Observes</span> <span class="nc">StartupEvent</span> <span class="n">se</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">FlightRecorder</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="nc">JaxRsInvocationEvent</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here I’d wish that either GraalVM’s <code>native-image</code> tool or Quarkus would tell me about this situation already upon build time,
in particular as the cause of that problem is not readily apparent from the exception above.
In any case,
the required fix is simple enough, all we need to do is to set the <a href="https://quarkus.io/guides/building-native-image#quarkus-native-pkg-native-config_quarkus.native.enable-vm-inspection"><code>quarkus.native.enable-vm-inspection</code></a> option in the <em>application.properties</em> file of the Quarkus application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
</pre></td><td class="code"><pre>quarkus.native.enable-vm-inspection=true
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>With that configuration in place, the application can be built as a native binary via <code>mvn clean verify -Pnative</code>.
Grab a coffee while the build is running (it takes about two minutes on my laptop),
and then you can start the resulting native binary with the following options for creating a JFR recording:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre>./target/flight-recorder-demo-1.0.0-SNAPSHOT-runner \
  -XX:+FlightRecorder \
  -XX:StartFlightRecording=&#34;filename=my-recording.jfr&#34;
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also configure <a href="https://www.graalvm.org/reference-manual/native-image/JFR/#configure-the-recording">some more</a> of the known JFR options,
such as maximum recording size and duration.
What is not possible at this point is starting recordings dynamically at runtime e.g. via <em>jcmd</em> or JDK Mission Control,
as the JMX-based infrastructure required for this isn’t present in native binaries
(I haven’t tried to do so programmatically from within the application itself, this may be supported already).
JFR Event Streaming (as introduced with <a href="https://openjdk.java.net/jeps/349">JEP 349</a> in Java 14) also doesn’t work yet.</p>
</div>
<div class="paragraph">
<p>After creating some todos in the web application,
we can open the JFR recording in <a href="https://openjdk.java.net/projects/jmc/">JDK Mission Control</a> and examine the JFR events emitted for each invocation of the REST API:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/jfr-events-in-native-graalvm-binary.png" alt="Custom JFR Events Emitted From a Native GraalVM Binary in JDK Mission Control"/>
</div>
</div>
<div class="paragraph">
<p>As you see, besides the custom REST invocation events and some system events representing environment variables and system properties,
the recording is rather empty.
Also note how the thread attribute of the custom event type isn’t populated.</p>
</div>
<div class="paragraph">
<p>I’ve updated the <a href="https://github.com/gunnarmorling/jfr-custom-events">jfr-custom-events</a> repository on GitHub,
so you can get started with your own explorations around JFR events in GraalVM native binaries easily.
Just make sure to have a current GraalVM and its <code>native-image</code> tool installed.
The initial <a href="https://github.com/oracle/graal/issues/3018">feature request</a> for adding JFR support to GraalVM native binaries provides some more background information.
You also can use JFR with the <a href="https://github.com/graalvm/mandrel">Mandrel</a> distribution of GraalVM.</p>
</div>
<div class="paragraph">
<p>To learn more about JFR in general, have a look at <a href="https://developers.redhat.com/blog/2020/08/25/get-started-with-jdk-flight-recorder-in-openjdk-8u">this post</a> by Mario Torre.
Finally, if you’d like to find out how to use JFR for identifying potential performance regressions in your Java applications,
check out <a href="https://www.p99conf.io/session/continuous-performance-regression-testing-with-jfrunit/">this talk</a> about <a href="https://github.com/moditect/jfrunit">JfrUnit</a> which I did at the P99Conf conference a few weeks ago.</p>
</div>
			</div>

			<div class="post-tags">
				
					
				
			</div>
		</div><div id="disqus_thread">
  <script src="https://giscus.app/client.js"
    data-repo="gunnarmorling/discussions.morling.dev"
    data-repo-id="R_kgDOGXzqNQ"
    data-category="Announcements"
    data-category-id="DIC_kwDOGXzqNc4B_2Pq"
    data-mapping="title"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-theme="light"
    data-lang="en"
    crossorigin="anonymous"
    async>
  </script>
</div>

<noscript>Please enable JavaScript, or join the <a href="https://github.com/gunnarmorling/discussions.morling.dev/discussions/">discussion on GitHub</a>.</noscript>
</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> © 2019 - 2024 Gunnar Morling |  Licensed Under <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons BY-SA 4.0</a></div>
	</nav>
</div><script>
	mediumZoom(document.querySelectorAll('div.imageblock > div.content > img'))
</script>

</body>
</html>
