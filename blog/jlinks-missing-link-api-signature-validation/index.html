<!DOCTYPE html>
<html>
<head>
	
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-DD997656SV"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'G-DD997656SV');
	</script>

	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>jlink&#39;s Missing Link: API Signature Validation - Gunnar Morling</title>
	<link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg" />
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
	<link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
	<link rel="shortcut icon" href="/favicon/favicon.ico" />

	<meta name="viewport" content="width=device-width, initial-scale=1">

	
	<link rel="preload" href="/fonts/raleway-v37-latin-200.woff2" as="font" type="font/woff2" crossorigin>
	<link rel="preload" href="/fonts/raleway-v37-latin-300.woff2" as="font" type="font/woff2" crossorigin>
	<link rel="preload" href="/fonts/raleway-v37-latin-regular.woff2" as="font" type="font/woff2" crossorigin>

	<link rel="preload" href="/fonts/lato-latin-400-normal.woff2" as="font" type="font/woff2" crossorigin>
	<link rel="preload" href="/fonts/lato-latin-400-italic.woff2" as="font" type="font/woff2" crossorigin>
	<link rel="preload" href="/fonts/lato-latin-700-normal.woff2" as="font" type="font/woff2" crossorigin>
	<link rel="preload" href="/fonts/lato-latin-700-italic.woff2" as="font" type="font/woff2" crossorigin>

	<link rel="preload" href="/fonts/lora-latin-400-normal.woff2" as="font" type="font/woff2" crossorigin>
	<link rel="preload" href="/fonts/lora-latin-400-italic.woff2" as="font" type="font/woff2" crossorigin>
	<link rel="preload" href="/fonts/lora-latin-700-normal.woff2" as="font" type="font/woff2" crossorigin>
	<link rel="preload" href="/fonts/lora-latin-700-italic.woff2" as="font" type="font/woff2" crossorigin><meta property="og:url" content="https://www.morling.dev/blog/jlinks-missing-link-api-signature-validation/">
  <meta property="og:site_name" content="Gunnar Morling">
  <meta property="og:title" content="jlink&#39;s Missing Link: API Signature Validation">
  <meta property="og:description" content=" Discussions around Java’s jlink tool typically center around savings in terms of (disk) space. Instead of shipping an entire JDK, a custom runtime image created with jlink contains only those JDK …">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="blog">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2020-12-28T12:20:00&#43;01:00">
    <meta property="article:modified_time" content="2020-12-28T12:20:00&#43;01:00">
<meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="jlink&#39;s Missing Link: API Signature Validation">
  <meta name="twitter:description" content=" Discussions around Java’s jlink tool typically center around savings in terms of (disk) space. Instead of shipping an entire JDK, a custom runtime image created with jlink contains only those JDK …">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="/css/normalize.min.efd5060e5dbdbc4655a896b01b99c2b759dc5710f5cfda5ed34c2259de325469.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="/css/main.min.7e747dab5a47b967474cfdc64085734aa21b459c2bc3519033238d0258bb7dcc.css" />

	
	<link rel="stylesheet" type="text/css" href="/css/base16.dark.min.c40398d5ec04ac387c57141dc29e820fc4012da1cf2af8235004fc9945fa76a8.css" />
	
	<link rel="stylesheet" type="text/css" href="/css/morlingdev.min.20888cb6b76ed17eb07628f659718d130e32ea466294927dc4dfb410a3e3f3ab.css" />
	

	<script>
		const searchUrl = "https:\/\/search-morling-dev.onrender.com\/";
		const apiKey = "ff90d45f4afad3bd914c";
	</script>
	<script src="/js/main.min.9ee619eea7f51473f4284ef86c76bdb1b0089e19781ca97275924edf53be5bd4.js"></script>
	<script src="https://www.morling.dev//js/medium-zoom.min.js"></script>

	<noscript>
		<style type="text/css">
			.club { display:none; }
		</style>
	</noscript>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<div class="header-image-container">
		<img class="header-image" src="/images/gunnar_morling.jpg" alt="Gunnar Morling">
	</div>
	<div class="header-title">
		<h1 class="site-title"><a href="https://www.morling.dev/">Gunnar Morling</a></h1>
		<div class="site-description"><h2>Random Musings on All Things Software Engineering</h2></div>
	</div>
	<div class="header-nav-wrapper">
		<nav class="row pre-nav">
			<div class="pull-right">
				<ul class="flat"><li>
						<a href="/blog/index.xml" title="RSS FEED">
							<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<use xlink:href="/svg/feather-sprite.svg#rss"/>
							</svg>
						</a>
					</li><li>
						<a href="https://github.com/gunnarmorling" title="GitHub">
							<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<use xlink:href="/svg/feather-sprite.svg#github"/>
							</svg>
						</a>
					</li><li>
						<a href="https://bsky.app/profile/gunnarmorling.dev" title="Bluesky">
							<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<use xlink:href="/svg/feather-sprite.svg#cloud"/>
							</svg>
						</a>
					</li><li>
						<a href="https://twitter.com/gunnarmorling" title="Twitter">
							<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<use xlink:href="/svg/feather-sprite.svg#twitter"/>
							</svg>
						</a>
					</li><li>
						<a href="https://www.linkedin.com/in/gunnar-morling/" title="LinkedIn">
							<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<use xlink:href="/svg/feather-sprite.svg#linkedin"/>
							</svg>
						</a>
					</li><li>
						<a href="https://mastodon.online/@gunnarmorling" title="Mastodon">
							<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<use xlink:href="/svg/feather-sprite.svg#message-square"/>
							</svg>
						</a>
					</li></ul>
			</div>
		</nav>
		<nav class="row nav">
			<div>
				<ul class="flat">
					
					<li>
						<a href="/blog">Blog</a>
					</li>
					
					<li>
						<a href="/projects/">Projects</a>
					</li>
					
					<li>
						<a href="/conferences/">Conferences</a>
					</li>
					
					<li>
						<a href="/podcasts/">Podcasts</a>
					</li>
					
					<li>
						<a href="/about/">About</a>
					</li>
					
				</ul>
			</div>
			<div class="pull-right">
				<div class="club">
					<form id="myForm">
						<input type="text" id="inputSearch" name="q" placeholder="Search..." onfocus="warmUp(this)">
						<button type="submit" id="buttonSubmitSearch" style="line-height: normal;"><i id="iconSearch" class="fa fa-search"></i></button>
					</form>
				</div>
			</div>
		</nav>
	</div>
</div>

<script type="text/javascript">
	window.addEventListener( "load", function () {
		const form = document.getElementById( "myForm" );

		form.addEventListener("submit", function (event) {
			event.preventDefault();
			sendData(new FormData(form));
		});
	});
</script>


		<div id = "main-content">
			<div class="post-header">
				<h1 class="title">jlink&#39;s Missing Link: API Signature Validation</h1>
				<div class="post-meta-line">
					<span class="meta">Posted at Dec 28, 2020</span>
					
					<span class="post-tags-inline">
						
						<a href="/tags/java">java</a>
						
						<a href="/tags/jlink">jlink</a>
						
						<a href="/tags/validation">validation</a>
						
					</span>
					
				</div>
			</div>

			<div class="post-content">
				<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_the_example">The Example</a></li>
<li><a href="#_the_api_signature_check_jlink_plug_in">The API Signature Check jlink Plug-in</a></li>
<li><a href="#_summary">Summary</a></li>
</ul>
</div>
<div class="paragraph">
<p>Discussions around Java’s <a href="https://openjdk.java.net/jeps/282">jlink</a> tool typically center around savings in terms of (disk) space.
Instead of shipping an entire JDK,
a custom runtime image created with jlink contains only those JDK modules which an application actually requires,
resulting in smaller distributables and <a href="blog/smaller-faster-starting-container-images-with-jlink-and-appcds/">container images</a>.</p>
</div>
<div class="paragraph">
<p>But the contribution of jlink — as a part of the Java module system at large — to the development of Java application’s is bigger than that:
with the notion of <em>link time</em> it defines an optional complement to the well known phases <em>compile time</em> and application <em>run-time</em>:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Link time is an opportunity to do whole-world optimizations that are otherwise difficult at compile time or costly at run-time. An example would be to optimize a computation when all its inputs become constant (i.e., not unknown). A follow-up optimization would be to remove code that is no longer reachable.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Other examples for link time optimizations are the <a href="https://www.amazon.de/gp/video/detail/B00NB9OXMI/ref=atv_hm_hom_1_c_85s8GL_4_1">removal of unnecessary classes and resources</a>,
the conversion of (XML-based) deployment descriptors into binary representations
(which will be more efficiently processable at run-time),
obfuscation, or the generation of annotation indexes.
It would also be very interesting to create <a href="blog/smaller-faster-starting-container-images-with-jlink-and-appcds/">AppCDS archives</a> for all the classes of a runtime image at link time and bake that archive into the image,
resulting in faster application start-up, without any further manual configuration needed.</p>
</div>
<div class="paragraph">
<p>While these use cases mostly relate to <em>optimization</em> of the runtime image in one way or another,
the link time phase also is beneficial for the <em>validation</em> of applications.
In the remainder of this post, I’d like to discuss how link time validation can be employed to ensure the consistency of API signatures within a modularized Java application.
This helps to avoid potential <code>NoSuchMethodError</code>s and related errors which would otherwise be raised by the JVM at application run-time,
stemming from the usage of incompatible module versions,
different from the ones used at compile time.</p>
</div>
<div class="sect1">
<h2 id="_the_example">The Example<a class="anchor" href="#_the_example"></a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>To make things more tangible, let’s look at an application made up of two modules, <em>customer</em> and <em>order</em>.
As always, the full source code is <a href="https://github.com/gunnarmorling/signature-check-jlink-plugin">available online</a>, for you to play with.
The <em>customer</em> module defines a service interface with the following signature:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CustomerService</span> <span class="o">{</span>
  <span class="kt">void</span> <span class="nf">incrementLoyaltyPoints</span><span class="o">(</span><span class="kt">long</span> <span class="n">customerId</span><span class="o">,</span> <span class="kt">long</span> <span class="n">orderValue</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>CustomerService</code> interface is part of the <em>customer</em> module’s public API and is invoked from within the <em>order</em> module like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderService</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">CustomerService</span> <span class="n">customerService</span> <span class="o">=</span> <span class="o">...;</span>
    <span class="n">customerService</span><span class="o">.</span><span class="na">incrementLoyaltyPoints</span><span class="o">(</span><span class="mi">123</span><span class="o">,</span> <span class="mi">4999</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let’s assume there’s a new version of the <em>customer</em> module;
the signature of the <code>incrementLoyaltyPoints()</code> method got slightly changed for the sake of a more expressive and type-safe API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre><span class="c1">// record CustomerId(long id) {}</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CustomerService</span> <span class="o">{</span>
  <span class="kt">void</span> <span class="nf">incrementLoyaltyPoints</span><span class="o">(</span><span class="nc">CustomerId</span> <span class="n">customerId</span><span class="o">,</span> <span class="kt">long</span> <span class="n">orderValue</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>We now create a custom runtime image for the application.
But we’re at the end of a tough week, so accidentally we add version 2 of the <em>customer</em> module and the unchanged <em>order</em> module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="nv">$ $JAVA_HOME</span>/bin/jlink <span class="se">\</span>
  <span class="nt">--module-path</span><span class="o">=</span>path/to/customer-2.0.0.jar:path/to/order-1.0.0.jar <span class="se">\</span>
  <span class="nt">--add-modules</span><span class="o">=</span>com.example.order <span class="se">\</span>
  <span class="nt">--output</span><span class="o">=</span>target/runtime-image
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that jlink won’t complain about this and create the runtime image.
When executing the application via the image we’re in for a bad surprise, though
(slightly modified for the sake of readability):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre><span class="nv">$ </span>./target/runtime-image/bin/java com.example.order.OrderService

Exception <span class="k">in </span>thread <span class="s2">&#34;main&#34;</span> java.lang.NoSuchMethodError:
  <span class="s1">&#39;void c.e.customer.CustomerService.incrementLoyaltyPoints(long, long)&#39;</span>
  at com.example.order@1.0.0/c.e.order.OrderService.main<span class="o">(</span>OrderService.java:5<span class="o">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>This might be surprising at first; while jlink and the module system in general put a strong emphasis on reliability and e.g. flag referenced yet missing modules, mismatching API signatures like this are not raised as an issue and will only show up as an error at application run-time.</p>
</div>
<div class="paragraph">
<p>Indeed, when I did a quick <a href="https://twitter.com/gunnarmorling/status/1343160176946376707">non-representative poll</a> about this on Twitter,
it turned out that more than 40% of participants were not aware of this pitfall:</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="https://twitter.com/gunnarmorling/status/1343160176946376707"><img src="/images/jlink_api_signature_verification_poll.png" alt="jlink api signature verification poll" width="500"/></a>
</div>
</div>
<div class="paragraph">
<p>Needless to say that it’d be much more desirable to spot this error already early on at link time,
before shipping the affected application to production, and suffering from all the negative consequences associated to that.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_api_signature_check_jlink_plug_in">The API Signature Check jlink Plug-in<a class="anchor" href="#_the_api_signature_check_jlink_plug_in"></a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>While jlink doesn’t detect this kind of API signature mismatch by itself,
it comes with a plug-in API, which allows to hook into and enrich the linking process.
By creating a custom jlink plug-in, we can implement the API signature check and fail the image creation process when detecting any invalid method references like the one above.</p>
</div>
<div class="paragraph">
<p>Unfortunately though, the plug-in mechanism isn’t an official, supported API at this point.
As a matter of fact, it is not even exported within jlink’s own <a href="https://docs.oracle.com/en/java/javase/15/docs/api/jdk.jlink/module-summary.html">module definition</a>.
With the right set of javac/java flags and the help of a small Java agent, it is possible though to compile custom plug-ins and have them picked up by jlink.
To learn more about the required sorcery, check out <a href="https://in.relation.to/2017/12/12/exploring-jlink-plugin-api-in-java-9/#trick-2-the-java-agent">this blog post</a> which I wrote a while ago over on the Hibernate team blog.</p>
</div>
<div class="paragraph">
<p>Let’s start with creating the basic structure of the plug-in implementation class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre><span class="kn">import</span> <span class="nn">jdk.tools.jlink.plugin.Plugin</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SignatureCheckPlugin</span> <span class="kd">implements</span> <span class="nc">Plugin</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="k">return</span> <span class="s">&#34;check-signatures&#34;</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Category</span> <span class="nf">getType</span><span class="o">()</span> <span class="o">{</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="k">return</span> <span class="nc">Category</span><span class="o">.</span><span class="na">VERIFIER</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getDescription</span><span class="o">()</span> <span class="o">{</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="k">return</span> <span class="s">&#34;Checks the API references amongst the modules of &#34;</span> <span class="o">+</span>
        <span class="s">&#34;an application for consistency&#34;</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Returns the name for the option to enable this plug-in when running the jlink command</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Returns the category of this plug-in, which impacts the ordering within the plug-in stack
(other types include <code>TRANSFORMER</code>, <code>FILTER</code>, etc.)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>A description which will be shown when listing all plug-ins</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>There are a few more optional methods which we could implement, e.g. if the plug-in had any parameters for controlling its behaviors,
or if we wanted it to be enabled by default.
But as that’s not the case for the plug-in at hand,
the only method that’s missing is <code>transform()</code>, which does the actual heavy-lifting of the plug-in’s work.</p>
</div>
<div class="paragraph">
<p>Now implementing the complete rule set of the JVM applied when loading and linking classes at run-time would be a somewhat daunting task.
As I am lazy and this is just meant to be a basic PoC,
I’m going to limit myself to the detection of mismatching signatures of invoked methods,
as shown in the <em>customer</em>/<em>order</em> example above.
The reason being that this task can be elegantly delegated to an existing tool
(I told you, I’m lazy): <a href="https://www.mojohaus.org/animal-sniffer/">Animal Sniffer</a>.</p>
</div>
<div class="paragraph">
<p>While typically used as build tool plug-in for verifying that classes built on a newer JDK version can also be executed with older Java versions
(and as such mostly obsoleted by the <a href="blog/bytebuffer-and-the-dreaded-nosuchmethoderror/">JDK’s --release option</a>),
Animal Sniffer also provides an API for creating and verifying custom signatures.
This comes in handy for our jlink plug-in implementation.</p>
</div>
<div class="paragraph">
<p>The general design of the <code>transform()</code> mechanism is that of a classic input-process-output pipeline.
The method receives a <code>ResourcePool</code> object, which allows to traverse and examine the set of resources going into the image, such as class files, resource bundles, or manifests.
A new resource pool is to be returned, which could contain exactly the same resources as the original one (as in our case);
but of course it could also contain less or newly generated resources, or modified ones:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
</pre></td><td class="code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">ResourcePool</span> <span class="nf">transform</span><span class="o">(</span><span class="nc">ResourcePool</span> <span class="n">in</span><span class="o">,</span> <span class="nc">ResourcePoolBuilder</span> <span class="n">out</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="n">signature</span> <span class="o">=</span> <span class="n">createSignature</span><span class="o">(</span><span class="n">in</span><span class="o">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="kt">boolean</span> <span class="n">broken</span> <span class="o">=</span> <span class="n">checkSignature</span><span class="o">(</span><span class="n">in</span><span class="o">,</span> <span class="n">signature</span><span class="o">);</span> <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="k">if</span> <span class="o">(</span><span class="n">broken</span><span class="o">)</span> <span class="o">{</span> <i class="conum" data-value="3"></i><b>(3)</b>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">PluginException</span><span class="o">(</span><span class="s">&#34;There are API signature &#34;</span> <span class="o">+</span>
          <span class="s">&#34;inconsistencies, please check the logs&#34;</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="k">catch</span><span class="o">(</span><span class="nc">PluginException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="k">catch</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="n">in</span><span class="o">.</span><span class="na">transformAndCopy</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="n">e</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span> <i class="conum" data-value="4"></i><b>(4)</b>

  <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>

<span class="cm">/**
 * Creates a signature for all classes in the resource pool.
 */</span>
<span class="kd">private</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">createSignature</span><span class="o">(</span><span class="nc">ResourcePool</span> <span class="n">in</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
  <span class="nc">ByteArrayOutputStream</span> <span class="n">signatureStream</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteArrayOutputStream</span><span class="o">();</span>

  <span class="kt">var</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StreamSignatureBuilder</span><span class="o">(</span><span class="n">signatureStream</span><span class="o">,</span>
      <span class="k">new</span> <span class="nf">PrintWriterLogger</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">));</span>

  <span class="n">in</span><span class="o">.</span><span class="na">entries</span><span class="o">()</span> <i class="conum" data-value="5"></i><b>(5)</b>
      <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="n">isClassFile</span><span class="o">(</span><span class="n">e</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isModuleInfo</span><span class="o">(</span><span class="n">e</span><span class="o">))</span>
      <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="n">builder</span><span class="o">.</span><span class="na">process</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">path</span><span class="o">(),</span> <span class="n">e</span><span class="o">.</span><span class="na">content</span><span class="o">()));</span>

  <span class="n">builder</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

  <span class="k">return</span> <span class="n">signatureStream</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>
<span class="o">}</span>

<span class="cm">/**
 * Checks all classes against the given signature.
 */</span>
<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">checkSignature</span><span class="o">(</span><span class="nc">ResourcePool</span> <span class="n">in</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">signature</span><span class="o">)</span>
    <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>

  <span class="kt">var</span> <span class="n">checker</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StreamSignatureChecker</span><span class="o">(</span>
      <span class="k">new</span> <span class="nf">ByteArrayInputStream</span><span class="o">(</span><span class="n">signature</span><span class="o">),</span>
      <span class="nc">Collections</span><span class="o">.&lt;</span><span class="nc">String</span><span class="o">&gt;</span><span class="n">emptySet</span><span class="o">(),</span>
      <span class="k">new</span> <span class="nf">PrintWriterLogger</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">)</span>
  <span class="o">);</span>

  <span class="n">checker</span><span class="o">.</span><span class="na">setSourcePath</span><span class="o">(</span><span class="nc">Collections</span><span class="o">.&lt;</span><span class="nc">File</span><span class="o">&gt;</span><span class="n">emptyList</span><span class="o">());</span>

  <span class="n">in</span><span class="o">.</span><span class="na">entries</span><span class="o">()</span> <i class="conum" data-value="6"></i><b>(6)</b>
      <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="n">isClassFile</span><span class="o">(</span><span class="n">e</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isModuleInfo</span><span class="o">(</span><span class="n">e</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isJdkClass</span><span class="o">(</span><span class="n">e</span><span class="o">))</span>
      <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="n">checker</span><span class="o">.</span><span class="na">process</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">path</span><span class="o">(),</span> <span class="n">e</span><span class="o">.</span><span class="na">content</span><span class="o">()));</span>

  <span class="k">return</span> <span class="n">checker</span><span class="o">.</span><span class="na">isSignatureBroken</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isJdkClass</span><span class="o">(</span><span class="nc">ResourcePoolEntry</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="na">path</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&#34;/java.&#34;</span><span class="o">)</span> <span class="o">||</span>
      <span class="n">e</span><span class="o">.</span><span class="na">path</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&#34;/javax.&#34;</span><span class="o">)</span> <span class="o">||</span>
      <span class="n">e</span><span class="o">.</span><span class="na">path</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&#34;/jdk.&#34;</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isModuleInfo</span><span class="o">(</span><span class="nc">ResourcePoolEntry</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="na">path</span><span class="o">().</span><span class="na">endsWith</span><span class="o">(</span><span class="s">&#34;module-info.class&#34;</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isClassFile</span><span class="o">(</span><span class="nc">ResourcePoolEntry</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="na">path</span><span class="o">().</span><span class="na">endsWith</span><span class="o">(</span><span class="s">&#34;class&#34;</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create an Animal Sniffer signature for all the APIs in modules added to the runtime image</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Verify all classes against that signature</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>If there’s a signature violation, fail the jlink execution by raising a <code>PluginException</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>All classes are passed on as-is</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Feed each class to Animal Sniffer’s signature builder for creating the signature;
non-class resources and module descriptors are ignored</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Verify each class against the signature; JDK classes can be skipped here, we assume there’s no inconsistencies amongst the JDK’s own modules</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The input resource pool is traversed twice:
first to create an Animal Sniffer signature of all the APIs,
then a second time to validate the image’s classes against that signature.</p>
</div>
<div class="paragraph">
<p>Let me re-iterate that this a very basic, PoC-level implementation of link time API signature validation.
A number of incompatibilities would not be detected by this, e.g. adding an abstract method to a superclass or interface, modifying the number and specification of the type parameters of a class,
and others.
The implementation could also be further optimized by validating only cross-module references.
Still, this implementation is good enough to demonstrate the general principle and advantages of link time API consistency validation.</p>
</div>
<div class="paragraph">
<p>With the implementation in place
(see the <a href="https://github.com/gunnarmorling/signature-check-jlink-plugin#build">README</a> in the PoC’s GitHub repository for details on building the project),
it’s time to invoke jlink again, this time activating the new plug-in.
Now, as mentioned before, the jlink plug-in API isn’t publicly exposed as of Java 15
(the current Java version at the point of writing),
which means we need to jump some hoops in order to enable the plug-in and expose it to the jlink tool itself.</p>
</div>
<div class="paragraph">
<p>In a nutshell, a Java agent can be used to bend the module configurations as needed.
Details can be found in <a href="https://in.relation.to/2017/12/12/exploring-jlink-plugin-api-in-java-9/#trick-2-the-java-agent">aforementioned post</a> on the Hibernate blog
(the agent’s source code is <a href="https://github.com/gunnarmorling/signature-check-jlink-plugin/blob/main/agent/src/main/java/dev/morling/jlink/plugins/sigcheck/agent/JLinkPluginRegistrationAgent.java">here</a>).
The required boiler plate can be nicely encapsulated within a shell function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="k">function </span>myjlink <span class="o">{</span> <span class="se">\</span>
  <span class="nv">$JAVA_HOME</span>/bin/jlink <span class="se">\</span>
    <span class="nt">-J-javaagent</span>:signature-check-jlink-plugin-registration-agent-1.0-SNAPSHOT.jar <span class="se">\</span>
    <span class="nt">-J--module-path</span><span class="o">=</span>signature-check-jlink-plugin-1.0-SNAPSHOT.jar:path/to/animal-sniffer-1.19.jar:path/to/asm-9.0.jar <span class="se">\</span>
    <span class="nt">-J--add-modules</span><span class="o">=</span>dev.morling.jlink.plugins.sigcheck <span class="s2">&#34;</span><span class="nv">$@</span><span class="s2">&#34;</span> <span class="se">\</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>All the <code>-J</code> options are VM options passed through to the jlink tool,
in order to register the required Java agent and add the plug-in module to jlink’s module path.
Instead of directly calling jlink binary itself,
this wrapper function can now be used to invoke jlink with the custom plug-in.
Let’s first take a look at the description in the plug-in list:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
</pre></td><td class="code"><pre><span class="nv">$ </span>myjlink <span class="nt">--list-plugins</span>

...
Plugin Name: check-signatures
Plugin Class: dev.morling.jlink.plugins.sigcheck.SignatureCheckPlugin
Plugin Module: dev.morling.jlink.plugins.sigcheck
Category: VERIFIER
Functional state: Functional.
Option: <span class="nt">--check-signatures</span>
Description: Checks the API references amongst the modules of an application <span class="k">for </span>consistency
...
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let’s try and create the runtime image with the mismatching <em>customer</em> and <em>order</em> modules again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
</pre></td><td class="code"><pre>myjlink <span class="nt">--module-path</span><span class="o">=</span>path/to/customer-2.0.0.jar:path/to/order-1.0.0.jar <span class="se">\</span>
  <span class="nt">--add-modules</span><span class="o">=</span>com.example.order <span class="se">\</span>
  <span class="nt">--output</span><span class="o">=</span>target/runtime-image <span class="se">\</span>
  <span class="nt">--check-signatures</span>

<span class="o">[</span>INFO] Wrote signatures <span class="k">for </span>6156 classes.
<span class="o">[</span>ERROR] /com.example.order/com/example/order/OrderService.class:5:
  Undefined reference: void com.example.customer.CustomerService
      .incrementLoyaltyPoints<span class="o">(</span>long, long<span class="o">)</span>
Error: Signature violations, check the logs
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà! The mismatching signature of the <code>incrementLoyaltyPoints()</code> method was spotted and the creation of the runtime image failed.
Now we could take action, examine our module path and make sure to feed correctly matching versions of the <em>customer</em> and <em>order</em> modules to the image creation process.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary">Summary<a class="anchor" href="#_summary"></a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <em>link time</em> phase — added to the Java platform as part of the module system in version 9, and positioned between the well-known <em>compile time</em> and <em>run-time</em> phases — opens up very interesting opportunities to apply whole-world optimizations and validations to Java applications.
One example is the checking the API definitions and usages across the different modules of a Java application for consistency.
By means of a custom plug-in for the jlink tool, this validation can happen at link time, allowing to detect any mismatches when assembling an application, so that this kind of error can be fixed early on, before it hits an integration test or even production environment.</p>
</div>
<div class="paragraph">
<p>This is particularly interesting when using the Java module system for building large, modular monolithic applications.
Unless you’re working with custom module layers — e.g. via the <a href="https://github.com/moditect/layrry">Layrry launcher</a> — only one version of a given module may be present on the module path.
If multiple modules of an application depend on different versions of a transitive dependency,
link time API signature validation can help to identify inconsistencies caused by converging to a single version of that dependency.</p>
</div>
<div class="paragraph">
<p>The approach can also help saving build time; when only modifying a single module of a larger modularized application,
instead of re-compiling everything from scratch, you could just re-build that single module.
Then, when re-creating the runtime image using this module and the other existing ones,
you would be sure that all module API signature definitions and usages still match.</p>
</div>
<div class="paragraph">
<p>The one caveat is the fact that the jlink plug-in API isn’t a public, supported API of the JDK yet.
I hope this is going to change some time soon, though.
E.g. the next planned LTS release, Java 17, would be a great opportunity for officially adding the ability to build and use custom jlink plug-ins.
This would open the road towards more wide-spread use of link time optimizations and validations,
beyond those provided by the JDK and the jlink tool itself.</p>
</div>
<div class="paragraph">
<p>Until then, you can explore this area starting from the source code of the <a href="https://github.com/gunnarmorling/signature-check-jlink-plugin">signature check plug-in</a> and its accompanying Java agent for enabling its usage with jlink.</p>
</div>
</div>
</div>
			</div>

			
			
			
			<div class="related-posts">
				<h3>Read Next</h3>
				<ul>
					
					<li><a href="/blog/smaller-faster-starting-container-images-with-jlink-and-appcds/">Smaller, Faster-starting Container Images With jlink and AppCDS</a> <span class="meta">Dec 13, 2020</span></li>
					
					<li><a href="/blog/enforcing-java-record-invariants-with-bean-validation/">Enforcing Java Record Invariants With Bean Validation</a> <span class="meta">Jan 20, 2020</span></li>
					
					<li><a href="/blog/bytebuffer-and-the-dreaded-nosuchmethoderror/">ByteBuffer and the Dreaded NoSuchMethodError</a> <span class="meta">Dec 21, 2020</span></li>
					
				</ul>
			</div>
			
			
		</div>

		<div class="post-footer">
			<div style="display: flex; align-items: center; gap: 1rem;">
				<div class="header-image-container" style="flex-shrink: 0;">
					<img class="footer-image" src="/images/gunnar_morling.jpg" alt="Gunnar Morling">
				</div>
				<p style="margin: 0;">Gunnar Morling is an open-source software engineer in the Java and data streaming space. He currently works as a Technologist for Confluent. In his past role at Decodable he focused on developer outreach and helped them build their stream processing platform based on Apache Flink. Prior to that, he spent ten years at Red Hat, where he led the Debezium project, a platform for change data capture.</p>
			</div>
		</div>

		
		
		<div class="post-discussions">
			<p>Comment below, or join the discussion on
			<a href="https://hn.algolia.com/?query=morling.dev/blog/jlinks-missing-link-api-signature-validation/">Hacker News</a>,
			<a href="https://lobste.rs/search?q=domain:morling.dev+title:%22jlink%27s%20Missing%20Link%3a%20API%20Signature%20Validation%22&what=stories">Lobsters</a>, and
			<a href="https://www.reddit.com/search/?q=url:morling.dev/blog/jlinks-missing-link-api-signature-validation/">Reddit</a>.
			</p>
		</div>
		<div id="disqus_thread"></div>

<script>
  
  window.addEventListener('load', function() {
    
    setTimeout(function() {
      const commentsContainer = document.getElementById('disqus_thread');
      const script = document.createElement('script');
      script.src = 'https://giscus.app/client.js';
      script.setAttribute('data-repo', 'gunnarmorling/discussions.morling.dev');
      script.setAttribute('data-repo-id', 'R_kgDOGXzqNQ');
      script.setAttribute('data-category', 'Announcements');
      script.setAttribute('data-category-id', 'DIC_kwDOGXzqNc4B_2Pq');
      script.setAttribute('data-mapping', 'title');
      script.setAttribute('data-reactions-enabled', '1');
      script.setAttribute('data-emit-metadata', '0');
      script.setAttribute('data-theme', 'light');
      script.setAttribute('data-lang', 'en');
      script.setAttribute('crossorigin', 'anonymous');
      script.async = true;
      commentsContainer.appendChild(script);
    }, 100);
  });
</script>

<noscript>Please enable JavaScript, or join the <a href="https://github.com/gunnarmorling/discussions.morling.dev/discussions/">discussion on GitHub</a>.</noscript>
</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> © 2019 - 2026 Gunnar Morling |  Licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons BY-SA 4.0</a> | <a href="/ai">How I use (and don't use) AI</a></div>
	</nav>
</div><script>
	mediumZoom(document.querySelectorAll('div.imageblock > div.content > img'))
</script>

</body>
</html>
