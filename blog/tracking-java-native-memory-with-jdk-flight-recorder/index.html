<!DOCTYPE html>
<html>
<head>
	
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-DD997656SV"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'G-DD997656SV');
	</script>

	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Tracking Java Native Memory With JDK Flight Recorder - Gunnar Morling</title>
	<link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg" />
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
	<link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
	<link rel="shortcut icon" href="/favicon/favicon.ico" />

	<meta name="viewport" content="width=device-width, initial-scale=1">

	
	<link rel="preload" href="/fonts/raleway-v37-latin-200.woff2" as="font" type="font/woff2" crossorigin>
	<link rel="preload" href="/fonts/raleway-v37-latin-300.woff2" as="font" type="font/woff2" crossorigin>
	<link rel="preload" href="/fonts/raleway-v37-latin-regular.woff2" as="font" type="font/woff2" crossorigin>

	<link rel="preload" href="/fonts/lato-latin-400-normal.woff2" as="font" type="font/woff2" crossorigin>
	<link rel="preload" href="/fonts/lato-latin-400-italic.woff2" as="font" type="font/woff2" crossorigin>
	<link rel="preload" href="/fonts/lato-latin-700-normal.woff2" as="font" type="font/woff2" crossorigin>
	<link rel="preload" href="/fonts/lato-latin-700-italic.woff2" as="font" type="font/woff2" crossorigin>

	<link rel="preload" href="/fonts/lora-latin-400-normal.woff2" as="font" type="font/woff2" crossorigin>
	<link rel="preload" href="/fonts/lora-latin-400-italic.woff2" as="font" type="font/woff2" crossorigin>
	<link rel="preload" href="/fonts/lora-latin-700-normal.woff2" as="font" type="font/woff2" crossorigin>
	<link rel="preload" href="/fonts/lora-latin-700-italic.woff2" as="font" type="font/woff2" crossorigin><meta property="og:url" content="https://www.morling.dev/blog/tracking-java-native-memory-with-jdk-flight-recorder/">
  <meta property="og:site_name" content="Gunnar Morling">
  <meta property="og:title" content="Tracking Java Native Memory With JDK Flight Recorder">
  <meta property="og:description" content=" As regular readers of this blog will now, JDK Flight Recorder (JFR) is one of my favorite tools of the Java platform. This low-overhead event recording engine built into the JVM is invaluable for …">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="blog">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2023-12-17T19:29:00&#43;01:00">
    <meta property="article:modified_time" content="2023-12-17T19:29:00&#43;01:00">
<meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Tracking Java Native Memory With JDK Flight Recorder">
  <meta name="twitter:description" content=" As regular readers of this blog will now, JDK Flight Recorder (JFR) is one of my favorite tools of the Java platform. This low-overhead event recording engine built into the JVM is invaluable for …">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="/css/normalize.min.efd5060e5dbdbc4655a896b01b99c2b759dc5710f5cfda5ed34c2259de325469.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="/css/main.min.7e747dab5a47b967474cfdc64085734aa21b459c2bc3519033238d0258bb7dcc.css" />

	
	<link rel="stylesheet" type="text/css" href="/css/base16.dark.min.c40398d5ec04ac387c57141dc29e820fc4012da1cf2af8235004fc9945fa76a8.css" />
	
	<link rel="stylesheet" type="text/css" href="/css/morlingdev.min.ae2bbbf454bc066790c014bef9c196950a6951b8d8e272858a7fd87824e34923.css" />
	

	<script>
		const searchUrl = "https:\/\/search-morling-dev.onrender.com\/";
		const apiKey = "ff90d45f4afad3bd914c";
	</script>
	<script src="/js/main.min.9ee619eea7f51473f4284ef86c76bdb1b0089e19781ca97275924edf53be5bd4.js"></script>
	<script src="https://www.morling.dev//js/medium-zoom.min.js"></script>

	<noscript>
		<style type="text/css">
			.club { display:none; }
		</style>
	</noscript>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<div class="header-image-container">
		<img class="header-image" src="/images/gunnar_morling.jpg" alt="Gunnar Morling">
	</div>
	<div class="header-title">
		<h1 class="site-title"><a href="https://www.morling.dev/">Gunnar Morling</a></h1>
		<div class="site-description"><h2>Random Musings on All Things Software Engineering</h2></div>
	</div>
	<div class="header-nav-wrapper">
		<nav class="row pre-nav">
			<div class="pull-right">
				<ul class="flat"><li>
						<a href="/blog/index.xml" title="RSS FEED">
							<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<use xlink:href="/svg/feather-sprite.svg#rss"/>
							</svg>
						</a>
					</li><li>
						<a href="https://github.com/gunnarmorling" title="GitHub">
							<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<use xlink:href="/svg/feather-sprite.svg#github"/>
							</svg>
						</a>
					</li><li>
						<a href="https://bsky.app/profile/gunnarmorling.dev" title="Bluesky">
							<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<use xlink:href="/svg/feather-sprite.svg#cloud"/>
							</svg>
						</a>
					</li><li>
						<a href="https://twitter.com/gunnarmorling" title="Twitter">
							<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<use xlink:href="/svg/feather-sprite.svg#twitter"/>
							</svg>
						</a>
					</li><li>
						<a href="https://www.linkedin.com/in/gunnar-morling/" title="LinkedIn">
							<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<use xlink:href="/svg/feather-sprite.svg#linkedin"/>
							</svg>
						</a>
					</li><li>
						<a href="https://mastodon.online/@gunnarmorling" title="Mastodon">
							<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<use xlink:href="/svg/feather-sprite.svg#message-square"/>
							</svg>
						</a>
					</li></ul>
			</div>
		</nav>
		<nav class="row nav">
			<div>
				<ul class="flat">
					
					<li>
						<a href="/blog">Blog</a>
					</li>
					
					<li>
						<a href="/projects/">Projects</a>
					</li>
					
					<li>
						<a href="/conferences/">Conferences</a>
					</li>
					
					<li>
						<a href="/podcasts/">Podcasts</a>
					</li>
					
					<li>
						<a href="/about/">About</a>
					</li>
					
				</ul>
			</div>
			<div class="pull-right">
				<div class="club">
					<form id="myForm">
						<input type="text" id="inputSearch" name="q" placeholder="Search..." onfocus="warmUp(this)">
						<button type="submit" id="buttonSubmitSearch" style="line-height: normal;"><i id="iconSearch" class="fa fa-search"></i></button>
					</form>
				</div>
			</div>
		</nav>
	</div>
</div>

<script type="text/javascript">
	window.addEventListener( "load", function () {
		const form = document.getElementById( "myForm" );

		form.addEventListener("submit", function (event) {
			event.preventDefault();
			sendData(new FormData(form));
		});
	});
</script>


		<div id = "main-content">
			<div class="post-header">
				<h1 class="title">Tracking Java Native Memory With JDK Flight Recorder</h1>
				<div class="post-meta-line">
					<span class="meta">Posted at Dec 17, 2023</span>
					
					<span class="post-tags-inline">
						
						<a href="/tags/java">java</a>
						
						<a href="/tags/jfr">jfr</a>
						
						<a href="/tags/performance">performance</a>
						
						<a href="/tags/monitoring">monitoring</a>
						
					</span>
					
				</div>
			</div>

			<div class="post-content">
				<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_an_example">An Example</a></li>
<li><a href="#_tracking_rss">Tracking RSS</a></li>
</ul>
</div>
<div class="paragraph">
<p>As regular readers of this blog will now, <a href="https://openjdk.org/jeps/328">JDK Flight Recorder</a> (JFR) is one of my favorite tools of the Java platform.
This low-overhead event recording engine built into the JVM is invaluable for observing the runtime characteristics of Java applications and identifying any potential performance issues.
JFR continues to become better and better with every new release,
with one recent addition being support for native memory tracking (NMT).</p>
</div>
<div class="paragraph">
<p><a href="https://docs.oracle.com/en/java/javase/21/vm/native-memory-tracking.html">NMT</a> by itself is not a new capability of the JVM:
it provides you with detailed insight into the memory consumption of your application,
which goes way beyond the well-known Java heap space.
NMT tells you how much memory the JVM uses for class metadata, thread stacks, the JIT compiler, garbage collection, memory-mapped files, and much more
(the one thing which NMT does not report, despite what the name might suggest, is any memory allocated by native libraries, for instance invoked via JNI).
To learn more about NMT, I highly recommend to read the excellent post <a href="https://blog.arkey.fr/2020/11/30/off-heap-reconnaissance/">Off-Heap memory reconnaissance</a> by Brice Dutheil.</p>
</div>
<div class="paragraph">
<p>Until recently, in order to access NMT,
you’d have to use the <a href="https://docs.oracle.com/en/java/javase/21/docs/specs/man/jcmd.html"><em>jcmd</em></a> command line tool for capturing the values of a running JVM in an ad-hoc way.
Whereas since Java 20,
you can record NMT data continuously with JFR,
thanks to two new JFR event types added for this purpose.
This makes it much easier to collect that data over a longer period of time and analyze it in a systematic way.
You could also expose a live stream of NMT data to remote clients via <a href="https://openjdk.org/jeps/349">JFR event streaming</a>,
for instance for integration with dashboards and monitoring solutions.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The list of JFR event types grows with every release.
If you’d like to learn which event types are available in which Java version, take a look at the <a href="https://sap.github.io/SapMachine/jfrevents/">JFR Events</a> list compiled by <a href="https://twitter.com/parttimen3rd">Johannes Bechberger</a> from the <a href="https://sapmachine.io">Java team at SAP</a>.
It also shows you the events added in a particular version, for instance <a href="https://sap.github.io/SapMachine/jfrevents/21.html">here</a> for the new events in Java 21.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect1">
<h2 id="_an_example">An Example<a class="anchor" href="#_an_example"></a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>So let’s see how NMT data is reported via JFR.
Here’s a simple example program which allocates some off heap memory,
once using a good old <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/nio/ByteBuffer.html#direct-vs-non-direct-buffers-heading">direct byte buffer</a>,
and once using the new <a href="https://openjdk.org/jeps/454">Foreign Memory API</a>,
finalized in Java 22 with JEP 454
(it feels <em>so</em> nice to be able to allocate 4GB at once, something you couldn’t do before):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="code"><pre><span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.foreign.Arena</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.foreign.MemorySegment</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">time</span><span class="o">.</span><span class="na">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">;</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
  <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="no">STR</span><span class="o">.</span><span class="s">&#34;\{ now() } Started&#34;</span><span class="o">);</span>
  <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>

  <span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocateDirect</span><span class="o">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="o">);</span>
  <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="no">STR</span><span class="o">.</span><span class="s">&#34;\{ now() } Allocated (Direct)&#34;</span><span class="o">);</span>
  <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>

  <span class="k">try</span> <span class="o">(</span><span class="nc">Arena</span> <span class="n">arena</span> <span class="o">=</span> <span class="nc">Arena</span><span class="o">.</span><span class="na">ofConfined</span><span class="o">())</span> <span class="o">{</span>
    <span class="nc">MemorySegment</span> <span class="n">segment</span> <span class="o">=</span> <span class="n">arena</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">4L</span> <span class="o">*</span> <span class="mi">1024L</span> <span class="o">*</span> <span class="mi">1024L</span> <span class="o">*</span> <span class="mi">1024L</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="no">STR</span><span class="o">.</span><span class="s">&#34;\{ now() } Allocated (FMI)&#34;</span><span class="o">);</span>
    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="n">buffer</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
  <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="no">STR</span><span class="o">.</span><span class="s">&#34;\{ now() } Deallocated&#34;</span><span class="o">);</span>
  <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>JFR records NMT events every second by default,
so I’ve sprinkled in some <code>sleep()</code> calls to make sure the program runs long enough and the different allocations are spread out a bit.
Just for the fun of it, I’m also using a top-level main method—as supported by <a href="https://openjdk.org/jeps/463">JEP 463</a>—and string templates for the log messages (<a href="https://openjdk.org/jeps/459">JEP 459</a>).</p>
</div>
<div class="paragraph">
<p>Let’s run this and see how those off-heap allocations are tracked by JFR.
Somewhat surprisingly, NMT in JFR is controlled via the <code>gc</code> setting, which must be set to a value of &#34;normal&#34;, &#34;detailed&#34;, &#34;high&#34;, or &#34;all&#34; for recording NMT data.
This is the case for the <em>default</em> and <em>profile</em> JFR configurations which ship with the SDK,
so using either configuration will give you the NMT data.
Note though that in addition, NMT itself must be enabled using the <code>-XX:NativeMemoryTracking</code> JVM option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
</pre></td><td class="code"><pre>java <span class="nt">--enable-preview</span> <span class="nt">--source</span> 22 <span class="se">\</span>
  <span class="nt">-XX</span>:StartFlightRecording<span class="o">=</span><span class="nv">name</span><span class="o">=</span>Profiling,filename<span class="o">=</span>nmt-recording.jfr,settings<span class="o">=</span>profile <span class="se">\</span>
  <span class="nt">-XX</span>:NativeMemoryTracking<span class="o">=</span>detail main.java
<span class="o">[</span>0.316s][info][jfr,startup] Started recording 1. No limit specified, using <span class="nv">maxsize</span><span class="o">=</span>250MB as default.
<span class="o">[</span>0.316s][info][jfr,startup]
<span class="o">[</span>0.316s][info][jfr,startup] Use jcmd 47194 JFR.dump <span class="nv">name</span><span class="o">=</span>Profiling to copy recording data to file.
2023-12-17T18:31:00.475598 Started
2023-12-17T18:31:05.609319 Allocated <span class="o">(</span>Direct<span class="o">)</span>
2023-12-17T18:31:11.167484 Allocated <span class="o">(</span>FMI<span class="o">)</span>
2023-12-17T18:31:16.253059 Deallocated
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s open the recording in JDK Mission Control and see what we find.
As of version 8.3, JMC doesn’t have a bespoke view for displaying NMT data,
but the NMT events show up in the generic event browser view.
There are two event types, the first one being <a href="https://sap.github.io/SapMachine/jfrevents/#nativememoryusagetotal">&#34;Total Native Memory Usage&#34;</a>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/nmt_jfr_total.png" alt="nmt jfr total"/>
</div>
</div>
<div class="paragraph">
<p>The two off-heap allocations of 1 GB (direct byte buffer) and 4 GB (Foreign Memory API) show up as expected as increases to the reserved and committed memory of the program.
We also see one of the advantages of the new Foreign Memory API:
the memory is deallocated as soon as the <code>Arena</code> object is closed,
whereas the JVM holds on to the memory of the byte buffer also after discarding the reference.
There’s no control over when this memory will be released exactly,
it will be done via a <a href="https://stackoverflow.com/questions/36077641/java-when-does-direct-buffer-released">phantom-reference-based cleaner</a> some time after the GC has removed the associated buffer object.</p>
</div>
<div class="paragraph">
<p>The second new event type, <a href="https://sap.github.io/SapMachine/jfrevents/#nativememoryusage">&#34;Native Memory Usage Per Type&#34;</a>, provides a more fine grained view (when setting <code>-XX:NativeMemoryTracking</code> to <code>detail</code> rather than <code>summary</code>).
The off-heap allocations show up under the &#34;Other&#34; category there:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/nmt_jfr_per_type.png" alt="nmt jfr per type"/>
</div>
</div>
<div class="paragraph">
<p><em>Update Dec 18:</em> As OpenJDK developer Eric Gahlin <a href="https://twitter.com/ErikGahlin/status/1736530559231201484">pointed out</a>,
you also can take a high-level view at the NMT events of a recording using the JDK’s <em>jfr</em> tool,
which provides two <a href="https://egahlin.github.io/2023/05/30/views.html">built-in views</a> for committed and reserved memory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="code"><pre><span class="nv">$JAVA_HOME</span>/bin/jfr view native-memory-committed recording.jfr

                            Native Memory Committed

Memory Type                    First Observed   Average Last Observed   Maximum
<span class="nt">------------------------------</span> <span class="nt">--------------</span> <span class="nt">---------</span> <span class="nt">-------------</span> <span class="nt">---------</span>
Other                                  1,8 MB    1,7 GB        1,0 GB    5,0 GB
Java Heap                            136,0 MB  136,0 MB      136,0 MB  136,0 MB
GC                                    54,2 MB   54,2 MB       54,2 MB   54,2 MB
Metaspace                             16,0 MB   16,0 MB       16,1 MB   16,1 MB
Tracing                               15,6 MB   15,7 MB       15,7 MB   15,7 MB
Code                                  12,6 MB   12,6 MB       12,6 MB   12,6 MB
Shared class space                    12,4 MB   12,4 MB       12,4 MB   12,4 MB
Arena Chunk                            8,5 MB    2,2 MB        2,0 kB    8,5 MB
Symbol                                 5,8 MB    5,8 MB        5,8 MB    5,8 MB
Class                                  2,7 MB    2,7 MB        2,7 MB    2,7 MB
Native Memory Tracking                 1,7 MB    1,7 MB        1,7 MB    1,7 MB
Synchronization                        1,2 MB    1,2 MB        1,2 MB    1,2 MB
Internal                             563,4 kB  561,9 kB      561,7 kB  563,4 kB
Compiler                             202,9 kB  206,4 kB      205,6 kB  238,5 kB
Module                               174,1 kB  174,1 kB      174,1 kB  174,1 kB
Thread                                86,0 kB   82,5 kB       81,4 kB   86,0 kB
Safepoint                             32,0 kB   32,0 kB       32,0 kB   32,0 kB
GCCardSet                             29,5 kB   29,5 kB       29,5 kB   29,5 kB
Serviceability                        17,6 kB   17,6 kB       17,6 kB   17,6 kB
Object Monitors                        1,0 kB    1,0 kB        1,0 kB    1,0 kB
String Deduplication                608 bytes 608 bytes     608 bytes 608 bytes
Arguments                           185 bytes 185 bytes     185 bytes 185 bytes
Statistics                          128 bytes 128 bytes     128 bytes 128 bytes
Logging                              32 bytes  32 bytes      32 bytes  32 bytes
Test                                  0 bytes   0 bytes       0 bytes   0 bytes
JVMCI                                 0 bytes   0 bytes       0 bytes   0 bytes
Thread Stack                          0 bytes   0 bytes       0 bytes   0 bytes
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tracking_rss">Tracking RSS<a class="anchor" href="#_tracking_rss"></a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>As per the docs, NMT will cause a performance overhead of 5% - 10%
(how large the overhead actually is, <a href="https://stackoverflow.com/questions/73126185/what-is-overhead-of-java-native-memory-tracking-in-summary-mode/73167790">depends a lot</a> on the specific workload),
so it’s probably not something you’d want to do permanently in a production setting.
Luckily, Java 21 adds another JFR event type, <a href="https://sap.github.io/SapMachine/jfrevents/#residentsetsize">&#34;Resident Set Size&#34;</a> (RSS), which allows you to track the overall memory consumption of your application on an ongoing basis:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/nmt_jfr_rss.png" alt="nmt jfr rss"/>
</div>
</div>
<div class="paragraph">
<p>Of course you can retrieve the RSS, i.e. the physical memory allocated by a process, also using other tools like <code>ps</code>,
but recording it via JFR makes it really simple to analyze its development over time,
and also allows you to correlate it with other relevant JFR events, for instance for class (un-)loading or garbage collection.</p>
</div>
<div class="paragraph">
<p>With JFR event streaming, you could also expose a live feed of the value to remote monitoring clients,
allowing you to keep track visually using a dashboard.
But you also could apply some kind of pattern matching to this time series of values,
triggering an alert when it continues to grow also after the application’s warm-up phase.</p>
</div>
<div class="paragraph">
<p>I am planning to explore how to do this with a bit of SQL using <a href="https://github.com/moditect/jfr-analytics">JFR Analytics</a> in a future blog post.</p>
</div>
</div>
</div>
			</div>

			
			
			
			<div class="related-posts">
				<h3>Read Next</h3>
				<ul>
					
					<li><a href="/blog/finding-java-thread-leaks-with-jdk-flight-recorder-and-bit-of-sql/">Finding Java Thread Leaks With JDK Flight Recorder and a Bit Of SQL</a> <span class="meta">Feb 28, 2023</span></li>
					
					<li><a href="/blog/introducing-jfrunit-1-0-0-alpha1/">Introducing JfrUnit 1.0.0.Alpha1</a> <span class="meta">Aug 4, 2021</span></li>
					
					<li><a href="/blog/towards-continuous-performance-regression-testing/">Towards Continuous Performance Regression Testing</a> <span class="meta">Dec 16, 2020</span></li>
					
				</ul>
			</div>
			
			
		</div>

		<div class="post-footer">
			<div style="display: flex; align-items: center; gap: 1rem;">
				<div class="header-image-container" style="flex-shrink: 0;">
					<img class="footer-image" src="/images/gunnar_morling.jpg" alt="Gunnar Morling">
				</div>
				<p style="margin: 0;">Gunnar Morling is an open-source software engineer in the Java and data streaming space. He currently works as a Technologist for Confluent. In his past role at Decodable he focused on developer outreach and helped them build their stream processing platform based on Apache Flink. Prior to that, he spent ten years at Red Hat, where he led the Debezium project, a platform for change data capture.</p>
			</div>
		</div>

		
		
		<div class="post-discussions">
			<p>Comment below, or join the discussion on
			<a href="https://hn.algolia.com/?query=morling.dev/blog/tracking-java-native-memory-with-jdk-flight-recorder/">Hacker News</a>,
			<a href="https://lobste.rs/search?q=domain:morling.dev+title:%22Tracking%20Java%20Native%20Memory%20With%20JDK%20Flight%20Recorder%22&what=stories">Lobsters</a>, and
			<a href="https://www.reddit.com/search/?q=url:morling.dev/blog/tracking-java-native-memory-with-jdk-flight-recorder/">Reddit</a>.
			</p>
		</div>
		<div id="disqus_thread"></div>

<script>
  
  window.addEventListener('load', function() {
    
    setTimeout(function() {
      const commentsContainer = document.getElementById('disqus_thread');
      const script = document.createElement('script');
      script.src = 'https://giscus.app/client.js';
      script.setAttribute('data-repo', 'gunnarmorling/discussions.morling.dev');
      script.setAttribute('data-repo-id', 'R_kgDOGXzqNQ');
      script.setAttribute('data-category', 'Announcements');
      script.setAttribute('data-category-id', 'DIC_kwDOGXzqNc4B_2Pq');
      script.setAttribute('data-mapping', 'title');
      script.setAttribute('data-reactions-enabled', '1');
      script.setAttribute('data-emit-metadata', '0');
      script.setAttribute('data-theme', 'light');
      script.setAttribute('data-lang', 'en');
      script.setAttribute('crossorigin', 'anonymous');
      script.async = true;
      commentsContainer.appendChild(script);
    }, 100);
  });
</script>

<noscript>Please enable JavaScript, or join the <a href="https://github.com/gunnarmorling/discussions.morling.dev/discussions/">discussion on GitHub</a>.</noscript>
</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> © 2019 - 2026 Gunnar Morling |  Licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons BY-SA 4.0</a> | <a href="/ai">How I use (and don't use) AI</a></div>
	</nav>
</div><script>
	mediumZoom(document.querySelectorAll('div.imageblock > div.content > img'))
</script>

</body>
</html>
