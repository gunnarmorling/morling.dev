<!DOCTYPE html>
<html>
<head>
	
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-DD997656SV"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'G-DD997656SV');
	</script>

	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>How I Am Setting Up VMs On Hetzner Cloud - Gunnar Morling</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="How I Am Setting Up VMs On Hetzner Cloud" />
<meta property="og:description" content="
Whenever I’ve need a Linux box for some testing or experimentation,
or projects like the One Billion Row Challenge a few months back,
my go-to solution is Hetzner Online, a data center operator here in Europe.


Their prices for VMs are unbeatable, starting with 3,92 €/month for two shared vCPUs (either x64 or AArch64), four GB of RAM, and 20 TB of network traffic
(these are prices for their German data centers, they vary between regions).
four dedicated cores with 16 GB, e.g. for running a small web server, will cost you 28.55 €/month.
Getting a box with similar specs on AWS would set you back a multiple of that, with the (outbound) network cost being the largest chunk.
So it’s not a big surprise that more and more people realize the advantages of this offering,
most notably Ruby on Rails creator David Heinemeier Hansson,
who has been singing the praise for Hetzner’s dedicated servers, but also their VM instances, quite a bit on Twitter lately.
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.morling.dev/blog/how-i-am-setting-up-vms-on-hetzner-cloud/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2024-10-06T20:25:00+02:00" />
<meta property="article:modified_time" content="2024-10-06T20:25:00+02:00" />

<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="How I Am Setting Up VMs On Hetzner Cloud"/>
<meta name="twitter:description" content="
Whenever I’ve need a Linux box for some testing or experimentation,
or projects like the One Billion Row Challenge a few months back,
my go-to solution is Hetzner Online, a data center operator here in Europe.


Their prices for VMs are unbeatable, starting with 3,92 €/month for two shared vCPUs (either x64 or AArch64), four GB of RAM, and 20 TB of network traffic
(these are prices for their German data centers, they vary between regions).
four dedicated cores with 16 GB, e.g. for running a small web server, will cost you 28.55 €/month.
Getting a box with similar specs on AWS would set you back a multiple of that, with the (outbound) network cost being the largest chunk.
So it’s not a big surprise that more and more people realize the advantages of this offering,
most notably Ruby on Rails creator David Heinemeier Hansson,
who has been singing the praise for Hetzner’s dedicated servers, but also their VM instances, quite a bit on Twitter lately.
"/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel="stylesheet" />
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" />
 
	<link rel="stylesheet" type="text/css" media="screen" href="https://www.morling.dev/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://www.morling.dev/css/main.css" />

	
	<link rel="stylesheet" type="text/css" href="https://www.morling.dev/css/base16.dark.css" />
	
	<link rel="stylesheet" type="text/css" href="https://www.morling.dev/css/morlingdev.css" />
	

	<script>
		const searchUrl = "https:\/\/search-morling-dev.onrender.com\/";
		const apiKey = "ff90d45f4afad3bd914c";
	</script>

	<script src="https://www.morling.dev//js/main.js"></script>
	<script src="https://www.morling.dev//js/medium-zoom.min.js"></script>

	<noscript>
		<style type="text/css">
			.club { display:none; }
		</style>
	</noscript>
</head>

<body>
	<div class="container wrapper post">
		<div class="header desktop">

	<div class="row">
		<div class="header-image-container">
			<img class="header-image" src="/images/gunnar_morling.jpg" alt="Gunnar Morling">
		</div>
		<div class="fill">
			<h1 class="site-title"><a href="https://www.morling.dev/">Gunnar Morling</a></h1>
			<div class="site-description"><h2>Random Musings on All Things Software Engineering</h2></div>

			<nav class="row pre-nav">
				<div class="pull-right">
					<ul class="flat"><li>
							<a href="/blog/index.xml" title="RSS FEED">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#rss"/>
								</svg>
							</a>
						</li><li>
							<a href="https://github.com/gunnarmorling" title="GitHub">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#github"/>
								</svg>
							</a>
						</li><li>
							<a href="https://bsky.app/profile/gunnarmorling.dev" title="Bluesky">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#cloud"/>
								</svg>
							</a>
						</li><li>
							<a href="https://twitter.com/gunnarmorling" title="Twitter">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#twitter"/>
								</svg>
							</a>
						</li><li>
							<a href="https://www.linkedin.com/in/gunnar-morling/" title="LinkedIn">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#linkedin"/>
								</svg>
							</a>
						</li><li>
							<a href="https://mastodon.online/@gunnarmorling" title="Mastodon">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#message-square"/>
								</svg>
							</a>
						</li></ul>
				</div>
			</nav>
			<nav class="row nav">
				<div>
					<ul class="flat">
						
						<li>
							<a href="/">Blog</a>
						</li>
						
						<li>
							<a href="/projects/">Projects</a>
						</li>
						
						<li>
							<a href="/conferences/">Conferences</a>
						</li>
						
						<li>
							<a href="/podcasts/">Podcasts</a>
						</li>
						
						<li>
							<a href="/about/">About</a>
						</li>
						
					</ul>
				</div>
				<div class="pull-right">
					<div class="club">
						<form id="myForm">
							<input type="text" id="inputSearch" name="q" placeholder="Search..." onfocus="warmUp(this)">
							<button type="submit" id="buttonSubmitSearch" style="line-height: normal;"><i id="iconSearch" class="fa fa-search"></i></button>
						</form>
					</div>
				</div>
			</nav>
		</div>
	</div>
</div>

<div class="header mobile">

	<div class="row">
		<div class="header-image-container">
			<img class="header-image" src="/images/gunnar_morling.jpg" alt="Gunnar Morling">
		</div>
		<div class="fill">
			<h1 class="site-title"><a href="https://www.morling.dev/">Gunnar Morling</a></h1>
			<div class="site-description"><h2>Random Musings on All Things Software Engineering</h2></div>
		</div>
	</div>
	<div>
		<div>
			<nav class="row pre-nav">
				<div class="pull-right">
					<ul class="flat"><li>
							<a href="/blog/index.xml" title="RSS FEED">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#rss"/>
								</svg>
							</a>
						</li><li>
							<a href="https://github.com/gunnarmorling" title="GitHub">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#github"/>
								</svg>
							</a>
						</li><li>
							<a href="https://bsky.app/profile/gunnarmorling.dev" title="Bluesky">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#cloud"/>
								</svg>
							</a>
						</li><li>
							<a href="https://twitter.com/gunnarmorling" title="Twitter">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#twitter"/>
								</svg>
							</a>
						</li><li>
							<a href="https://www.linkedin.com/in/gunnar-morling/" title="LinkedIn">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#linkedin"/>
								</svg>
							</a>
						</li><li>
							<a href="https://mastodon.online/@gunnarmorling" title="Mastodon">
								<svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<use xlink:href="/svg/feather-sprite.svg#message-square"/>
								</svg>
							</a>
						</li></ul>
				</div>
			</nav>
			<nav class="row nav">
				<div>
					<ul class="flat">
						
						<li>
							<a href="/">Blog</a>
						</li>
						
						<li>
							<a href="/projects/">Projects</a>
						</li>
						
						<li>
							<a href="/conferences/">Conferences</a>
						</li>
						
						<li>
							<a href="/podcasts/">Podcasts</a>
						</li>
						
						<li>
							<a href="/about/">About</a>
						</li>
						
					</ul>
				</div>
				<div class="pull-right">
					<div class="club">
						<form id="myFormMobile">
							<input type="text" id="inputSearchMobile" name="q" placeholder="Search..." onfocus="warmUp(this)">
							<button type="submit" id="buttonSubmitSearchMobile" style="line-height: normal;"><i id="iconSearchMobile" class="fa fa-search"></i></button>
						</form>
					</div>
				</div>
			</nav>
		</div>
	</div>
</div>

<script type="text/javascript">
	window.addEventListener( "load", function () {
		const urlParams = new URLSearchParams(window.location.search);

		


		const form = document.getElementById( "myForm" );

		form.addEventListener("submit", function (event) {
			event.preventDefault();
			sendData(new FormData(form));
		});

		const formMobile = document.getElementById( "myFormMobile" );

		formMobile.addEventListener("submit", function (event) {
			event.preventDefault();
			sendData(new FormData(formMobile));
		});
	});
</script>


		<div id = "main-content">
			<div class="post-header">
				<h1 class="title">How I Am Setting Up VMs On Hetzner Cloud</h1>
				<div class="meta">Posted at Oct 6, 2024</div>
			</div>

			<div class="markdown">
				<div class="paragraph">
<p>Whenever I’ve need a Linux box for some testing or experimentation,
or projects like the <a href="/blog/1brc-results-are-in/">One Billion Row Challenge</a> a few months back,
my go-to solution is <a href="https://www.hetzner.com/">Hetzner Online</a>, a data center operator here in Europe.</p>
</div>
<div class="paragraph">
<p>Their prices for VMs are unbeatable, starting with 3,92 €/month for two shared vCPUs (either x64 or AArch64), four GB of RAM, and 20 TB of network traffic
(these are prices for their German data centers, they vary between regions).
four dedicated cores with 16 GB, e.g. for running a small web server, will cost you 28.55 €/month.
Getting a box with similar specs on AWS would set you back a multiple of that, with the (outbound) network cost being the largest chunk.
So it’s not a big surprise that more and more people realize the advantages of this offering,
most notably Ruby on Rails creator <a href="https://x.com/dhh/">David Heinemeier Hansson</a>,
who has been singing the praise for Hetzner’s dedicated servers, but also their VM instances, quite a bit on <a href="https://x.com/search?q=from%3Adhh%20hetzner&amp;src=typed_query&amp;f=live">Twitter</a> lately.</p>
</div>
<div class="paragraph">
<p>So I thought I’d share the automated process I’ve been using over the last few years for spinning up new boxes on Hetzner Cloud,
hoping it’s gonna be helpful to other folks out there eager to explore this world of cheap compute.
I’ve had that set-up in a <a href="https://github.com/gunnarmorling/cloud-boxes/">GitHub repo</a> for quite a while and meant to write about it,
with the recent attention on Hetzner being a nice motivator for finally doing so.
Note I am not affiliated with Hetzner in any way or form,
I just like their offering and think more people should be aware of it and benefit from it.</p>
</div>
<div class="sect1">
<h2 id="_creating_instances">Creating Instances</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To create new VMs, I am using <a href="https://www.terraform.io/">Terraform</a>, which shouldn’t be a big surprise.
The <a href="https://registry.terraform.io/providers/hetznercloud/hcloud/latest/docs">Hetzner Terraform provider</a> is very mature and reflects the latest product features pretty quickly,
as far as I can tell
(alternatively, there’s a <a href="https://github.com/hetznercloud/cli">CLI tool</a>, and of course an <a href="https://docs.hetzner.cloud/">API</a> as well).
Here’s my complete Terraform definition for launching one VM instance and a firewall to control access to it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="terraform"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
</pre></td><td class="code"><pre><span class="k">terraform</span> <span class="p">{</span>
  <span class="nx">required_providers</span> <span class="p">{</span>
    <span class="nx">hcloud</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">source</span>  <span class="o">=</span> <span class="s2">&#34;hetznercloud/hcloud&#34;</span>
      <span class="nx">version</span> <span class="o">=</span> <span class="s2">&#34;~&gt; 1.45&#34;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">variable</span> <span class="s2">&#34;hcloud_token&#34;</span> <span class="p">{</span>
  <span class="nx">sensitive</span> <span class="o">=</span> <span class="kc">true</span>
<span class="p">}</span>

<span class="k">variable</span> <span class="s2">&#34;firewall_source_ip&#34;</span> <span class="p">{</span>
  <span class="nx">default</span> <span class="o">=</span> <span class="s2">&#34;0.0.0.0&#34;</span>
<span class="p">}</span>

<span class="c1"># Configure the Hetzner Cloud Provider</span>
<span class="k">provider</span> <span class="s2">&#34;hcloud&#34;</span> <span class="p">{</span>
  <span class="nx">token</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="k">${</span><span class="kd">var</span><span class="p">.</span><span class="nx">hcloud_token</span><span class="k">}</span><span class="s2">&#34;</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">&#34;hcloud_firewall&#34;</span> <span class="s2">&#34;common-firewall&#34;</span> <span class="p">{</span> <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="nx">name</span> <span class="o">=</span> <span class="s2">&#34;common-firewall&#34;</span>

  <span class="nx">rule</span> <span class="p">{</span>
    <span class="nx">direction</span> <span class="o">=</span> <span class="s2">&#34;in&#34;</span>
    <span class="nx">protocol</span>  <span class="o">=</span> <span class="s2">&#34;tcp&#34;</span>
    <span class="nx">port</span>      <span class="o">=</span> <span class="s2">&#34;14625&#34;</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="nx">source_ips</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s2">&#34;</span><span class="k">${</span><span class="kd">var</span><span class="p">.</span><span class="nx">firewall_source_ip</span><span class="k">}</span><span class="s2">/32&#34;</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="p">]</span>
  <span class="p">}</span>

  <span class="nx">rule</span> <span class="p">{</span>
    <span class="nx">direction</span> <span class="o">=</span> <span class="s2">&#34;in&#34;</span>
    <span class="nx">protocol</span>  <span class="o">=</span> <span class="s2">&#34;icmp&#34;</span>
    <span class="nx">source_ips</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s2">&#34;</span><span class="k">${</span><span class="kd">var</span><span class="p">.</span><span class="nx">firewall_source_ip</span><span class="k">}</span><span class="s2">/32&#34;</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">&#34;hcloud_server&#34;</span> <span class="s2">&#34;control&#34;</span> <span class="p">{</span> <i class="conum" data-value="5"></i><b>(5)</b>
  <span class="nx">name</span>        <span class="o">=</span> <span class="s2">&#34;control&#34;</span>
  <span class="nx">image</span>       <span class="o">=</span> <span class="s2">&#34;fedora-40&#34;</span>
  <span class="nx">location</span>    <span class="o">=</span> <span class="s2">&#34;nbg1&#34;</span>
  <span class="nx">server_type</span> <span class="o">=</span> <span class="s2">&#34;cx22&#34;</span> <i class="conum" data-value="6"></i><b>(6)</b>
  <span class="nx">keep_disk</span>   <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">ssh_keys</span>    <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;some key&#34;</span><span class="p">]</span> <i class="conum" data-value="7"></i><b>(7)</b>
  <span class="nx">firewall_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nx">hcloud_firewall</span><span class="p">.</span><span class="nx">common-firewall</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
<span class="p">}</span>

<span class="k">output</span> <span class="s2">&#34;control_public_ip4&#34;</span> <span class="p">{</span>
  <span class="nx">value</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="k">${</span><span class="nx">hcloud_server</span><span class="p">.</span><span class="nx">control</span><span class="p">.</span><span class="nx">ipv4_address</span><span class="k">}</span><span class="s2">&#34;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="https://docs.hetzner.cloud/#authentication">Hetzner Cloud API token</a>, defined in <em>.tfvars</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Setting up a firewall for limiting access to the instance</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Using a random non-standard SSH port; take that, script kiddies! And no, this is not the one I am actually using</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>If I don’t need public access, allowing to connect only from my own local machine</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The VM to set up</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The instance size, in this case the smallest one they have with 2 vCPUs and 4 GB of RAM</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>SSH access key, to be set up in the web console before</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Bringing up the VM is as easy as running the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="nv">TF_VAR_firewall_source_ip</span><span class="o">=</span><span class="sb">`</span>dig +short txt ch whoami.cloudflare @1.0.0.1 | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">&#39;&#34;&#39;</span><span class="sb">`</span> terraform apply <span class="nt">-var-file</span><span class="o">=</span>.tfvars
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note how I am injecting my own public IP as a variable, allowing the firewall configuration to be trimmed down to grant access only from that IP.
That’s my standard set-up for test and dev boxes which don’t require public access.
After just a little bit, your new cloud VM will be up and running,
with Terraform reporting the IP address of the new box in its output.
The cool thing is that you can rescale this box later on as needed.
If you set <code>keep_disk</code> to <code>true</code> as above,
the box will keep its initial disk size, allowing you to scale back down later on, too.</p>
</div>
<div class="paragraph">
<p>So I’ll always start with the smallest configuration, which costs not even four Euros per month.
Then, when I am actually going to make use of the box for something which requires a bit more juice,
I’ll update the <code>server_type</code> line as needed, e.g. to &#34;ccx33&#34; for eight dedicated vCPUs and 32 GB of RAM.
This configuration would then cost 9,2 cents per hour, until I scale it back down again to cx22.
Rescaling just takes a minute or two and is done by re-running Terraform as shown above.
So it’s something which you can easily do whenever starting or stopping to work on some project.
Of course, this makes sense for ad-hoc usage scenarios like mine, not so much for more permanently running workloads.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuring_ssh">Configuring SSH</h2>
<div class="sectionbody">
<div class="paragraph">
<p>After the box has been set up via Terraform,
I am using <a href="https://github.com/ansible/ansible">Ansible</a> for provisioning, i.e. the installation of software
(yepp, my Red Hat past is shining through here).
That way, the process is fully automated, and I can set up and provision new machines with the same configuration with ease at any time.
My Ansible set-up is made up of two parts:
one for configuring SSH, one for installing whatever packages are needed.</p>
</div>
<div class="paragraph">
<p>Here’s the playbook for the SSH configuration,
applying some best practices such as enforcing key-based authentication and disabling remote root access:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
</pre></td><td class="code"><pre><span class="nn">---</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Create user</span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="na">hosts</span><span class="pi">:</span> <span class="s">all</span>
  <span class="na">remote_user</span><span class="pi">:</span> <span class="s">root</span>
  <span class="na">gather_facts</span><span class="pi">:</span> <span class="kc">false</span>

  <span class="na">vars_files</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">vars.yml</span>

  <span class="na">tasks</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">have {{ user }} user</span>
    <span class="na">user</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s2">&#34;</span><span class="s">{{</span><span class="nv"> </span><span class="s">user</span><span class="nv"> </span><span class="s">}}&#34;</span>
      <span class="na">shell</span><span class="pi">:</span> <span class="s">/bin/bash</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">add wheel group</span>
    <span class="na">group</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">wheel</span>
      <span class="na">state</span><span class="pi">:</span> <span class="s">present</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Allow wheel group to have passwordless sudo</span>
    <span class="na">lineinfile</span><span class="pi">:</span>
      <span class="na">dest</span><span class="pi">:</span> <span class="s">/etc/sudoers</span>
      <span class="na">state</span><span class="pi">:</span> <span class="s">present</span>
      <span class="na">regexp</span><span class="pi">:</span> <span class="s1">&#39;</span><span class="s">^%wheel&#39;</span>
      <span class="na">line</span><span class="pi">:</span> <span class="s1">&#39;</span><span class="s">%wheel</span><span class="nv"> </span><span class="s">ALL=(ALL)</span><span class="nv"> </span><span class="s">NOPASSWD:</span><span class="nv"> </span><span class="s">ALL&#39;</span>
      <span class="na">validate</span><span class="pi">:</span> <span class="s">visudo -cf %s</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">add user</span>
    <span class="na">user</span><span class="pi">:</span> <span class="s">name={{ user }} groups=wheel state=present append=yes</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Add authorized key</span>
    <span class="na">authorized_key</span><span class="pi">:</span>
      <span class="na">user</span><span class="pi">:</span> <span class="s2">&#34;</span><span class="s">{{</span><span class="nv"> </span><span class="s">user</span><span class="nv"> </span><span class="s">}}&#34;</span>
      <span class="na">state</span><span class="pi">:</span> <span class="s">present</span>
      <span class="na">key</span><span class="pi">:</span> <span class="s2">&#34;</span><span class="s">{{</span><span class="nv"> </span><span class="s">lookup(&#39;file&#39;,</span><span class="nv"> </span><span class="s">&#39;{{</span><span class="nv"> </span><span class="s">ssh_public_key_file</span><span class="nv"> </span><span class="s">}}&#39;)</span><span class="nv"> </span><span class="s">}}&#34;</span> <i class="conum" data-value="2"></i><b>(2)</b>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set up SSH</span> <i class="conum" data-value="3"></i><b>(3)</b>
  <span class="na">hosts</span><span class="pi">:</span> <span class="s">all</span>
  <span class="na">remote_user</span><span class="pi">:</span> <span class="s2">&#34;</span><span class="s">build&#34;</span>
  <span class="na">become</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">become_user</span><span class="pi">:</span> <span class="s">root</span>
  <span class="na">gather_facts</span><span class="pi">:</span> <span class="kc">false</span>

  <span class="na">vars_files</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">vars.yml</span>

  <span class="na">tasks</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Disable root login over SSH</span>
    <span class="na">lineinfile</span><span class="pi">:</span> <span class="s">dest=/etc/ssh/sshd_config regexp=&#34;^PermitRootLogin&#34; line=&#34;PermitRootLogin no&#34; state=present</span>
    <span class="na">notify</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">restart sshd</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Disable password login</span>
    <span class="na">lineinfile</span><span class="pi">:</span> <span class="s">dest=/etc/ssh/sshd_config regexp=&#34;^PasswordAuthentication&#34; line=&#34;PasswordAuthentication no&#34; state=present</span>
    <span class="na">notify</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">restart sshd</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Change SSH port</span>
    <span class="na">lineinfile</span><span class="pi">:</span> <span class="s">dest=/etc/ssh/sshd_config regexp=&#34;^#Port 22&#34; line=&#34;Port 14625&#34; state=present</span>
    <span class="na">notify</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">restart sshd</span>

  <span class="na">handlers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">restart sshd</span>
    <span class="na">service</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">sshd</span>
      <span class="na">state</span><span class="pi">:</span> <span class="s">restarted</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Adding a user &#34;build&#34; (name defined <em>vars.yml</em>) with sudo permissions</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The SSH key to add for the user</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Configuring SSH: disabling remote root login, disabling password login, and changing the SSH port to a non-standard value.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Before running Ansible, I need to put the IP reported by Terraform into the <em>hosts</em> file, along with the path of private and public SSH key:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="pi">[</span><span class="nv">hetzner</span><span class="pi">]</span>
<span class="s">&lt;IP of the box&gt;:14625 ansible_ssh_private_key_file=path/to/my-key ssh_public_key_file=/path/to/my-key.pub</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then this playbook can be run like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
</pre></td><td class="code"><pre>ansible-playbook <span class="nt">-i</span> hosts <span class="nt">--limit</span><span class="o">=</span>hetzner init-ssh.yml
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note this can be executed only exactly once.
Afterwards, the root user cannot connect anymore via SSH.
Purists out there might say that the non-standard SSH port smells a bit like security by obscurity,
and they wouldn’t be wrong.
But it does help to prevent lots of entries about failed log-in attempts in the log, as most folks just randomly looking for machines to hack won’t bother trying with ports other than 22.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_provisioning_software">Provisioning Software</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With the SSH configuration hardened a bit,
it’s time to install some software onto the machine.
What you’ll install depends on your specific requirements of course.
For my purposes, I have two roles for installing some commonly required things and Docker,
which both are incorporated via a playbook to be executed by the <code>build</code> user set up in the step before:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="nn">---</span>
<span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span> <span class="s">all</span>
  <span class="na">remote_user</span><span class="pi">:</span> <span class="s">build</span>
  <span class="na">roles</span><span class="pi">:</span>
     <span class="pi">-</span> <span class="s">base</span>
     <span class="pi">-</span> <span class="s">docker</span>

  <span class="na">vars_files</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">vars.yml</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here’s the <code>base</code> role’s task definitions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="code"><pre><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">upgrade all packages</span>
  <span class="na">become</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">become_user</span><span class="pi">:</span> <span class="s">root</span>
  <span class="na">dnf</span><span class="pi">:</span> <span class="s">name=&#34;*&#34; state=latest</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Have common tools</span>
  <span class="na">become</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">become_user</span><span class="pi">:</span> <span class="s">root</span>
  <span class="na">dnf</span><span class="pi">:</span> <span class="s">name={{item}} state=latest</span>
  <span class="na">with_items</span><span class="pi">:</span>
     <span class="pi">-</span> <span class="s">git</span>
     <span class="pi">-</span> <span class="s">wget</span>
     <span class="pi">-</span> <span class="s">the_silver_searcher</span>
     <span class="pi">-</span> <span class="s">htop</span>
     <span class="pi">-</span> <span class="s">acl</span>
     <span class="pi">-</span> <span class="s">dnf-plugins-core</span>
     <span class="pi">-</span> <span class="s">bash-completion</span>
     <span class="pi">-</span> <span class="s">jq</span>
     <span class="pi">-</span> <span class="s">gnupg</span>
     <span class="pi">-</span> <span class="s">haveged</span>
     <span class="pi">-</span> <span class="s">vim-enhanced</span>
     <span class="pi">-</span> <span class="s">entr</span>
     <span class="pi">-</span> <span class="s">zip</span>
     <span class="pi">-</span> <span class="s">fail2ban</span>
     <span class="pi">-</span> <span class="s">httpie</span>
     <span class="pi">-</span> <span class="s">hyperfine</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Have SDKMan</span>
  <span class="na">become</span><span class="pi">:</span> <span class="s">no</span>
  <span class="na">shell</span><span class="pi">:</span> <span class="s2">&#34;</span><span class="s">curl</span><span class="nv"> </span><span class="s">-s</span><span class="nv"> </span><span class="s">&#39;https://get.sdkman.io&#39;</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">bash&#34;</span>
  <span class="na">args</span><span class="pi">:</span>
    <span class="na">executable</span><span class="pi">:</span> <span class="s">/bin/bash</span>
    <span class="na">creates</span><span class="pi">:</span> <span class="s">/home/build/.sdkman/bin/sdkman-init.sh</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Have .bashrc</span>
  <span class="na">copy</span><span class="pi">:</span>
    <span class="na">src</span><span class="pi">:</span> <span class="s">user_bashrc</span>
    <span class="na">dest</span><span class="pi">:</span> <span class="s">/home/{{ user }}/.bashrc</span>
    <span class="na">mode</span><span class="pi">:</span> <span class="s">0644</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>I used to install Java via a separate role, allowing me to switch versions via <code>update-alternatives</code>,
but this became a bit of a hassle, so I am doing this via the amazing <a href="https://sdkman.io/">SDKMan</a> tool now.
Finally, for the sake of completeness, here are the tasks for installing Docker.
It’s a bit more complex than I’d like it to be,
due to the fact that a separate DNF repo must be configured first:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre></td><td class="code"><pre><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Have docker repo</span>
  <span class="na">become</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">become_user</span><span class="pi">:</span> <span class="s">root</span>
  <span class="na">shell</span><span class="pi">:</span>  <span class="s1">&#39;</span><span class="s">dnf</span><span class="nv"> </span><span class="s">config-manager</span><span class="nv"> </span><span class="s">\</span>
    <span class="s">--add-repo</span><span class="nv"> </span><span class="s">\</span>
    <span class="s">https://download.docker.com/linux/fedora/docker-ce.repo&#39;</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Have dnf cache updated</span>
  <span class="na">become</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">become_user</span><span class="pi">:</span> <span class="s">root</span>
  <span class="na">shell</span><span class="pi">:</span> <span class="s1">&#39;</span><span class="s">dnf</span><span class="nv"> </span><span class="s">makecache&#39;</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Have Docker</span>
  <span class="na">become</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">become_user</span><span class="pi">:</span> <span class="s">root</span>
  <span class="na">dnf</span><span class="pi">:</span> <span class="s">name={{item}} state=latest</span>
  <span class="na">with_items</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">docker-ce</span>
    <span class="pi">-</span> <span class="s">docker-ce-cli</span>
    <span class="pi">-</span> <span class="s">containerd.io</span>
    <span class="pi">-</span> <span class="s">docker-compose</span>
    <span class="pi">-</span> <span class="s">docker-buildx-plugin</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">add docker group</span>
  <span class="na">group</span><span class="pi">:</span> <span class="s">name=docker state=present</span>
  <span class="na">become</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">become_user</span><span class="pi">:</span> <span class="s">root</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Have /etc/docker</span>
  <span class="na">file</span><span class="pi">:</span> <span class="s">path=/etc/docker state=directory</span>
  <span class="na">become</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">become_user</span><span class="pi">:</span> <span class="s">root</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Have daemon.json</span>
  <span class="na">become</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">become_user</span><span class="pi">:</span> <span class="s">root</span>
  <span class="na">copy</span><span class="pi">:</span>
    <span class="na">src</span><span class="pi">:</span> <span class="s">docker_daemon.json</span>
    <span class="na">dest</span><span class="pi">:</span> <span class="s">/etc/docker/daemon.json</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Ensure Docker is started</span>
  <span class="na">become</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">become_user</span><span class="pi">:</span> <span class="s">root</span>
  <span class="na">systemd</span><span class="pi">:</span>
    <span class="na">state</span><span class="pi">:</span> <span class="s">started</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="s">yes</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">docker</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">add user</span>
  <span class="na">become</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">become_user</span><span class="pi">:</span> <span class="s">root</span>
  <span class="na">user</span><span class="pi">:</span> <span class="s">name={{ user}} groups=docker state=present append=yes</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_try_it_out_yourself">Try It Out Yourself</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Thanks to Terraform and Ansible,
spinning up a box for testing and development on Hetzner Cloud can be fully automated,
letting you go from zero to a running VM—​set up for safe SSH access, and provisioned with the software you need—​within a few minutes.
Once your VM is running, you can scale it up, and back down,
based on your specific workloads.
This allows you to stay on a really, really cheap configuration when you don’t actually need it, and then scale up and pay a bit more just for the hours you actually require the additional power.</p>
</div>
<div class="paragraph">
<p>You can find my complete Terraform and Ansible set-up for Hetzner Cloud in this <a href="https://github.com/gunnarmorling/cloud-boxes/">GitHub repository</a>.
Note this is purely a side project I am using for personal projects, such as ad-hoc experimentation with new Java versions.
I am not a Linux sysadmin by profession, so make sure to examine all the details and use it at your own risk.
In case you do want to run this on a publicly reachable box and not behind a firewall,
I recommend you install <a href="https://github.com/fail2ban/fail2ban">fail2ban</a> as an additional measure of caution.</p>
</div>
<div class="paragraph">
<p>If you have any suggestions for improving this set-up, in particular for further improving security,
please let me know in the comments below.</p>
</div>
</div>
</div>
			</div>

			<div class="post-tags">
				
					
				
			</div>
		</div><div id="disqus_thread">
  <script src="https://giscus.app/client.js"
    data-repo="gunnarmorling/discussions.morling.dev"
    data-repo-id="R_kgDOGXzqNQ"
    data-category="Announcements"
    data-category-id="DIC_kwDOGXzqNc4B_2Pq"
    data-mapping="title"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-theme="light"
    data-lang="en"
    crossorigin="anonymous"
    async>
  </script>
</div>

<noscript>Please enable JavaScript, or join the <a href="https://github.com/gunnarmorling/discussions.morling.dev/discussions/">discussion on GitHub</a>.</noscript>
</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> © 2019 - 2025 Gunnar Morling |  Licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons BY-SA 4.0</a> | <a href="/ai">How I use (and don't use) AI</a></div>
	</nav>
</div><script>
	mediumZoom(document.querySelectorAll('div.imageblock > div.content > img'))
</script>

</body>
</html>
